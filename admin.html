<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Portal - C2 Tennis Academy</title>

  <style>
    html, body { height: 100%; margin: 0; display: flex; flex-direction: column; font-family: Arial, sans-serif; }
    header, footer { background-color: #0c3c78; color: white; text-align: center; padding: 20px; }
    nav { background-color: #092e5e; display: flex; justify-content: center; }
    nav a { color: white; padding: 14px 20px; text-decoration: none; }
    nav a:hover { background-color: #0f4fa0; }
    section { flex: 1; padding: 40px 20px; max-width: 1400px; width: 90%; margin: auto; background: white; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    h2 { color: #0c3c78; }
    form { margin-top: 30px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .full-width { grid-column: 1 / -1; }
    label { display: block; font-weight: bold; color: #0c3c78; margin-bottom: 5px; }
    input, select, button { width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #ccc; box-sizing: border-box; }
    button { background-color: #0c3c78; color: white; cursor: pointer; grid-column: 1 / -1; margin-top: 20px; }
    button:hover { background-color: #0f4fa0; }
    #student-name-container { display: none; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { padding: 8px; border:1px solid #ddd; }
    thead th { background: #0c3c78; color: white; }
    .edit-coaches-btn { 
        background-color: #ffc107; /* Amber */
        color: black; 
        padding: 5px 10px; 
        border-radius: 4px; 
        border: 1px solid #e0a800; /* Darker amber */
        cursor: pointer; 
        font-size: 0.9em;
        margin-left: 5px; /* Space from delete button */
    }
    .edit-coaches-btn:hover { background-color: #e0a800; }

    /* Modal Styles */
    .modal {
      display: none; 
      position: fixed; 
      z-index: 1001; /* Sit on top */
      left: 0;
      top: 0;
      width: 100%; 
      height: 100%; 
      overflow: auto; 
      background-color: rgba(0,0,0,0.4); 
    }
    .modal-content {
      background-color: #fefefe;
      margin: 10% auto; 
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
      max-width: 500px;
      border-radius: 8px;
      box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2),0 6px 20px 0 rgba(0,0,0,0.19);
    }
    .modal-header {
      padding: 10px 16px;
      background-color: #0c3c78;
      color: white;
      border-top-left-radius: 8px;
      border-top-right-radius: 8px;
    }
    .modal-header h2 {
      margin: 0;
      color: white;
    }
    .modal-body { padding: 15px; }
    .modal-footer {
      padding: 10px 16px;
      text-align: right;
    }
    .modal-footer button {
      width: auto; /* Override default full-width for buttons in modal */
      padding: 8px 15px;
      margin-left: 10px;
    }
    .modal-footer button.cancel-btn {
      background-color: #ccc;
      color: black;
    }
    .modal-footer button.cancel-btn:hover {
      background-color: #bbb;
    }
    #coach-checkboxes-container label {
        display: block;
        margin-bottom: 8px;
        font-weight: normal; /* Normal weight for checkbox labels */
        color: #333; /* Darker text for readability */
    }
    #coach-checkboxes-container input[type="checkbox"] {
        width: auto; /* Let checkbox size normally */
        margin-right: 8px;
        vertical-align: middle;
    }
    .session-info p { margin: 5px 0; }
    .session-info strong { color: #0c3c78; }


/* === Global Header & Navigation Styles (Finalized Version) === */
     header {
       background-color: #0c3c78; 
       color: white; 
       padding: 30px 20px; 
       position: relative; 
       text-align: center; 
     }
     .header-content { 
       display: flex; justify-content: center; align-items: center; 
       max-width: 1200px; margin: 0 auto;
       position: relative; 
     }
     .site-title { text-align: center; } 
     .site-title h1 { 
       font-size: 2.2em;    
       margin-top: 0;
       margin-bottom: 0; /* Adjusted for portal pages with no subtitle */
       color: white; 
     } 
     .site-title p { 
       font-size: 1em;    
       margin-top: 0;
       margin-bottom: 0;
       color: #f0f0f0;
       /* display: none; /* Subtitle can be shown or hidden based on page */
     }
     
     .mobile-menu-toggle { display: none; background: none; border: none; color: white; font-size: 28px; cursor: pointer; padding: 5px; }
     nav.main-navigation { background-color: #092e5e; }
     .nav-wrapper-desktop { 
         display: flex; justify-content: center; align-items: center;
         width: 100%; max-width: 1200px; margin: 0 auto; padding: 0 20px; box-sizing: border-box;
     }
     ul.nav-links-desktop { list-style: none; margin: 0; padding: 0; display: flex; }
     ul.nav-links-desktop li a { color: white; padding: 14px 20px; text-decoration: none; display: block; } 
     ul.nav-links-desktop li a:hover { background-color: #0f4fa0; }
     ul.nav-links-desktop li a.highlighted-nav, ul.nav-links-desktop li a.current-page { 
        background-color: #d8f352; color: black; font-weight: bold; border-radius: 5px; 
     }
     ul.nav-links-desktop li a.highlighted-nav:hover, ul.nav-links-desktop li a.current-page:hover { background-color: #c1da3b; }
     
     .auth-buttons-desktop { 
       position: absolute;
       top: 20px; 
       right: 20px; 
       display: flex;
       align-items: center;
       gap: 15px; /* Added gap property */
     }
     .auth-buttons-desktop a button, .auth-buttons-desktop button {
       background-color: white; color: #0c3c78; border: none; padding: 10px 20px; 
       /* margin-left: 15px; */ /* Removed margin-left */
       border-radius: 5px; font-weight: bold; cursor: pointer;
       transition: all 0.3s ease; white-space: nowrap;
     }
     .auth-buttons-desktop a button:hover, .auth-buttons-desktop button:hover { background-color: #0f4fa0; color: white; }
     .mobile-menu-container {
       display: none; background-color: #092e5e; position: fixed;
       top: 0; left: 0; width: 100%; height: 100%;
       z-index: 1000; padding-top: 20px;
       box-sizing: border-box; overflow-y: auto; text-align: center;
     }
     nav.main-navigation.mobile-menu--open .mobile-menu-container { display: block; }
     .mobile-menu-close {
        display: block; 
        position: absolute; 
        top: 10px; /* Adjusted */
        right: 10px; /* Adjusted */
        left: auto; /* Explicitly set */
        bottom: auto; /* Explicitly set */
        background: none; 
        border: none; 
        color: white; 
        font-size: 28px; 
        cursor: pointer;
        z-index: 10; /* Optionally add a z-index */
     }
     ul.nav-links-mobile { list-style: none; padding: 0; margin: 50px 0 20px; }
     ul.nav-links-mobile li a {
       color: white; padding: 15px 20px; text-decoration: none; display: block;
       border-bottom: 1px solid #0c3c78;
     }
     ul.nav-links-mobile li:last-child a { border-bottom: none; }
     ul.nav-links-mobile li a:hover { background-color: #0f4fa0; }
     .auth-buttons-mobile { padding: 20px; }
     .auth-buttons-mobile a button, .auth-buttons-mobile button {
       background-color: #d8f352; color: #0c3c78; border: none; padding: 12px 20px;
       border-radius: 5px; font-weight: bold; cursor: pointer; display: block;
       width: 80%; max-width: 250px; margin: 10px auto; box-sizing: border-box;
     }
     .auth-buttons-mobile a button:hover, .auth-buttons-mobile button:hover { background-color: #c1da3b; }
     
     
     footer { /* Global footer style */
        background-color: #0c3c78; color: white; text-align: center; padding: 20px; margin-top:auto; /* Pushes to bottom in flex if body is flex column */
     }

     @media (max-width: 768px) {
       body { -webkit-text-size-adjust: 100%; -ms-text-size-adjust: 100%; } 
       header { padding: 10px 15px; } 
       .header-content {
         justify-content: space-between; 
         width:100%; 
       }
       .site-title { text-align: left; }
       .site-title h1 { font-size: 1.2em; margin-bottom: 0; }
       .site-title p { display: none; } 
       .mobile-menu-toggle { display: block; }
       .nav-wrapper-desktop { display: none; }
       .auth-buttons-desktop { display: none; } 
       nav.main-navigation { padding: 0; background-color: transparent; }

      /* Mobile-specific layout adjustments */
      form {
        grid-template-columns: 1fr; /* Change to single column layout */
      }

      h2 {
        margin-bottom: 20px; /* Add bottom margin for h2 */
      }

      section {
        padding: 20px 10px; /* Reduce padding for smaller screens */
      }

      #all-lessons-container {
        overflow-x: auto; /* Allow horizontal scrolling only for the table container */
        -webkit-overflow-scrolling: touch; /* Optional: for smoother scrolling on iOS */
      }
    }
  /* Override the highlighted “Book” pill to be fully rounded */
ul.nav-links-desktop li a.highlighted-nav {
  border-radius: 9999px;
}

/* If you also want the mobile “Book” link rounded, do: */
ul.nav-links-mobile li a.highlighted-nav {
  border-radius: 9999px;
}
/* Make desktop nav links more pill-shaped */
ul.nav-links-desktop li a {
  border-radius: 9999px;
}

/* Ensure highlighted tab stays pill-shaped */
ul.nav-links-desktop li a.highlighted-nav {
  border-radius: 9999px;
}

/* Make mobile nav links match */
ul.nav-links-mobile li a {
  border-radius: 9999px;
}
/* === End Global Header & Navigation Styles === */

.explore-button {
  font-family: Arial, sans-serif;
  font-size: 1rem;
  font-weight: 400;
  background-color: #3b82f6; /* Blue background */
  color: white !important; /* Ensure white text overrules other <a> styles */
  padding: 0.75rem 2rem;
  border: none;
  border-radius: 9999px; /* Pill shape */
  box-shadow:
    0 10px 15px -3px rgba(0, 0, 0, 0.1),
    0   4px  6px -2px rgba(0, 0, 0, 0.05);
  cursor: pointer;
  transform-origin: center center;
  transition: background-color 0.2s ease, transform 0.2s ease;
  text-decoration: none; /* Remove underline from <a> */
  display: inline-block; /* Make <a> behave like a button */
  text-align: center;
  margin-top: 30px; /* Add some space above the button */
}

.explore-button:hover {
  background-color: #2563eb; /* Darker blue on hover */
  transform: scale(1.05);
  color: white !important;
  text-decoration: none;
}
.update-payment-btn {
    background-color: #4CAF50; /* Green */
    color: white;
    padding: 5px 10px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9em;
}
.update-payment-btn:hover {
    background-color: #45a049;
}

/* Styles for the universal update button */
.universal-update-prices-btn {
  font-family: Arial, sans-serif;
  font-size: 1rem; /* Match explore-button */
  font-weight: 400; /* Match explore-button */
  background-color: #4CAF50; /* Green */
  color: white !important;
  padding: 0.75rem 1.5rem; /* New, reduced horizontal padding */
  border: none;
  border-radius: 9999px; /* Pill shape - Match explore-button */
  box-shadow:
    0 10px 15px -3px rgba(0, 0, 0, 0.1),
    0   4px  6px -2px rgba(0, 0, 0, 0.05); /* Match explore-button */
  cursor: pointer;
  transform-origin: center center;
  transition: background-color 0.2s ease, transform 0.2s ease; /* Match explore-button */
  text-decoration: none;
  display: inline-block; /* Prevent full-width */
  text-align: center;
  /* margin-top: 10px; /* Optional: adjust as needed */
  /* margin-bottom: 10px; /* Optional: adjust as needed */
}

.universal-update-prices-btn:hover {
  background-color: #45a049; /* Darker green on hover */
  transform: scale(1.05); /* Match explore-button */
  color: white !important;
  text-decoration: none;
}

.universal-update-prices-btn:disabled {
   background-color: #cccccc; /* Grey out when disabled */
   color: #666666;
   cursor: not-allowed;
   transform: none; /* No hover effect when disabled */
   box-shadow: none; /* No shadow when disabled */
}
  </style>
</head>
<body>

<header>
  <div class="header-content">
    <div class="site-title">
      <h1>Admin Portal</h1> <!-- Specific title -->
      <p>C2 Tennis Academy</p> <!-- Consistent subtitle -->
    </div>
    <button class="mobile-menu-toggle" aria-label="Open navigation menu" aria-expanded="false" aria-controls="mainNavigation">
      &#9776; <!-- Hamburger icon -->
    </button>
  </div>
  <div class="auth-buttons-desktop" id="authContainerDesktop">
    <!-- Populated by checkSession JS - will show Logout, Admin Home etc. -->
  </div>
</header>

<nav class="main-navigation" id="mainNavigation">
  <div class="nav-wrapper-desktop"> 
     <ul class="nav-links-desktop">
       <li><a href="index.html">Home</a></li>
       <li><a href="about.html">About</a></li>
       <li><a href="programs.html">Programs</a></li>
       <li><a href="schedule.html">Schedule</a></li>
       <li><a href="contact.html">Contact</a></li>
       <!-- No "Book" link by default for admin, can be added if needed -->
     </ul>
  </div>
  <div class="mobile-menu-container">
    <button class="mobile-menu-close" aria-label="Close navigation menu">&times;</button>
    <ul class="nav-links-mobile">
      <li><a href="index.html">Home</a></li>
      <li><a href="about.html">About</a></li>
      <li><a href="programs.html">Programs</a></li>
      <li><a href="schedule.html">Schedule</a></li>
      <li><a href="contact.html">Contact</a></li>
    </ul>
    <div class="auth-buttons-mobile" id="authContainerMobile">
      <!-- Populated by checkSession JS -->
    </div>
  </div>
</nav>

  <section>
    <h2>Add / Edit Lesson</h2>
    <form id="lesson-form">
      <input type="hidden" id="lesson-id" />

      <!-- Program -->
      <div class="full-width">
        <label for="program">Program</label>
        <select id="program" required>
          <option value="" disabled selected>Choose a program</option>
          <option value="Private Lesson">Private Lesson</option>
          <option value="Summer Camp - Day Pass">Summer Camp - Day Pass</option>
          <option value="Summer Camp - Week Pass">Summer Camp - Week Pass</option>
          <option value="Kids Camp - Day Pass">Kids Camp - Day Pass</option>
          <option value="Kids Camp - Week Pass">Kids Camp - Week Pass</option>
          <option value="Adult Clinics">Adult Clinics</option>
        </select>
      </div>

      <!-- Student (for Private Lessons) -->
      <div id="student-name-container" class="full-width">
        <label for="student-name">Student Name</label>
        <input type="text" id="student-name" placeholder="Enter student name for private lesson" />
      </div>

      <!-- Referral Source (for Private Lessons) -->
      <div id="referral-source-container" class="full-width" style="display: none;">
        <label for="referral_source">Referral Source</label>
        <select id="referral_source" name="referral_source">
          <option value="" selected>None</option>
          <option value="Ricardo">Referred by Ricardo</option>
          <option value="Jacob">Jacob's Own</option>
          <option value="Paula">Paula's Own</option>
          <option value="Zach">Zach's Own</option>
          <option value="RicardoOwn">Ricardo's Own</option>
        </select>
      </div>

      <!-- Coach -->
      <div id="coach-container">
        <label for="coach">Coach #1</label>
        <select id="coach" required>
          <option value="" disabled selected>Choose a coach</option>
          <option>Ricardo Carvajalino</option>
          <option>Jacob Capone</option>
          <option>Zach Capone</option>
          <option>Paula Carvajalino</option>
        </select>
      </div>

      <!-- Coach #2 -->
      <div id="coach2-container" style="display: none;">
        <label for="coach2">Coach #2</label>
        <select id="coach2">
          <option value="" selected>None</option>
          <option>Ricardo Carvajalino</option>
          <option>Jacob Capone</option>
          <option>Zach Capone</option>
          <option>Paula Carvajalino</option>
        </select>
      </div>

      <!-- Coach #3 -->
      <div id="coach3-container" style="display: none;">
        <label for="coach3">Coach #3</label>
        <select id="coach3">
          <option value="" selected>None</option>
          <option>Ricardo Carvajalino</option>
          <option>Jacob Capone</option>
          <option>Zach Capone</option>
          <option>Paula Caravajalino</option>
        </select>
      </div>

      <!-- Date -->
      <div>
        <label for="date">Date</label>
        <input type="date" id="date" required />
      </div>

      <!-- Time -->
      <div>
        <label for="time">Time</label>
        <input type="time" id="time" required />
      </div>

      <button type="submit">Save Lesson</button>
    </form>

    <!-- All Scheduled Lessons -->
    <h2>Scheduled Lessons Overview</h2>
    <div style="text-align: right; margin-bottom: 15px;"> <!-- Changed to text-align: right -->
        <button id="save-all-btn" class="universal-update-prices-btn" disabled>Update All Changed Prices</button>
    </div>
    <button id="enable-editing-btn" style="margin-bottom:10px;">Enable Editing</button>
    <div id="private-lessons-section" style="margin-bottom: 30px;">
        <h3>Private Lessons</h3>
        <div id="private-lessons-table-container">Loading private lessons...</div>
    </div>

    <div id="camp-lessons-section" style="margin-bottom: 30px;">
        <h3>Camps & Passes</h3>
        <div id="camp-lessons-table-container">Loading camp & pass lessons...</div>
    </div>

    <div id="clinic-lessons-section" style="margin-bottom: 30px;">
        <h3>Clinics & Other Group Lessons</h3>
        <div id="clinic-lessons-table-container">Loading clinic lessons...</div>
    </div>

    <div id="other-bookings-section" style="margin-bottom: 30px;">
        <h3>Other Bookings</h3>
        <div id="other-bookings-table-container">Loading other bookings...</div>
    </div>
    <div style="text-align: center; margin-top: 40px; margin-bottom: 20px;"> <!-- Wrapper for centering -->
      <a href="admin_history.html" class="explore-button">View Lesson History</a>
      <a href="finances.html" class="explore-button" style="margin-left: 10px;">View Finances</a>
    </div>
  </section>

  <footer>
    <p>&copy; 2025 C2 Tennis Academy. All rights reserved.</p>
  </footer>

  <!-- Edit Coaches Modal -->
  <div id="editCoachesModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Edit Coaches for Session</h2>
      </div>
      <div class="modal-body">
        <div class="session-info">
          <p><strong>Program:</strong> <span id="modalSessionProgram"></span></p>
          <p><strong>Date:</strong> <span id="modalSessionDate"></span></p>
          <p><strong>Time:</strong> <span id="modalSessionTime"></span></p>
        </div>
        <hr>
        <p><strong>Assign Coaches:</strong></p>
        <div id="coach-checkboxes-container">
          <!-- Coach checkboxes will be populated here by JavaScript -->
        </div>
        <input type="hidden" id="modalOriginalBookingIds">
        <input type="hidden" id="modalLessonCost">
        <input type="hidden" id="modalStudentName">
        <input type="hidden" id="modalStudentEmail">
        <input type="hidden" id="modalStudentPhone">
      </div>
      <div class="modal-footer">
        <button type="button" id="cancelEditCoachesBtn" class="cancel-btn">Cancel</button>
        <button type="button" id="saveCoachesChangesBtn">Save Changes</button>
      </div>
    </div>
  </div>

  <script>
    // Toggle student field
    const programEl = document.getElementById('program');
    const studentDiv = document.getElementById('student-name-container');
    const referralSourceDiv = document.getElementById('referral-source-container');
    const referralSourceSelect = document.getElementById('referral_source');

    // Coach selection elements
    const coach1Container = document.getElementById('coach-container');
    const coach1Select = document.getElementById('coach');
    const coach2Container = document.getElementById('coach2-container');
    const coach2Select = document.getElementById('coach2');
    const coach3Container = document.getElementById('coach3-container');
    const coach3Select = document.getElementById('coach3');

    const handleProgramChange = () => {
      const selectedProgram = programEl.value;
      // Valid private lesson program names that require referral source
      const privateLessonPrograms = ['Private Lessons', 'Tennis Private'];
      const isPrivateLesson = privateLessonPrograms.includes(selectedProgram);

      studentDiv.style.display = isPrivateLesson ? 'block' : 'none';
      document.getElementById('student-name').required = isPrivateLesson;
      
      referralSourceDiv.style.display = isPrivateLesson ? 'block' : 'none';
      referralSourceSelect.required = isPrivateLesson;

      if (!isPrivateLesson) {
        referralSourceSelect.value = ''; // Reset value if not a private lesson
      }

      // Coach visibility and requirement logic
      const campOrGroupPrograms = ["Summer Camp / Group Lessons", "High Performance Training", "Adult Clinics"];

      if (selectedProgram === "Private Lessons") {
        coach1Container.style.display = 'block';
        coach1Select.required = true;
        coach2Container.style.display = 'none';
        coach2Select.required = false;
        coach2Select.value = "";
        coach3Container.style.display = 'none';
        coach3Select.required = false;
        coach3Select.value = "";
      } else if (campOrGroupPrograms.includes(selectedProgram)) {
        coach1Container.style.display = 'block';
        coach1Select.required = true;
        coach2Container.style.display = 'block';
        coach2Select.required = false; // Optional
        coach3Container.style.display = 'block';
        coach3Select.required = false; // Optional
      } else { // Default for other programs or if no program is selected
        coach1Container.style.display = 'block';
        coach1Select.required = true;
        coach2Container.style.display = 'none';
        coach2Select.required = false;
        coach2Select.value = "";
        coach3Container.style.display = 'none';
        coach3Select.required = false;
        coach3Select.value = "";
      }
    };

    programEl.addEventListener('change', handleProgramChange);

    // Initial call to set coach fields based on default or pre-selected program
    handleProgramChange(); 

    // Submit new lesson
    document.getElementById('lesson-form').addEventListener('submit', async e => {
      e.preventDefault();

      const selectedProgram = programEl.value;
      const privateLessonPrograms = ['Private Lessons', 'Tennis Private'];
      const isPrivateLesson = privateLessonPrograms.includes(selectedProgram);
      const referralSourceValue = referralSourceSelect.value;

      if (isPrivateLesson && !document.getElementById('student-name').value) {
        alert('Student name is required for private lessons.');
        return;
      }

      if (isPrivateLesson && !referralSourceValue) {
        alert('Please select a referral source for private lessons.');
        return;
      }

      const payload = {
        program: selectedProgram,
        coachName: document.getElementById('coach').value,
        coachName2: document.getElementById('coach2').value,
        coachName3: document.getElementById('coach3').value,
        date: document.getElementById('date').value,
        time: document.getElementById('time').value,
        student: document.getElementById('student-name').value || '',
        referral_source: isPrivateLesson ? referralSourceValue : '' 
      };
      const res = await fetch('/api/admin/lessons', {
        method: 'POST',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      if (res.ok) {
        alert('Lesson saved');
        loadAllLessons();
        e.target.reset(); // This will trigger the reset event
      } else {
        alert('Save failed: ' + await res.text());
      }
    });

    // Handle form reset event
    document.getElementById('lesson-form').addEventListener('reset', () => {
        studentDiv.style.display = 'none';
        document.getElementById('student-name').required = false;
        referralSourceDiv.style.display = 'none';
        referralSourceSelect.required = false;
        referralSourceSelect.value = '';
        // programEl.value = ''; // Reset program dropdown to default placeholder
        // Ensure programEl is reset to its placeholder option.
        // The default "Choose a program" is disabled, so setting value to "" works.
        if(programEl.options.length > 0 && programEl.options[0].value === "" && programEl.options[0].disabled){
            programEl.value = "";
        }
        // Also reset coach fields on form reset
        handleProgramChange();
    });
  </script>

  <script>
  // Helper function to format time to 12-hour AM/PM
  function formatTime_12hr(timeStr) {
    if (!timeStr || !timeStr.includes(':')) {
      return timeStr; // Return original if invalid
    }
    const parts = timeStr.split(':');
    let hours = parseInt(parts[0], 10);
    const minutes = parseInt(parts[1], 10);
    
    const ampm = hours >= 12 ? 'PM' : 'AM';
    hours = hours % 12;
    hours = hours ? hours : 12; // the hour '0' should be '12'
    
    const minutesStr = minutes < 10 ? '0' + minutes : minutes;
    
    return hours + ':' + minutesStr + ' ' + ampm;
  }

  // Helper function to check for input changes across all tables and update the save button state
  function checkGlobalInputChanges() {
    const saveBtn = document.getElementById('save-all-btn');
    if (!saveBtn) {
        console.error('checkGlobalInputChanges: Save button not found.');
        return;
    }

    const allTableContainerIds = [
        'private-lessons-table-container',
        'camp-lessons-table-container',
        'clinic-lessons-table-container',
        'other-bookings-table-container'
    ];
    let hasOverallChanges = false;

    for (const containerId of allTableContainerIds) {
        const container = document.getElementById(containerId);
        if (!container) {
            continue; 
        }

        // Check cost inputs
        const costInputs = container.querySelectorAll('.lesson-cost-input');
        for (const inputField of costInputs) {
            const originalCostStr = inputField.getAttribute('data-original-cost');
            const originalCost = parseFloat(originalCostStr);
            const currentValue = inputField.value.trim();

            if (currentValue === '' && (originalCostStr === '' || isNaN(originalCost))) {
                continue;
            }
            if (currentValue === '' && (originalCostStr !== '' && !isNaN(originalCost)) ) {
                hasOverallChanges = true;
                break;
            }
            const currentCost = parseFloat(currentValue);
            if (isNaN(currentCost) && currentValue !== '') {
                // This case means the input is not a valid number but is not empty.
                // Depending on requirements, you might want to flag this as a change or prevent submission.
                // For now, it's not counted as a "valid change" for enabling the button.
                continue;
            }
            if (currentValue !== '' && isNaN(originalCost) && !isNaN(currentCost)) { // New valid price for previously empty
                hasOverallChanges = true;
                break;
            }
            if (!isNaN(originalCost) && !isNaN(currentCost) && currentCost !== originalCost) { 
                hasOverallChanges = true;
                break;
            }
        }
        if (hasOverallChanges) break;

        // Check referral selects
        const referralSelects = container.querySelectorAll('.referral-select');
        for (const sel of referralSelects) {
            if (sel.value !== sel.dataset.originalReferral) {
                hasOverallChanges = true;
                break;
            }
        }
        if (hasOverallChanges) break; 
    }
    saveBtn.disabled = !hasOverallChanges;
  }

  // Helper function to render a table for a specific set of lessons
  function renderLessonsTable(lessonsArray, containerId, placeholderMessage) {
    console.log('ADMIN.HTML: renderLessonsTable START for container:', containerId, 'with lessons:', lessonsArray.length, 'First lesson if exists:', lessonsArray[0]);
    const coachColors = {
        'Ricardo Carvajalino': '#e0f7fa', // Light cyan/blue
        'Jacob Capone': '#fff9c4',      // Light yellow
        'Zach Capone': '#c8e6c9',        // Light green
        'Zachary Capone': '#c8e6c9',     // Alias for Zach
       
        'Paula Carvajalino': '#f3e5f5'  // Light purple
    };
    const container = document.getElementById(containerId);
    if (!container) {
      console.error('Container not found for ID:', containerId);
      return;
    }

    if (lessonsArray.length === 0) {
      console.log('ADMIN.HTML: Rendering placeholder for:', containerId);
      container.innerHTML = `<p>${placeholderMessage}</p>`;
      return;
    }

    let html = `
      <table style="width:100%; border-collapse:collapse; margin-top:10px;">
        <thead>
          <tr style="background:#0c3c78; color:white;">
            <th style="padding:8px; border:1px solid #ddd;">Program</th>
            <th style="padding:8px; border:1px solid #ddd;">Coach</th>
            <th style="padding:8px; border:1px solid #ddd;">Date</th>
            <th style="padding:8px; border:1px solid #ddd;">Time</th>
            <th style="padding:8px; border:1px solid #ddd;">Student</th>
            <th style="padding:8px; border:1px solid #ddd;">Email</th>
            <th style="padding:8px; border:1px solid #ddd;">Phone</th>
            <th style="padding:8px; border:1px solid #ddd;">Lesson Cost</th>
            ${containerId === 'private-lessons-table-container' ? '<th style="padding:8px; border:1px solid #ddd;">Payout Type</th>' : ''}
            <th style="padding:8px; border:1px solid #ddd;">Actions</th>
            ${containerId === 'camp-lessons-table-container' ? '<th style="padding:8px; border:1px solid #ddd;">Attendance / Pass Status</th>' : ''}
          </tr>
        </thead>
        <tbody>
    `;

    lessonsArray.forEach(les => {
      const dateStr = new Date(les.date).toLocaleDateString();
      const formattedTime = formatTime_12hr(les.time);
      const refVal = les.referral_source || ''; // Defined for use in referral select
      
      let rowStyle = '';
      const isCampTable = containerId === 'camp-lessons-table-container';

      // For camp table, coach display and data-id will be different.
      let coachDisplay = '';
      let currentLessonIdOrIds = les.id; // Default for non-camp or non-grouped lessons

      if (isCampTable && les.coaches && Array.isArray(les.coaches)) {
        coachDisplay = les.coaches.join(', ');
        currentLessonIdOrIds = les.booking_ids ? les.booking_ids.join(',') : les.id; // Use booking_ids for grouped
         // For grouped camps, background color could be based on the program or be neutral
      } else if (containerId === 'private-lessons-table-container' && les.coach && coachColors[les.coach]) {
        rowStyle = `background-color: ${coachColors[les.coach]};`;
        coachDisplay = les.coach;
      } else {
        coachDisplay = les.coach || 'N/A';
      }

      html += `
        <tr data-id="${currentLessonIdOrIds}" ${rowStyle ? `style="${rowStyle}"` : ''}>
          <td style="padding:8px; border:1px solid #ddd;">${les.program}</td>
          <td style="padding:8px; border:1px solid #ddd;">${coachDisplay}</td>
          <td style="padding:8px; border:1px solid #ddd;">${dateStr}</td>
          <td style="padding:8px; border:1px solid #ddd;">${formattedTime}</td>
          <td style="padding:8px; border:1px solid #ddd;">${ isCampTable ? 'N/A' : (les.student || '—')}</td>
          <td style="padding:8px; border:1px solid #ddd;">${ isCampTable ? 'N/A' : (les.email || '—')}</td>
          <td style="padding:8px; border:1px solid #ddd;">${ isCampTable ? 'N/A' : (les.phone || '—')}</td>
          <td style="padding:8px; border:1px solid #ddd;">$<input type="number" class="lesson-cost-input" data-booking-id="${isCampTable && les.booking_ids ? les.booking_ids[0] : les.id}" value="${les.lesson_cost !== null && les.lesson_cost !== undefined ? les.lesson_cost : ''}" data-original-cost="${les.lesson_cost !== null && les.lesson_cost !== undefined ? les.lesson_cost : ''}" placeholder="N/A" style="width: 70px;" disabled></td>`;
          
      if (containerId === 'private-lessons-table-container') {
        html += `
          <td style="padding:8px; border:1px solid #ddd;">
            <select class="referral-select" data-booking-id="${les.id}" data-original-referral="${refVal}" style="min-width:140px;" disabled>
              <option value="" ${refVal === '' ? 'selected' : ''}>None</option>
              <option value="Ricardo" ${refVal === 'Ricardo' ? 'selected' : ''}>Referred by Ricardo ($20)</option>
              <option value="Jacob" ${refVal === 'Jacob' ? 'selected' : ''}>Jacob’s Own ($10)</option>
              <option value="Paula" ${refVal === 'Paula' ? 'selected' : ''}>Paula’s Own (10%)</option>
              <option value="Zach" ${refVal === 'Zach' ? 'selected' : ''}>Zach’s Own (10%)</option>
              <option value="RicardoOwn" ${les.coach === 'Ricardo Carvajalino' && refVal !== 'Ricardo' ? 'selected' : ''}>Ricardo’s Own (100%)</option>
              <option value="Google" ${refVal === 'Google' ? 'selected' : ''}>Google</option>
              <option value="Friend" ${refVal === 'Friend' ? 'selected' : ''}>Friend</option>
              <option value="Flyer" ${refVal === 'Flyer' ? 'selected' : ''}>Flyer</option>
            </select>
          </td>
        `;
      }
          
      html += `<td style="padding:8px; border:1px solid #ddd;">`;
      if (isCampTable && les.booking_ids && Array.isArray(les.booking_ids)) {
        html += `<button onclick="deleteGroupedCampLesson('${les.booking_ids.join(',')}')">Delete Session</button>`;
        html += `<button class="edit-coaches-btn" 
                         data-program="${les.program}" 
                         data-date="${les.date}" 
                         data-time="${les.time}" 
                         data-booking-ids="${les.booking_ids.join(',')}" 
                         data-coaches="${les.coaches.join(',')}">Edit Coaches</button>`;
      } else {
        html += `<button onclick="deleteAdminLesson(${les.id})">Delete</button>`;
      }
      html += `</td>`;

      if (containerId === 'camp-lessons-table-container') {
        const programName = les.program ? les.program.toLowerCase() : '';
        let isPassType = false;
        let totalPassDays = 0;
        // For grouped lessons, attendance might be tracked per original booking ID.
        // This example uses the first booking ID for simplicity if one ID is needed.
        const attendanceBookingId = (les.booking_ids && les.booking_ids.length > 0) ? les.booking_ids[0] : les.id;

        if (programName.includes('week pass')) {
            isPassType = true;
            totalPassDays = 5; 
        } else if (programName.includes('day pass')) {
            isPassType = true;
            totalPassDays = 1;
        }

        if (isPassType) {
            if (totalPassDays > 1) { // Week pass
                html += '<td>';
                html += `<div>Days: <span class="days-used" data-booking-id="${attendanceBookingId}">0</span> / <span class="total-days">${totalPassDays}</span> used</div>`;
                html += `<div class="attendance-markers" style="margin-top: 5px; display: flex; flex-wrap: wrap;">`;
                for (let i = 0; i < totalPassDays; i++) {
                    html += `<label style="display: inline-block; margin-right: 8px; font-size: 0.9em;">
                               <input type="checkbox" class="attendance-checkbox" data-booking-id="${attendanceBookingId}" data-day-index="${i}"> D${i + 1}
                             </label>`;
                }
                html += `</div></td>`;
            } else { // Day pass (totalPassDays === 1)
                html += '<td>';
                html += `<div>Status: <span class="attendance-status" data-booking-id="${attendanceBookingId}">Not Attended</span></div>`;
                html += `<div class="attendance-markers" style="margin-top: 5px;">
                           <label style="display: inline-block; font-size: 0.9em;">
                             <input type="checkbox" class="attendance-checkbox" data-booking-id="${attendanceBookingId}" data-day-index="0"> Mark Attended
                           </label>
                         </div></td>`;
            }
        } else { // Not a pass type, but could be a non-pass camp/clinic displayed in this table.
             // If it's a grouped camp session (not a pass), show 'N/A' or specific group attendance UI if developed.
             // For now, 'N/A' for simplicity if not a pass type.
            html += `<td>N/A</td>`;
        }
      }
      html += `</tr>`;
    });

    html += `</tbody></table>`;
    container.innerHTML = html;
    checkGlobalInputChanges(); // Add this line
    console.log('ADMIN.HTML: Rendering actual table into:', containerId, 'HTML length:', html.length > 0 ? html.length : 'EMPTY!');

    // Event listeners for .update-cost-btn are removed as the buttons themselves are removed.

    const costInputsInTable = container.querySelectorAll('.lesson-cost-input');
    costInputsInTable.forEach(input => {
        input.addEventListener('input', function() {
            checkGlobalInputChanges(); // Changed from checkTableInputChanges
        });
    });
    // Initial check for button state when table loads will be handled by a call after innerHTML is set

    if (containerId === 'camp-lessons-table-container') {
        const checkboxes = document.querySelectorAll(`#${containerId} .attendance-checkbox`);
        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('change', (event) => {
                const bookingId = event.target.getAttribute('data-booking-id');
                const dayIndex = parseInt(event.target.getAttribute('data-day-index'));
                handleAttendanceChange(bookingId, dayIndex, event.target.checked);
            });
        });
    }

    // Event listener for new referral type dropdowns
    const referralSelects = container.querySelectorAll('.referral-select');
    referralSelects.forEach(selectEl => {
      selectEl.addEventListener('change', checkGlobalInputChanges);
    });
  }

  // handlePayoutTypeChange function is removed.
  // Load & render the admin lessons table
  async function loadAllLessons() {
    const res = await fetch('/api/admin/lessons', { credentials: 'include' });
    // Initial error check (applies to all tables if fetch fails)
    if (!res.ok) {
      const errorMsg = '<p style="color:red;">Could not load lessons data.</p>';
      document.getElementById('private-lessons-table-container').innerHTML = errorMsg;
      document.getElementById('camp-lessons-table-container').innerHTML = errorMsg;
      document.getElementById('clinic-lessons-table-container').innerHTML = errorMsg;
      document.getElementById('other-bookings-table-container').innerHTML = errorMsg;
      return;
    }
    const lessons = await res.json();
    console.log('ADMIN.HTML: Fetched total lessons:', lessons.length, 'First two:', lessons.slice(0,2));

    const campLikePrograms = ["Summer Camp / Group Lessons", "High Performance Training", "Adult Clinics"];
    const now = new Date();
    const upcomingLessons = lessons.filter(les => {
        if (!les.date) return false; // Skip if no date
        // Ensure date is in YYYY-MM-DD format before splitting
        const dateStr = typeof les.date === 'string' && les.date.length >= 10 ? les.date.substring(0, 10) : null;
        if (!dateStr) {
            console.warn('ADMIN.HTML: Invalid or missing date string for lesson:', les);
            return false;
        }
        const dateParts = dateStr.split('-');
        if (dateParts.length !== 3) return false;

        const year = parseInt(dateParts[0]);
        const month = parseInt(dateParts[1]) - 1; // JS months are 0-indexed
        const day = parseInt(dateParts[2]);

        let hours = 0, minutes = 0, seconds = 0; 
        if (les.time) { // HH:MM or HH:MM:SS
            const timeParts = les.time.split(':');
            if (timeParts.length >= 2) {
                hours = parseInt(timeParts[0]);
                minutes = parseInt(timeParts[1]);
                seconds = timeParts[2] ? parseInt(timeParts[2]) : 0;
            }
        }
        
        try {
            const lessonDate = new Date(year, month, day, hours, minutes, seconds);
            if (isNaN(lessonDate.getTime())) { // Check if the constructed date is valid
                 console.warn('ADMIN.HTML: Constructed invalid date for lesson:', les, 'using Y/M/D H:M:S', year, month, day, hours, minutes, seconds);
                 return false;
            }
            const nowDateOnly = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            if (lessonDate >= nowDateOnly) { 
                 if (lessonDate.toDateString() === now.toDateString()) { 
                     return lessonDate >= now; 
                 }
                 return true; 
            }
            return false;
        } catch (e) {
            console.error(`ADMIN.HTML: Error processing date for lesson:`, les, e);
            return false;
        }
    });
    console.log('ADMIN.HTML: Filtered upcoming lessons count:', upcomingLessons.length, 'First two:', upcomingLessons.slice(0,2));

    const privateLessons = [];
    const clinicLessons = []; // For 'Adult Clinics', 'High Performance Training' (if not grouped with camps)
    const otherBookings = [];
    
    // Grouping logic for camp-like lessons
    const groupedCampLessons = {};
    upcomingLessons.forEach(les => {
        const programName = les.program; // Use original program name for matching
        if (campLikePrograms.includes(programName)) {
            // Use raw date (YYYY-MM-DD) and time (HH:MM:SS) for grouping key to avoid timezone/format issues.
            const groupKey = `${programName}-${les.date}-${les.time}`;
            if (!groupedCampLessons[groupKey]) {
                groupedCampLessons[groupKey] = {
                    ...les, // Spread the first lesson's details
                    coaches: [les.coach],
                    booking_ids: [les.id],
                    // Ensure student, email, phone, referral_source are handled if they vary (they shouldn't for same session)
                    // For display, these will likely be 'N/A' or taken from the first lesson.
                    student: les.student || '', // Keep original student if any, or empty
                    email: les.email || '',
                    phone: les.phone || '',
                    referral_source: les.referral_source || null
                };
            } else {
                if (les.coach && !groupedCampLessons[groupKey].coaches.includes(les.coach)) {
                    groupedCampLessons[groupKey].coaches.push(les.coach);
                }
                groupedCampLessons[groupKey].booking_ids.push(les.id);
                // Potentially update lesson_cost if it varies, though it should be consistent for a session.
                // For simplicity, the first lesson's cost is used.
            }
        } else if (programName && (programName.toLowerCase().includes('private') || programName.toLowerCase().includes('tennis private'))) {
            privateLessons.push(les);
        } else if (programName && (programName.toLowerCase().includes('clinic') || programName.toLowerCase().includes('high performance'))) {
            // This is a fallback if some clinics are not caught by campLikePrograms or have distinct handling.
            // If 'High Performance Training' and 'Adult Clinics' are ALWAYS grouped like camps, they won't reach here.
            clinicLessons.push(les);
        } else {
            otherBookings.push(les);
        }
    });

    const processedCampLessons = Object.values(groupedCampLessons);
    console.log('ADMIN.HTML: Processed Grouped Camp Lessons:', processedCampLessons.length, 'First entry:', processedCampLessons[0]);
    
    // Now categorize remaining non-camp lessons (if any clinics were not grouped)
    // This part might need adjustment based on whether 'Adult Clinics' and 'High Performance' are exclusively in campLikePrograms
    // For now, assuming campLikePrograms handles them, so clinicLessons might be empty or for other types.

    console.log('ADMIN.HTML: Categorized - Private:', privateLessons.length, 'Clinics (non-grouped):', clinicLessons.length, 'Other:', otherBookings.length);

    renderLessonsTable(privateLessons, 'private-lessons-table-container', 'No private lessons scheduled.');
    renderLessonsTable(processedCampLessons, 'camp-lessons-table-container', 'No camp or pass lessons scheduled.');
    renderLessonsTable(clinicLessons, 'clinic-lessons-table-container', 'No clinic or other group lessons scheduled.'); // Shows non-grouped clinics
    renderLessonsTable(otherBookings, 'other-bookings-table-container', 'No other bookings.');
    checkGlobalInputChanges();
  }

  // Placeholder for the new function
  async function deleteGroupedCampLesson(bookingIdsString) {
    console.log("Attempting to delete grouped camp session with Booking IDs:", bookingIdsString);
    const bookingIds = bookingIdsString.split(',');
    if (!confirm(`Are you sure you want to delete this entire camp session? This will delete ${bookingIds.length} booking(s). This action cannot be undone.`)) {
        return;
    }
    // Actual deletion logic will involve iterating IDs and calling deleteAdminLesson or a new batch delete API endpoint.
    // For now, just logging and potentially refreshing.
    try {
        let allSucceeded = true;
        for (const id of bookingIds) {
            const res = await fetch(`/api/admin/lessons/${id}`, {
                method: 'DELETE',
                credentials: 'include'
            });
            if (!res.ok) {
                allSucceeded = false;
                console.error(`Failed to delete booking ID ${id}: ${await res.text()}`);
                // Decide if to stop or continue on error
            }
        }
        if (allSucceeded) {
            alert('Entire camp session deleted successfully.');
        } else {
            alert('Some bookings in the camp session could not be deleted. Please check the console and refresh.');
        }
    } catch (err) {
        alert('An error occurred while trying to delete the camp session. Check console.');
        console.error('Error in deleteGroupedCampLesson:', err);
    }
    loadAllLessons(); // Refresh
  }


  async function deleteAdminLesson(id) {
    if (!confirm('Are you sure you want to delete this lesson?')) return;
    const res = await fetch(`/api/admin/lessons/${id}`, {
      method: 'DELETE',
      credentials: 'include'
    });
    if (res.ok) {
      loadAllLessons();
    } else {
      alert('Delete failed: ' + await res.text());
    }
  }

  // Removed handleUpdatePayment(bookingId) function (if any was left)
  // Removed markAsPaid(bookingId) function (if any was left)

  // Old handleUpdateCost function is removed.

  async function handleSaveChanges() {
    const enableBtn = document.getElementById('enable-editing-btn');
    if (enableBtn) enableBtn.disabled = true;
    const saveButton = document.getElementById('save-all-btn'); // Renamed variable for clarity
    if (saveButton) saveButton.disabled = true;

    const allTableContainerIds = [
        'private-lessons-table-container',
        'camp-lessons-table-container',
        'clinic-lessons-table-container',
        'other-bookings-table-container'
    ];
    const pendingUpdates = [];
    const referralUpdates = []; // To store referral changes
    const results = { successes: [], failures: [] };

    for (const containerId of allTableContainerIds) {
        const container = document.getElementById(containerId);
        if (!container) {
            console.warn('Table container not found for ID during save:', containerId);
            continue;
        }

        // Collect cost updates
        const costInputFields = container.querySelectorAll('.lesson-cost-input');
        costInputFields.forEach(inputField => {
            const bookingId = inputField.getAttribute('data-booking-id');
            const originalCostStr = inputField.getAttribute('data-original-cost');
            const originalCost = parseFloat(originalCostStr); // Will be NaN if originalCostStr is empty or not a number
            
            const currentValue = inputField.value.trim();

            if (currentValue === '') { // If input is empty, treat as no change or invalid, skip.
                return; 
            }

            const currentCost = parseFloat(currentValue);

            if (isNaN(currentCost)) {
                // results.failures.push(`Booking ID ${bookingId}: Invalid cost format ('${currentValue}').`); // Failure will be caught by checkGlobalInputChanges, or can be added if specific feedback per field is desired here
                return; // Skip if not a valid number
            }

            // Change detection logic:
            // 1. If originalCost was not a number (e.g., empty field initially) AND currentCost is a number, it's an update.
            // 2. If originalCost was a number AND currentCost is different, it's an update.
            let isChanged = false;
            if (isNaN(originalCost) && !isNaN(currentCost)) {
                 isChanged = true;
            } else if (!isNaN(originalCost) && currentCost !== originalCost) {
                 isChanged = true;
            }

            if (isChanged) {
                pendingUpdates.push({ bookingId, newCost: currentCost });
            }
        });

        // Collect referral updates
        const referralSelects = container.querySelectorAll('.referral-select');
        referralSelects.forEach(sel => {
            if (sel.value !== sel.dataset.originalReferral && sel.value) { // Ensure "Choose..." is not selected
                referralUpdates.push({ id: sel.dataset.bookingId, newReferral: sel.value });
            }
        });
    }

    if (pendingUpdates.length === 0 && referralUpdates.length === 0) {
        alert("No changes detected to update.");
        if (saveButton) saveButton.disabled = true; // Should already be, but ensure
        if (enableBtn) enableBtn.disabled = false; // Re-enable editing if nothing was changed
        return;
    }

    const costPromises = pendingUpdates.map(item =>
        fetch(`/api/admin/booking-payment/${item.bookingId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json', 'Credentials': 'include' },
            body: JSON.stringify({ lesson_cost_from_req: item.newCost })
        })
    );

    const referralPromises = referralUpdates.map(item =>
        fetch(`/api/admin/update-booking/${item.id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json', 'Credentials': 'include' },
            body: JSON.stringify({ referral_source: item.newReferral })
        })
    );

    const allPromises = [...costPromises, ...referralPromises];
    const allSettledResults = await Promise.allSettled(allPromises);

    allSettledResults.forEach((result, index) => {
        const isCostUpdate = index < costPromises.length;
        const originalItem = isCostUpdate ? pendingUpdates[index] : referralUpdates[index - costPromises.length];
        const id = isCostUpdate ? originalItem.bookingId : originalItem.id;
        const type = isCostUpdate ? "Cost" : "Referral";

        if (result.status === 'fulfilled') {
            if (result.value.ok) {
                results.successes.push(`Booking ID ${id}: ${type} updated successfully.`);
            } else {
                // Try to parse error from server, else use status
                result.value.json().then(errData => {
                    results.failures.push(`Booking ID ${id}: ${type} update failed (server: ${errData.message || 'Unknown error'}).`);
                }).catch(() => { // Catch if .json() fails (e.g. not a JSON response)
                    results.failures.push(`Booking ID ${id}: ${type} update failed (status ${result.value.status}, unparseable error).`);
                });
            }
        } else { // status === 'rejected'
            results.failures.push(`Booking ID ${id}: ${type} update failed (network/request error: ${result.reason}).`);
        }
    });

    let summaryMessage = "Update Summary:\n";
    if (results.successes.length > 0) {
        summaryMessage += `${results.successes.length} updates processed successfully.\n`;
        // results.successes.forEach(s => summaryMessage += `- ${s}\n`); // Optional: list successes
    }
    if (results.failures.length > 0) {
        summaryMessage += `${results.failures.length} updates failed:\n`;
        results.failures.forEach(failure => {
            summaryMessage += `- ${failure}\n`;
        });
    }
    if (results.successes.length === 0 && results.failures.length === 0 && (pendingUpdates.length > 0 || referralUpdates.length > 0)) {
        // This case handles if all promises resolved but none were 'ok' and .json() parsing is pending
        // However, the current logic pushes to failures if not .ok, so this might be less common
        // For now, ensure some message is shown if updates were attempted.
        summaryMessage = "Processing complete. Review logs if expected changes are not visible.";
    }
    
    alert(summaryMessage);

    loadAllLessons(); // Refresh the data
    if (enableBtn) enableBtn.disabled = false; // Re-enable editing button
    // Save button state will be updated by checkGlobalInputChanges via loadAllLessons
  }

function handleAttendanceChange(bookingId, dayIndex, isChecked) {
    console.log(`Attendance change: Booking ID ${bookingId}, Day Index ${dayIndex}, Checked: ${isChecked}`);
    // Mock UI update:
    const daysUsedSpan = document.querySelector(`.days-used[data-booking-id="${bookingId}"]`);
    const statusSpan = document.querySelector(`.attendance-status[data-booking-id="${bookingId}"]`);

    if (daysUsedSpan) { // For multi-day passes
        let currentDaysUsed = 0;
        document.querySelectorAll(`.attendance-checkbox[data-booking-id="${bookingId}"]`).forEach(cb => {
            if (cb.checked) currentDaysUsed++;
        });
        daysUsedSpan.textContent = currentDaysUsed;
    } else if (statusSpan) { // For single-day passes
        statusSpan.textContent = isChecked ? 'Attended' : 'Not Attended';
    }
}
</script>
  <script>
  // This entire block to be added as a new script, or integrated if a single DOMContentLoaded is preferred.
  document.addEventListener('DOMContentLoaded', () => {
      // Attach listener for the universal update button
      const saveBtn = document.getElementById('save-all-btn');
      if (saveBtn) {
          saveBtn.addEventListener('click', function() {
              handleSaveChanges(); // Call without arguments
          });
      }

      // --- Edit Coaches Modal Logic ---
      const editCoachesModal = document.getElementById('editCoachesModal');
      const cancelEditCoachesBtn = document.getElementById('cancelEditCoachesBtn');
      const saveCoachesChangesBtn = document.getElementById('saveCoachesChangesBtn');
      const coachCheckboxesContainer = document.getElementById('coach-checkboxes-container');
      
      // Define available coaches (can be dynamic later if needed)
      const availableCoaches = [
          "Ricardo Carvajalino", 
          "Jacob Capone", 
          "Zach Capone", 
         
          "Paula Carvajalino" 
      ];

      // Populate coach checkboxes
      availableCoaches.forEach(coachName => {
          const label = document.createElement('label');
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.name = 'modalCoach';
          checkbox.value = coachName;
          label.appendChild(checkbox);
          label.appendChild(document.createTextNode(` ${coachName}`));
          coachCheckboxesContainer.appendChild(label);
      });

      // Event listener for opening the modal (delegated to table container)
      const campLessonsTableContainer = document.getElementById('camp-lessons-table-container');
      if (campLessonsTableContainer) {
        campLessonsTableContainer.addEventListener('click', async (event) => {
            if (event.target.classList.contains('edit-coaches-btn')) {
                const button = event.target;
                const program = button.dataset.program;
                const date = button.dataset.date; // This is YYYY-MM-DDTHH:MM:SS.sssZ from DB
                const time = button.dataset.time; // This is HH:MM:SS from DB
                const originalBookingIds = button.dataset.bookingIds.split(',').map(Number);
                const currentCoaches = button.dataset.coaches.split(',');

                // Fetch student, email, phone from the first booking ID if needed (they are N/A in table)
                // For simplicity, assume they might be empty or not critical for camps.
                // We'll pass empty strings for now, as server.js handles defaults.
                document.getElementById('modalStudentName').value = ''; 
                document.getElementById('modalStudentEmail').value = '';
                document.getElementById('modalStudentPhone').value = '';


                // Find the lesson_cost from the input field in the same row
                const row = button.closest('tr');
                const costInput = row.querySelector('.lesson-cost-input');
                const lessonCost = costInput ? parseFloat(costInput.value) : 0; // Default to 0 if not found

                document.getElementById('modalSessionProgram').textContent = program;
                document.getElementById('modalSessionDate').textContent = new Date(date).toLocaleDateString(); // Format for display
                document.getElementById('modalSessionTime').textContent = formatTime_12hr(time); // Format for display

                // Store data needed for save operation
                editCoachesModal.dataset.program = program;
                editCoachesModal.dataset.date = date.substring(0,10); // Store YYYY-MM-DD
                editCoachesModal.dataset.time = time; // Store HH:MM:SS
                document.getElementById('modalOriginalBookingIds').value = JSON.stringify(originalBookingIds);
                document.getElementById('modalLessonCost').value = lessonCost;


                // Set checkboxes
                coachCheckboxesContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                    cb.checked = currentCoaches.includes(cb.value);
                });
                editCoachesModal.style.display = 'block';
            }
        });
      } else {
          console.warn("camp-lessons-table-container not found for modal delegation.");
      }


      if(cancelEditCoachesBtn) {
        cancelEditCoachesBtn.onclick = () => {
            editCoachesModal.style.display = 'none';
        }
      }

      if(saveCoachesChangesBtn) {
        saveCoachesChangesBtn.onclick = async () => {
            const newSelectedCoaches = [];
            coachCheckboxesContainer.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => {
                newSelectedCoaches.push(cb.value);
            });

            const payload = {
                program: editCoachesModal.dataset.program,
                date: editCoachesModal.dataset.date, // YYYY-MM-DD
                time: editCoachesModal.dataset.time, // HH:MM:SS
                originalBookingIds: JSON.parse(document.getElementById('modalOriginalBookingIds').value),
                newCoaches: newSelectedCoaches,
                lesson_cost: parseFloat(document.getElementById('modalLessonCost').value),
                student: document.getElementById('modalStudentName').value,
                email: document.getElementById('modalStudentEmail').value,
                phone: document.getElementById('modalStudentPhone').value
            };

            try {
                const res = await fetch('/api/admin/lessons/update-coaches', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Credentials': 'include' },
                    body: JSON.stringify(payload)
                });
                const responseData = await res.json();
                if (res.ok) {
                    alert(responseData.message || 'Coaches updated successfully!');
                    editCoachesModal.style.display = 'none';
                    loadAllLessons();
                } else {
                    alert('Failed to update coaches: ' + (responseData.message || 'Unknown error'));
                }
            } catch (err) {
                console.error('Error saving coach changes:', err);
                alert('An error occurred while saving changes. See console for details.');
            }
        }
      }
      
      // Close modal if user clicks outside of it
      window.onclick = (event) => {
          if (event.target == editCoachesModal) {
              editCoachesModal.style.display = "none";
          }
      }
      // --- End Edit Coaches Modal Logic ---


      // --- Mobile Menu Toggle Script --- 
      const menuToggle = document.querySelector('.mobile-menu-toggle');
      const mobileMenuClose = document.querySelector('.mobile-menu-close');
      const mainNav = document.querySelector('nav.main-navigation');

      if (menuToggle && mainNav && mobileMenuClose) {
          menuToggle.addEventListener('click', () => {
              const isMenuOpen = mainNav.classList.toggle('mobile-menu--open');
              menuToggle.setAttribute('aria-expanded', isMenuOpen);
              if (isMenuOpen) {
                  menuToggle.innerHTML = '&times;'; 
                  menuToggle.setAttribute('aria-label', 'Close navigation menu');
              } else {
                  menuToggle.innerHTML = '&#9776;'; 
                  menuToggle.setAttribute('aria-label', 'Open navigation menu');
              }
          });

          mobileMenuClose.addEventListener('click', () => {
              mainNav.classList.remove('mobile-menu--open');
              if (menuToggle) {
                 menuToggle.setAttribute('aria-expanded', 'false');
                 menuToggle.innerHTML = '&#9776;'; 
                 menuToggle.setAttribute('aria-label', 'Open navigation menu');
              }
          });
      }

      const mobileNavLinks = document.querySelectorAll('.mobile-menu-container a');
      if (mainNav && mobileNavLinks.length > 0) {
          mobileNavLinks.forEach(link => {
              link.addEventListener('click', () => {
                  if (mainNav.classList.contains('mobile-menu--open')) {
                      mainNav.classList.remove('mobile-menu--open');
                      if (menuToggle) {
                          menuToggle.setAttribute('aria-expanded', 'false');
                          menuToggle.innerHTML = '&#9776;';
                          menuToggle.setAttribute('aria-label', 'Open navigation menu');
                      }
                  }
              });
          });
      }

      // --- checkSession and logout functions for Admin Portal --- 
      async function checkSession() {
          // Ensure existing greetings are removed before adding a new one to prevent duplicates from multiple calls
          const existingGreeting = document.querySelector('.welcome-greeting');
          if (existingGreeting) existingGreeting.remove();
           
          // Original admin.html had <p>Admin Portal: Welcome Admin</p> in header.
          // New header has "Admin Portal" as h1, "C2 Tennis Academy" as p.
          // Greeting banner will add "Welcome, [firstName]" if available, or just "Welcome, Admin".

          try {
              const res = await fetch('/api/check-session', { credentials: 'include' });
              const data = await res.json(); 

              const authContainerDesktop = document.getElementById('authContainerDesktop');
              const authContainerMobile = document.getElementById('authContainerMobile');
              
              if (data && data.loggedIn === true && data.isAdmin === true) {
                  // Corrected logic for portal button text
                  const portalButtonText = data.firstName ? 'Admin (' + data.firstName + ')' : 'Admin Portal';
                  
                  const loggedInHTML = '<a href="admin.html"><button>' + portalButtonText + '</button></a><button onclick="logout()">Logout</button>';
                  const loggedInMobileHTML = loggedInHTML; // Assuming it's the same

                  if (authContainerDesktop) authContainerDesktop.innerHTML = loggedInHTML;
                  if (authContainerMobile) authContainerMobile.innerHTML = loggedInMobileHTML;

                  // Corrected logic for welcome message text
                  const welcomeMessageText = data.firstName ? 'Welcome, ' + data.firstName + '!' : 'Welcome, Admin!';
                  
                  const greeting = document.createElement('div');
                  greeting.className = 'welcome-greeting';
                  greeting.textContent = welcomeMessageText;
                  greeting.style.cssText = 'background:#0c3c78;color:white;padding:10px;text-align:center;font-weight:bold;';
                  
                  // This logic for inserting the greeting is already here.
                  // Ensure existing greetings are removed before adding a new one to prevent duplicates from multiple calls
                  const existingGreeting = document.querySelector('.welcome-greeting');
                  if (existingGreeting) existingGreeting.remove();

                  if(document.body.firstChild) { // Attempt to insert before first child of body
                      document.body.insertBefore(greeting, document.body.firstChild);
                  } else { // Fallback if body has no children
                      document.body.appendChild(greeting);
                  }
              } else {
                  // Not logged in as an Admin
                  window.location.href = 'login.html'; 
                  const loggedOutHTML = `<a href="login.html"><button>Login</button></a>`;
                  if (authContainerDesktop) authContainerDesktop.innerHTML = loggedOutHTML;
                  if (authContainerMobile) authContainerMobile.innerHTML = loggedOutHTML;
              }
          } catch (err) {
              console.error('Session check failed, redirecting to login:', err);
              window.location.href = 'login.html'; 
              const authContainerDesktop = document.getElementById('authContainerDesktop');
              const authContainerMobile = document.getElementById('authContainerMobile');
              const loggedOutHTML = `<a href="login.html"><button>Login</button></a>`;
              if (authContainerDesktop) authContainerDesktop.innerHTML = loggedOutHTML;
              if (authContainerMobile) authContainerMobile.innerHTML = loggedOutHTML;
          }
      }

      window.logout = function() { // Make logout globally accessible
          fetch('/api/logout', { method: 'POST', credentials: 'include' })
              .then(() => {
                  const existingGreeting = document.querySelector('.welcome-greeting');
                  if (existingGreeting) existingGreeting.remove();
                  document.cookie = "userFirstName=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
                  window.location.href = 'login.html'; 
              });
      }

      checkSession();
      loadAllLessons(); // Initial load of lesson data

      const enableEditingBtn = document.getElementById('enable-editing-btn');
      if (enableEditingBtn) {
        enableEditingBtn.addEventListener('click', () => {
          document.querySelectorAll('.referral-select, .lesson-cost-input').forEach(el => {
            el.disabled = false; // enable editing
          });
          enableEditingBtn.disabled = true; // single‐use
          enableEditingBtn.textContent = 'Editing Enabled'; 
          checkGlobalInputChanges(); // Call after enabling to set initial state of save button
        });
      } else {
        console.warn('Enable Editing button not found on initial load.');
      }
  });
  </script>
</body>
</html>