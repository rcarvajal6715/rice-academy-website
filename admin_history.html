<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lesson History - Admin Portal - C2 Tennis Academy</title>

  <style>
    html, body { height: 100%; margin: 0; display: flex; flex-direction: column; font-family: Arial, sans-serif; }
    header, footer { background-color: #0c3c78; color: white; text-align: center; padding: 20px; }
    nav { background-color: #092e5e; display: flex; justify-content: center; }
    nav a { color: white; padding: 14px 20px; text-decoration: none; }
    nav a:hover { background-color: #0f4fa0; }
    section { flex: 1; padding: 40px 20px; max-width: 1400px; width: 90%; margin: auto; background: white; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    h2 { color: #0c3c78; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { padding: 8px; border:1px solid #ddd; }
    thead th { background: #0c3c78; color: white; }
    .edit-coaches-btn-history {
        background-color: #ffc107; /* Amber */
        color: black;
        padding: 5px 10px;
        border-radius: 4px;
        border: 1px solid #e0a800; /* Darker amber */
        cursor: pointer;
        font-size: 0.9em;
        margin-left: 5px; /* Space from delete button */
    }
    .edit-coaches-btn-history:hover { background-color: #e0a800; }

    /* Modal Styles (same as admin.html) */
    .modal {
      display: none; 
      position: fixed; 
      z-index: 1001; 
      left: 0;
      top: 0;
      width: 100%; 
      height: 100%; 
      overflow: auto; 
      background-color: rgba(0,0,0,0.4); 
    }
    .modal-content {
      background-color: #fefefe;
      margin: 10% auto; 
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
      max-width: 500px;
      border-radius: 8px;
      box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2),0 6px 20px 0 rgba(0,0,0,0.19);
    }
    .modal-header {
      padding: 10px 16px;
      background-color: #0c3c78;
      color: white;
      border-top-left-radius: 8px;
      border-top-right-radius: 8px;
    }
    .modal-header h2 {
      margin: 0;
      color: white;
    }
    .modal-body { padding: 15px; }
    .modal-footer {
      padding: 10px 16px;
      text-align: right;
    }
    .modal-footer button {
      width: auto;
      padding: 8px 15px;
      margin-left: 10px;
    }
    .modal-footer button.cancel-btn {
      background-color: #ccc;
      color: black;
    }
    .modal-footer button.cancel-btn:hover {
      background-color: #bbb;
    }
    #coach-checkboxes-container-history label { /* Unique ID for history page modal */
        display: block;
        margin-bottom: 8px;
        font-weight: normal;
        color: #333;
    }
    #coach-checkboxes-container-history input[type="checkbox"] { /* Unique ID */
        width: auto;
        margin-right: 8px;
        vertical-align: middle;
    }
    .session-info p { margin: 5px 0; }
    .session-info strong { color: #0c3c78; }

/* === Global Header & Navigation Styles (Finalized Version) === */
     header {
       background-color: #0c3c78; 
       color: white; 
       padding: 30px 20px; 
       position: relative; 
       text-align: center; 
     }
     .header-content { 
       display: flex; justify-content: center; align-items: center; 
       max-width: 1200px; margin: 0 auto;
       position: relative; 
     }
     .site-title { text-align: center; } 
     .site-title h1 { 
       font-size: 2.2em;    
       margin-top: 0;
       margin-bottom: 0; 
       color: white; 
     } 
     .site-title p { 
       font-size: 1em;    
       margin-top: 0;
       margin-bottom: 0;
       color: #f0f0f0;
     }
     
     .mobile-menu-toggle { display: none; background: none; border: none; color: white; font-size: 28px; cursor: pointer; padding: 5px; }
     nav.main-navigation { background-color: #092e5e; }
     .nav-wrapper-desktop { 
         display: flex; justify-content: center; align-items: center;
         width: 100%; max-width: 1200px; margin: 0 auto; padding: 0 20px; box-sizing: border-box;
     }
     ul.nav-links-desktop { list-style: none; margin: 0; padding: 0; display: flex; }
     ul.nav-links-desktop li a { color: white; padding: 14px 20px; text-decoration: none; display: block; } 
     ul.nav-links-desktop li a:hover { background-color: #0f4fa0; }
     ul.nav-links-desktop li a.highlighted-nav, ul.nav-links-desktop li a.current-page { 
        background-color: #d8f352; color: black; font-weight: bold; border-radius: 5px; 
     }
     ul.nav-links-desktop li a.highlighted-nav:hover, ul.nav-links-desktop li a.current-page:hover { background-color: #c1da3b; }
     
     .auth-buttons-desktop { 
       position: absolute;
       top: 20px; 
       right: 20px; 
       display: flex;
       align-items: center;
       gap: 15px; 
     }
     .auth-buttons-desktop a button, .auth-buttons-desktop button {
       background-color: white; color: #0c3c78; border: none; padding: 10px 20px; 
       border-radius: 5px; font-weight: bold; cursor: pointer;
       transition: all 0.3s ease; white-space: nowrap;
     }
     .auth-buttons-desktop a button:hover, .auth-buttons-desktop button:hover { background-color: #0f4fa0; color: white; }
     .mobile-menu-container {
       display: none; background-color: #092e5e; position: fixed;
       top: 0; left: 0; width: 100%; height: 100%;
       z-index: 1000; padding-top: 20px;
       box-sizing: border-box; overflow-y: auto; text-align: center;
     }
     nav.main-navigation.mobile-menu--open .mobile-menu-container { display: block; }
     .mobile-menu-close {
        display: block; 
        position: absolute; 
        top: 10px; 
        right: 10px; 
        left: auto; 
        bottom: auto; 
        background: none; 
        border: none; 
        color: white; 
        font-size: 28px; 
        cursor: pointer;
        z-index: 10; 
     }
     ul.nav-links-mobile { list-style: none; padding: 0; margin: 50px 0 20px; }
     ul.nav-links-mobile li a {
       color: white; padding: 15px 20px; text-decoration: none; display: block;
       border-bottom: 1px solid #0c3c78;
     }
     ul.nav-links-mobile li:last-child a { border-bottom: none; }
     ul.nav-links-mobile li a:hover { background-color: #0f4fa0; }
     .auth-buttons-mobile { padding: 20px; }
     .auth-buttons-mobile a button, .auth-buttons-mobile button {
       background-color: #d8f352; color: #0c3c78; border: none; padding: 12px 20px;
       border-radius: 5px; font-weight: bold; cursor: pointer; display: block;
       width: 80%; max-width: 250px; margin: 10px auto; box-sizing: border-box;
     }
     .auth-buttons-mobile a button:hover, .auth-buttons-mobile button:hover { background-color: #c1da3b; }
     
     footer { 
        background-color: #0c3c78; color: white; text-align: center; padding: 20px; margin-top:auto; 
     }

     @media (max-width: 768px) {
       body { -webkit-text-size-adjust: 100%; -ms-text-size-adjust: 100%; } 
       header { padding: 10px 15px; } 
       .header-content {
         justify-content: space-between; 
         width:100%; 
       }
       .site-title { text-align: left; }
       .site-title h1 { font-size: 1.2em; margin-bottom: 0; }
       .site-title p { display: none; } 
       .mobile-menu-toggle { display: block; }
       .nav-wrapper-desktop { display: none; }
       .auth-buttons-desktop { display: none; } 
       nav.main-navigation { padding: 0; background-color: transparent; }
      h2 {
        margin-bottom: 20px; 
      }
      section {
        padding: 20px 10px; 
      }
    }
ul.nav-links-desktop li a.highlighted-nav {
  border-radius: 9999px;
}
ul.nav-links-mobile li a.highlighted-nav {
  border-radius: 9999px;
}
ul.nav-links-desktop li a {
  border-radius: 9999px;
}
ul.nav-links-desktop li a.highlighted-nav {
  border-radius: 9999px;
}
ul.nav-links-mobile li a {
  border-radius: 9999px;
}

.explore-button {
  font-family: Arial, sans-serif;
  font-size: 1rem;
  font-weight: 400;
  background-color: #3b82f6; 
  color: white !important; 
  padding: 0.75rem 2rem;
  border: none;
  border-radius: 9999px; 
  box-shadow:
    0 10px 15px -3px rgba(0, 0, 0, 0.1),
    0   4px  6px -2px rgba(0, 0, 0, 0.05);
  cursor: pointer;
  transform-origin: center center;
  transition: background-color 0.2s ease, transform 0.2s ease;
  text-decoration: none; 
  display: inline-block; 
  text-align: center;
  margin-top: 30px; 
}

.explore-button:hover {
  background-color: #2563eb; 
  transform: scale(1.05);
  color: white !important;
  text-decoration: none;
}

.category-filter-button {
  background-color: #f0f0f0; 
  color: #333;            
  border: 1px solid #ccc;
  padding: 8px 15px;
  margin: 0 5px 10px 0; 
  border-radius: 5px;
  cursor: pointer;
  font-size: 0.9rem;
  transition: background-color 0.2s ease, color 0.2s ease;
}
.category-filter-button:hover {
  background-color: #e0e0e0; 
}
.category-filter-button.active-filter-button {
  background-color: #0c3c78; 
  color: white;
  border-color: #0c3c78;
  font-weight: bold;
}
#category-filters-title {
    margin-top: 20px;
    margin-bottom: 10px;
    font-weight: bold;
    color: #0c3c78; 
}
.update-payment-btn {
    background-color: #4CAF50; /* Green */
    color: white;
    padding: 5px 10px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9em;
}
.update-payment-btn:hover {
    background-color: #45a049;
}
  </style>
</head>
<body>

<header>
  <div class="header-content">
    <div class="site-title">
      <h1>Lesson History</h1> 
      <p>C2 Tennis Academy</p> 
    </div>
    <button class="mobile-menu-toggle" aria-label="Open navigation menu" aria-expanded="false" aria-controls="mainNavigation">
      &#9776; 
    </button>
  </div>
  <div class="auth-buttons-desktop" id="authContainerDesktop">
  </div>
</header>

<nav class="main-navigation" id="mainNavigation">
  <div class="nav-wrapper-desktop"> 
     <ul class="nav-links-desktop">
       <li><a href="index.html">Home</a></li>
       <li><a href="about.html">About</a></li>
       <li><a href="programs.html">Programs</a></li>
       <li><a href="schedule.html">Schedule</a></li>
       <li><a href="contact.html">Contact</a></li>
     </ul>
  </div>
  <div class="mobile-menu-container">
    <button class="mobile-menu-close" aria-label="Close navigation menu">&times;</button>
    <ul class="nav-links-mobile">
      <li><a href="index.html">Home</a></li>
      <li><a href="about.html">About</a></li>
      <li><a href="programs.html">Programs</a></li>
      <li><a href="schedule.html">Schedule</a></li>
      <li><a href="contact.html">Contact</a></li>
    </ul>
    <div class="auth-buttons-mobile" id="authContainerMobile">
    </div>
  </div>
</nav>

  <section>
    <h2>Past Lesson History</h2>
    <div style="margin-bottom: 20px; margin-top: 10px;">
      <label for="historySearchInput" style="margin-right: 10px; font-weight: bold;">Search Past Lessons:</label>
      <input type="text" id="historySearchInput" placeholder="Enter keyword (student, program, coach, email, date)..." style="width: 50%; padding: 8px;">
    </div>
    <div id="category-filters-title">Filters:</div>
    <div id="category-filters" style="margin-bottom: 20px;">
      <button class="category-filter-button active-filter-button" data-category="All">All</button>
      <button class="category-filter-button" data-category="Privates">Private Lessons</button>
      <button class="category-filter-button" data-category="Camps">Camps & Passes</button>
      <button class="category-filter-button" data-category="Clinics">Clinics & Other</button>
    </div>
    
    <button id="enable-history-editing-btn" style="margin-bottom:10px;">Enable Editing</button>
    <div style="text-align:right; margin-bottom: 5px;">
      <button id="save-history-btn" disabled>Save All History Changes</button>
    </div>
    
    <div id="past-lessons-table-container" style="margin-top: 20px;">
        <!-- The single table of past lessons will be rendered here by JavaScript -->
    </div>
  </section>

  <footer>
    <p>&copy; 2025 C2 Tennis Academy. All rights reserved.</p>
  </footer>

  <!-- Edit Coaches Modal (for History Page) -->
  <div id="editCoachesModalHistory" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Edit Coaches for Past Session</h2>
      </div>
      <div class="modal-body">
        <div class="session-info">
          <p><strong>Program:</strong> <span id="modalSessionProgramHistory"></span></p>
          <p><strong>Date:</strong> <span id="modalSessionDateHistory"></span></p>
          <p><strong>Time:</strong> <span id="modalSessionTimeHistory"></span></p>
        </div>
        <hr>
        <p><strong>Assign Coaches:</strong></p>
        <div id="coach-checkboxes-container-history">
          <!-- Coach checkboxes will be populated here -->
        </div>
        <input type="hidden" id="modalOriginalBookingIdsHistory">
        <input type="hidden" id="modalLessonCostHistory">
        <input type="hidden" id="modalStudentNameHistory">
        <input type="hidden" id="modalStudentEmailHistory">
        <input type="hidden" id="modalStudentPhoneHistory">
      </div>
      <div class="modal-footer">
        <button type="button" id="cancelEditCoachesBtnHistory" class="cancel-btn">Cancel</button>
        <button type="button" id="saveCoachesChangesBtnHistory">Save Changes</button>
      </div>
    </div>
  </div>

  <script>
  // This script block is intentionally left empty as the form-related JS was removed.
  // New JS logic will be added in the next script tag or by replacing this one.
  </script>

  <script>
// Corrected JavaScript logic provided by the user starts here
let allFetchedPastLessons = []; 
let activeCategoryFilter = 'All'; 
let editing = false; 

let enableHistoryEditingBtn;
let saveHistoryBtn;
let historyTableContainer; 
let bulkUpdateButton; // Added for the new bulk update button

function formatTime_12hr(timeStr) {
  if (!timeStr || !timeStr.includes(':')) { return timeStr; }
  const parts = timeStr.split(':');
  let hours = parseInt(parts[0], 10);
  const minutes = parseInt(parts[1], 10);
  const ampm = hours >= 12 ? 'PM' : 'AM';
  hours = hours % 12;
  hours = hours ? hours : 12; 
  const minutesStr = minutes < 10 ? '0' + minutes : minutes;
  return hours + ':' + minutesStr + ' ' + ampm;
}

function renderPastLessonsTable(lessonsArray, containerId, placeholderMessage) {
  const container = document.getElementById(containerId);
  if (!container) {
    console.error('ADMIN_HISTORY: Container not found for ID:', containerId);
    return;
  }
  console.log('ADMIN_HISTORY: Rendering lessons. Count:', lessonsArray.length, 'First lesson:', lessonsArray[0]);

  if (lessonsArray.length === 0) {
    container.innerHTML = `<p>${placeholderMessage}</p>`;
    return;
  }

  let tableHTML = `
    <table style="width:100%; border-collapse:collapse; margin-top:10px;">
      <thead>
        <tr style="background:#0c3c78; color:white;">
          <th style="padding:8px; border:1px solid #ddd;"><input type="checkbox" id="selectAllHistoryRows"></th>
          <th style="padding:8px; border:1px solid #ddd;">Program</th>
          <th style="padding:8px; border:1px solid #ddd;">Coach</th>
          <th style="padding:8px; border:1px solid #ddd;">Date</th>
          <th style="padding:8px; border:1px solid #ddd;">Time</th>
          <th style="padding:8px; border:1px solid #ddd;">Student</th>
          <th style="padding:8px; border:1px solid #ddd;">Email</th>
          <th style="padding:8px; border:1px solid #ddd;">Phone</th>
          <th style="padding:8px; border:1px solid #ddd;">Lesson Cost</th>
          <th style="padding:8px; border:1px solid #ddd;">Referral Source</th>
          <th style="padding:8px; border:1px solid #ddd;">Paid</th>
          <th style="padding:8px; border:1px solid #ddd;">Actions</th>
        </tr>
      </thead>
      <tbody>
  `;

  lessonsArray.forEach(les => {
    const isGroupedCamp = les.coaches && Array.isArray(les.coaches);
    const displayId = isGroupedCamp ? (les.booking_ids ? les.booking_ids.join(',') : (les.id || 'group')) : les.id;
    const firstBookingId = isGroupedCamp ? (les.booking_ids ? les.booking_ids[0] : null) : les.id;


    const dateStr = les.date ? new Date(les.date).toLocaleDateString() : 'N/A';
    const formattedTime = les.time ? formatTime_12hr(les.time) : 'N/A';
    const originalDate = les.date ? (typeof les.date === 'string' ? les.date.substring(0,10) : '') : '';
    
    // For grouped camps, some fields might be from the first lesson or N/A
    const programDisplay = les.program || '—';
    const coachDisplay = isGroupedCamp ? les.coaches.join(', ') : (les.coach || '—');
    const studentDisplay = isGroupedCamp ? 'N/A' : (les.student || '—');
    const emailDisplay = isGroupedCamp ? 'N/A' : (les.email || '—');
    const phoneDisplay = isGroupedCamp ? 'N/A' : (les.phone || '—');
    const costDisplay = isGroupedCamp ? (les.lesson_cost !== null && les.lesson_cost !== undefined ? les.lesson_cost : 'N/A') : (les.lesson_cost !== null && les.lesson_cost !== undefined ? les.lesson_cost : '');
    const referralDisplay = isGroupedCamp ? 'N/A' : (les.referral_source || '—');
    // Paid status for a group: Display from first booking or 'N/A' if ambiguous. For simplicity, using first booking's status or false.
    const paidStatus = isGroupedCamp ? (les.paid === true || String(les.paid).toLowerCase() === 'true') : (les.paid === true || String(les.paid).toLowerCase() === 'true');
    const paidDisplay = paidStatus ? 'Yes' : 'No';

    tableHTML += `
      <tr data-id="${displayId}">
        <td style="padding:8px; border:1px solid #ddd;"><input type="checkbox" class="history-row-checkbox" data-id="${displayId}"></td>
        <td class="history-cell" data-id="${firstBookingId}" data-field="program" data-original-value="${les.program || ''}" data-is-grouped="${isGroupedCamp}" style="padding:8px; border:1px solid #ddd;">${programDisplay}</td>
        <td class="history-cell" data-id="${firstBookingId}" data-field="coach" data-original-value="${isGroupedCamp ? les.coaches.join(',') : (les.coach || '')}" data-is-grouped="${isGroupedCamp}" style="padding:8px; border:1px solid #ddd;">${coachDisplay}</td>
        <td class="history-cell" data-id="${firstBookingId}" data-field="date" data-original-value="${originalDate}" data-is-grouped="${isGroupedCamp}" style="padding:8px; border:1px solid #ddd;">${dateStr}</td>
        <td class="history-cell" data-id="${firstBookingId}" data-field="time" data-original-value="${les.time || ''}" data-is-grouped="${isGroupedCamp}" style="padding:8px; border:1px solid #ddd;">${formattedTime}</td>
        <td class="history-cell" data-id="${firstBookingId}" data-field="student" data-original-value="${les.student || ''}" data-is-grouped="${isGroupedCamp}" style="padding:8px; border:1px solid #ddd;">${studentDisplay}</td>
        <td style="padding:8px; border:1px solid #ddd;">${emailDisplay}</td>
        <td style="padding:8px; border:1px solid #ddd;">${phoneDisplay}</td>
        <td class="history-cell" data-id="${firstBookingId}" data-field="lesson_cost" data-original-value="${les.lesson_cost !== null && les.lesson_cost !== undefined ? les.lesson_cost : ''}" data-is-grouped="${isGroupedCamp}" style="padding:8px; border:1px solid #ddd;">${costDisplay}</td>
        <td class="history-cell" data-id="${firstBookingId}" data-field="referral_source" data-original-value="${isGroupedCamp ? '' : (les.referral_source || '—')}" data-is-grouped="${isGroupedCamp}" style="padding:8px; border:1px solid #ddd;">${referralDisplay}</td>
        <td class="history-cell" data-id="${firstBookingId}" data-field="paid" data-original-value="${String(paidStatus)}" data-is-grouped="${isGroupedCamp}" style="padding:8px; border:1px solid #ddd;">${paidDisplay}</td>
        <td style="padding:8px; border:1px solid #ddd;">`;
          if (isGroupedCamp) {
            tableHTML += `<button onclick="deleteGroupedCampLessonHistory('${les.booking_ids.join(',')}')">Delete Session</button>`;
            tableHTML += `<button class="edit-coaches-btn-history" 
                                  data-program="${les.program}" 
                                  data-date="${originalDate}" 
                                  data-time="${les.time || ''}" 
                                  data-booking-ids="${les.booking_ids.join(',')}" 
                                  data-coaches="${les.coaches.join(',')}">Edit Coaches</button>`;
          } else {
            tableHTML += `<button onclick="deleteAdminLesson(${les.id})">Delete</button>`;
          }
    tableHTML += `</td></tr>`;
  });
  tableHTML += `</tbody></table>`;
  container.innerHTML = tableHTML;


  const selectAllCheckbox = document.getElementById('selectAllHistoryRows');
  if (selectAllCheckbox) {
    selectAllCheckbox.addEventListener('change', (event) => {
      document.querySelectorAll('.history-row-checkbox').forEach(checkbox => {
        checkbox.checked = event.target.checked;
      });
      if (bulkUpdateButton) bulkUpdateButton.disabled = !event.target.checked && !Array.from(document.querySelectorAll('.history-row-checkbox')).some(cb => cb.checked);
    });
  }

  document.querySelectorAll('.history-row-checkbox').forEach(checkbox => {
    checkbox.addEventListener('change', () => {
        if (bulkUpdateButton) {
            const anyChecked = Array.from(document.querySelectorAll('.history-row-checkbox')).some(cb => cb.checked);
            bulkUpdateButton.disabled = !anyChecked;
        }
        if (selectAllCheckbox && !checkbox.checked) {
            selectAllCheckbox.checked = false;
        }
    });
  });
}

async function loadHistory() {
  if (!historyTableContainer) historyTableContainer = document.getElementById('past-lessons-table-container');
  historyTableContainer.innerHTML = '<p>Loading history...</p>';
  
  const campLikePrograms = ["Summer Camp / Group Lessons", "High Performance Training", "Adult Clinics"];

  try {
    const res = await fetch('/api/admin/lessons', { credentials: 'include' });
    if (!res.ok) {
      historyTableContainer.innerHTML = '<p style="color:red;">Could not load lesson history data.</p>';
      return;
    }
    const lessons = await res.json();
    const now = new Date();
    
    const rawPastLessons = lessons.filter(les => {
      if (!les.date) return false;
      const dateStr = typeof les.date === 'string' && les.date.length >=10 ? les.date.substring(0, 10) : null;
      if (!dateStr) return false;
      const dateParts = dateStr.split('-');
      if (dateParts.length !== 3) return false;
      
      const year = parseInt(dateParts[0]);
      const month = parseInt(dateParts[1]) - 1;
      const day = parseInt(dateParts[2]);
      let hours = 23, minutes = 59, seconds = 59; // Default to end of day for past lessons
      if (les.time) {
        const timeParts = les.time.split(':');
        if (timeParts.length >= 2) {
          hours = parseInt(timeParts[0]);
          minutes = parseInt(timeParts[1]);
          seconds = timeParts[2] ? parseInt(timeParts[2]) : 0;
        }
      }
      try {
        const lessonDate = new Date(year, month, day, hours, minutes, seconds);
        if (isNaN(lessonDate.getTime())) return false;
        return lessonDate < now;
      } catch (e) {
        console.error(`ADMIN_HISTORY: Error parsing date for lesson: ${les.id}`, e);
        return false;
      }
    });

    // Group camp-like lessons
    const groupedPastCampLessons = {};
    const otherPastLessons = [];

    rawPastLessons.forEach(les => {
        const programName = les.program;
        if (campLikePrograms.includes(programName)) {
            const groupKey = `${programName}-${les.date}-${les.time}`;
            if (!groupedPastCampLessons[groupKey]) {
                groupedPastCampLessons[groupKey] = {
                    ...les, // Base details from the first lesson in group
                    coaches: [les.coach].filter(c => c), // Filter out null/empty coaches
                    booking_ids: [les.id],
                    // isGrouped: true // Mark as grouped
                };
            } else {
                if (les.coach && !groupedPastCampLessons[groupKey].coaches.includes(les.coach)) {
                    groupedPastCampLessons[groupKey].coaches.push(les.coach);
                }
                groupedPastCampLessons[groupKey].booking_ids.push(les.id);
            }
        } else {
            otherPastLessons.push(les);
        }
    });
    
    allFetchedPastLessons = [...Object.values(groupedPastCampLessons), ...otherPastLessons];
    // Sort all lessons by date and time after processing
    allFetchedPastLessons.sort((a,b) => {
        const dateA = new Date(a.date + (a.time ? 'T' + a.time : 'T00:00:00'));
        const dateB = new Date(b.date + (b.time ? 'T' + b.time : 'T00:00:00'));
        return dateB - dateA; // Descending order (most recent first)
    });

    console.log('ADMIN_HISTORY: All fetched past lessons (processed, grouped):', allFetchedPastLessons.length);
    filterAndRenderHistory(''); // Initial render with all (processed) past lessons

  } catch (error) {
    console.error('ADMIN_HISTORY: Error loading lesson history:', error);
    historyTableContainer.innerHTML = '<p style="color:red;">Failed to load history due to a network error.</p>';
  }
}


async function deleteGroupedCampLessonHistory(bookingIdsString) {
    console.log("ADMIN_HISTORY: Attempting to delete grouped past camp session with Booking IDs:", bookingIdsString);
    const bookingIds = bookingIdsString.split(',');
    if (!confirm(`Are you sure you want to delete this entire past camp session? This will delete ${bookingIds.length} booking(s) from history. This action cannot be undone.`)) {
        return;
    }
    try {
        let allSucceeded = true;
        for (const id of bookingIds) {
            const res = await fetch(`/api/admin/lessons/${id}`, {
                method: 'DELETE',
                credentials: 'include'
            });
            if (!res.ok) {
                allSucceeded = false;
                console.error(`ADMIN_HISTORY: Failed to delete booking ID ${id}: ${await res.text()}`);
            }
        }
        if (allSucceeded) {
            alert('Entire past camp session deleted successfully.');
        } else {
            alert('Some bookings in the past camp session could not be deleted. Please check the console and refresh.');
        }
    } catch (err) {
        alert('An error occurred while trying to delete the past camp session. Check console.');
        console.error('ADMIN_HISTORY: Error in deleteGroupedCampLessonHistory:', err);
    }
    loadHistory(); // Refresh
}

async function deleteAdminLesson(id) {
  if (!confirm('Are you sure you want to delete this lesson?')) return;
  try {
    const res = await fetch(`/api/admin/lessons/${id}`, { method: 'DELETE', credentials: 'include' });
    if (res.ok) {
      loadHistory();
    } else {
      alert('Delete failed: ' + await res.text());
    }
  } catch (err) {
    console.error('Error deleting lesson:', err);
    alert('Delete failed due to a network error.');
  }
}

function filterAndRenderHistory(searchTerm) {
  let searchFilteredLessons;
  if (!searchTerm) {
    searchFilteredLessons = [...allFetchedPastLessons];
  } else {
    searchFilteredLessons = allFetchedPastLessons.filter(les => {
      if (!les) return false;
      const dateStr = les.date ? new Date(les.date).toLocaleDateString().toLowerCase() : '';
      // For grouped lessons, check if any coach in the array matches
      const coachMatch = (les.coaches && Array.isArray(les.coaches)) 
        ? les.coaches.some(c => c && String(c).toLowerCase().includes(searchTerm))
        : (les.coach && String(les.coach).toLowerCase().includes(searchTerm));

      return [les.program, les.student, les.email, les.phone, dateStr]
        .some(field => field && String(field).toLowerCase().includes(searchTerm)) || coachMatch;
    });
  }

  let finalDisplayLessons;
  if (activeCategoryFilter === 'All') {
    finalDisplayLessons = [...searchFilteredLessons];
  } else {
    finalDisplayLessons = searchFilteredLessons.filter(les => {
      if (!les || !les.program) return false;
      const programName = les.program.toLowerCase();
      if (activeCategoryFilter === 'Privates') return programName.includes('private');
      if (activeCategoryFilter === 'Camps') return programName.includes('camp') || programName.includes('pass');
      if (activeCategoryFilter === 'Clinics') return programName.includes('clinic') || programName.includes('high performance');
      return false;
    });
  }
  renderPastLessonsTable(finalDisplayLessons, 'past-lessons-table-container', 'No matching past lessons found.');
}

window.addEventListener('DOMContentLoaded', () => {
  enableHistoryEditingBtn = document.getElementById('enable-history-editing-btn');
  saveHistoryBtn = document.getElementById('save-history-btn');
  historyTableContainer = document.getElementById('past-lessons-table-container');
  // bulkUpdateButton = document.getElementById('bulkUpdateButton'); // This ID was for a generic bulk update, not used here.

  // --- Edit Coaches Modal Logic for History Page ---
  const editCoachesModalHistory = document.getElementById('editCoachesModalHistory');
  const cancelEditCoachesBtnHistory = document.getElementById('cancelEditCoachesBtnHistory');
  const saveCoachesChangesBtnHistory = document.getElementById('saveCoachesChangesBtnHistory');
  const coachCheckboxesContainerHistory = document.getElementById('coach-checkboxes-container-history');
  
  const availableCoachesForHistoryModal = [ // Same list as admin.html for consistency
      "Ricardo Carvajalino", "Jacob Capone", "Zach Capone", "Matthew Abbey", "Paula Carvajalino"
  ];

  if (coachCheckboxesContainerHistory) {
    availableCoachesForHistoryModal.forEach(coachName => {
        const label = document.createElement('label');
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.name = 'modalCoachHistory';
        checkbox.value = coachName;
        label.appendChild(checkbox);
        label.appendChild(document.createTextNode(` ${coachName}`));
        coachCheckboxesContainerHistory.appendChild(label);
    });
  } else {
    console.warn("ADMIN_HISTORY: coach-checkboxes-container-history not found.");
  }
  
  if (historyTableContainer) {
    historyTableContainer.addEventListener('click', async (event) => {
        if (event.target.classList.contains('edit-coaches-btn-history')) {
            const button = event.target;
            const program = button.dataset.program;
            const date = button.dataset.date; // YYYY-MM-DD
            const time = button.dataset.time; // HH:MM:SS or HH:MM
            const originalBookingIds = button.dataset.bookingIds.split(',').map(Number);
            const currentCoaches = button.dataset.coaches.split(',');

            // For history, lesson_cost should be part of the 'les' object used for rendering.
            // Attempt to find the full lesson object from `allFetchedPastLessons` to get lesson_cost
            // This is a simplified lookup; more robust would be to find by a unique group identifier if available
            const originalGroupData = allFetchedPastLessons.find(l => 
                l.program === program && 
                (l.date.startsWith(date) || l.date === date) && // Match YYYY-MM-DD from potentially YYYY-MM-DDTHH...
                l.time === time && 
                JSON.stringify(l.booking_ids) === JSON.stringify(originalBookingIds)
            );
            const lessonCost = originalGroupData ? originalGroupData.lesson_cost : 0;
            const studentName = originalGroupData ? (originalGroupData.student || '') : '';
            const studentEmail = originalGroupData ? (originalGroupData.email || '') : '';
            const studentPhone = originalGroupData ? (originalGroupData.phone || '') : '';


            document.getElementById('modalSessionProgramHistory').textContent = program;
            document.getElementById('modalSessionDateHistory').textContent = new Date(date + 'T00:00:00').toLocaleDateString(); // Ensure correct date parsing for display
            document.getElementById('modalSessionTimeHistory').textContent = formatTime_12hr(time);

            editCoachesModalHistory.dataset.program = program;
            editCoachesModalHistory.dataset.date = date; // YYYY-MM-DD
            editCoachesModalHistory.dataset.time = time; 
            document.getElementById('modalOriginalBookingIdsHistory').value = JSON.stringify(originalBookingIds);
            document.getElementById('modalLessonCostHistory').value = lessonCost;
            document.getElementById('modalStudentNameHistory').value = studentName;
            document.getElementById('modalStudentEmailHistory').value = studentEmail;
            document.getElementById('modalStudentPhoneHistory').value = studentPhone;

            coachCheckboxesContainerHistory.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                cb.checked = currentCoaches.includes(cb.value);
            });
            editCoachesModalHistory.style.display = 'block';
        }
    });
  } else {
      console.warn("ADMIN_HISTORY: past-lessons-table-container not found for modal delegation.");
  }

  if(cancelEditCoachesBtnHistory) {
    cancelEditCoachesBtnHistory.onclick = () => {
        editCoachesModalHistory.style.display = 'none';
    }
  }

  if(saveCoachesChangesBtnHistory) {
    saveCoachesChangesBtnHistory.onclick = async () => {
        const newSelectedCoaches = [];
        coachCheckboxesContainerHistory.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => {
            newSelectedCoaches.push(cb.value);
        });

        const payload = {
            program: editCoachesModalHistory.dataset.program,
            date: editCoachesModalHistory.dataset.date,
            time: editCoachesModalHistory.dataset.time,
            originalBookingIds: JSON.parse(document.getElementById('modalOriginalBookingIdsHistory').value),
            newCoaches: newSelectedCoaches,
            lesson_cost: parseFloat(document.getElementById('modalLessonCostHistory').value),
            student: document.getElementById('modalStudentNameHistory').value,
            email: document.getElementById('modalStudentEmailHistory').value,
            phone: document.getElementById('modalStudentPhoneHistory').value
        };

        try {
            const res = await fetch('/api/admin/lessons/update-coaches', { // Same endpoint
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Credentials': 'include' },
                body: JSON.stringify(payload)
            });
            const responseData = await res.json();
            if (res.ok) {
                alert(responseData.message || 'Coaches updated successfully for past session!');
                editCoachesModalHistory.style.display = 'none';
                loadHistory(); // Refresh history table
            } else {
                alert('Failed to update coaches for past session: ' + (responseData.message || 'Unknown error'));
            }
        } catch (err) {
            console.error('ADMIN_HISTORY: Error saving coach changes for past session:', err);
            alert('An error occurred while saving changes for the past session. See console.');
        }
    }
  }
  
  // Close modal if user clicks outside of it
  window.onclick = (event) => {
      if (event.target == editCoachesModalHistory) {
          editCoachesModalHistory.style.display = "none";
      }
  }
  // --- End Edit Coaches Modal Logic for History Page ---


  // The bulkUpdateButton was for a generic idea, not used in this specific flow.
  // if(bulkUpdateButton) {
  //   bulkUpdateButton.disabled = true; // Initially disabled
  // ... (rest of bulkUpdateButton logic if it were to be used)
  // }


  loadHistory();

  if (enableHistoryEditingBtn) {
    bulkUpdateButton.addEventListener('click', async () => {
        const selectedIds = Array.from(document.querySelectorAll('.history-row-checkbox:checked')).map(cb => cb.dataset.id);
        if(selectedIds.length === 0) {
            alert('No lessons selected for bulk update.');
            return;
        }
        // Placeholder for bulk update action type
        const actionType = prompt("Enter action type for selected lessons (e.g., 'markPaid', 'archive'):");
        if (!actionType) {
            alert('No action specified.');
            return;
        }
        alert(`Bulk updating ${selectedIds.length} lessons with action: ${actionType}. IDs: ${selectedIds.join(', ')}.\n(Actual update logic not yet implemented)`);
        // Example: await bulkUpdateLessons(selectedIds, actionType);
        // After action, potentially reload history or update UI
        // loadHistory(); 
        // document.getElementById('selectAllHistoryRows').checked = false; // Uncheck select all
        // bulkUpdateButton.disabled = true; // Disable button again
    });
  }


  loadHistory();

  if (enableHistoryEditingBtn) {
    enableHistoryEditingBtn.addEventListener('click', () => {
      editing = !editing;
      enableHistoryEditingBtn.textContent = editing ? 'Disable Editing' : 'Enable Editing';
      if (saveHistoryBtn) saveHistoryBtn.disabled = !editing;

      document.querySelectorAll('.history-cell').forEach(td => {
        if (td.dataset.field === 'referral_source') {
          td.contentEditable = false; // Referral source is always a select in edit mode
          if (editing) {
            // For grouped camps, referral source editing might be disabled or handled differently.
            // This example assumes it's disabled for grouped rows by not making the cell editable.
            // If td.dataset.isGrouped is true, this part might be skipped or adapted.
            if (td.dataset.isGrouped === 'true') {
                td.innerHTML = 'N/A'; // Or keep original display 'N/A'
                return; // Skip making select for grouped
            }
            const originalValue = td.dataset.originalValue === '—' ? '' : td.dataset.originalValue;
            td.innerHTML = '';
            const selectEl = document.createElement('select');
            selectEl.className = 'history-referral-select';
            const options = [
                { value: '', text: 'None' }, 
                { value: 'Ricardo', text: 'Referred by Ricardo' },
                { value: 'Jacob', text: 'Jacob - Own Booking' },
                { value: 'Paula', text: 'Paula - Own Booking' },
                { value: 'Zach', text: 'Zach - Own Booking' },
                { value: 'RicardoOwn', text: 'Ricardo - Teaches Himself' }
            ];
            options.forEach(opt => {
              const optionEl = document.createElement('option');
              optionEl.value = opt.value;
              optionEl.textContent = opt.text;
              if (opt.value === originalValue) optionEl.selected = true;
              selectEl.appendChild(optionEl);
            });
            td.appendChild(selectEl);
          } else { // When disabling editing
            const selectEl = td.querySelector('select.history-referral-select');
            if (selectEl) {
              const selectedText = selectEl.options[selectEl.selectedIndex]?.text || selectEl.value;
              td.innerHTML = ''; // Clear the select
              td.textContent = selectedText || '—';
            } else if (td.dataset.isGrouped === 'true') {
              td.textContent = 'N/A'; // Keep N/A for grouped if it was that
            }
            // For other cells, their content is already their text, no change needed on disabling editing here.
          }
        } else { // For other editable cells (not referral_source)
            if (td.dataset.isGrouped === 'true' && (fieldName === 'coach' || fieldName === 'student' || fieldName === 'lesson_cost' || fieldName === 'paid')) {
                 td.contentEditable = false; // These fields are not directly editable for grouped items
            } else {
                 td.contentEditable = editing;
            }
          if (!editing) td.blur();
        }
      });
    });
  }

  if (saveHistoryBtn) {
    saveHistoryBtn.addEventListener('click', async () => {
      if (!confirm('Are you sure you want to save all changes to the history?')) return;
      if (enableHistoryEditingBtn) enableHistoryEditingBtn.disabled = true;
      saveHistoryBtn.disabled = true;

      const updates = [];
      document.querySelectorAll('.history-cell[data-id]').forEach(td => {
        const isGroupedCell = td.dataset.isGrouped === 'true';
        // Skip direct editing for certain fields if it's a grouped representation
        if (isGroupedCell && (td.dataset.field === 'coach' || td.dataset.field === 'student' || td.dataset.field === 'lesson_cost' || td.dataset.field === 'referral_source' || td.dataset.field === 'paid')) {
            // These fields are not meant to be directly edited on the grouped row via contentEditable.
            // Coach editing is via "Edit Coaches" button. Others are N/A or derived.
            return; 
        }

        const bookingId = td.dataset.id; // This is firstBookingId for grouped, actual ID for others
        const fieldName = td.dataset.field;
        const originalValue = td.dataset.originalValue;
        let newValue;
        let changed = false;

        if (fieldName === 'referral_source' && !isGroupedCell) {
          const selectEl = td.querySelector('select.history-referral-select');
          if (selectEl) {
            newValue = selectEl.value;
            const normalizedOriginalValue = originalValue === '—' ? '' : originalValue;
            if (newValue !== normalizedOriginalValue) changed = true;
          }
        } else if (td.contentEditable === 'true') { // Standard contentEditable fields
          newValue = td.innerText.trim();
          if (fieldName === 'time') {
            if (newValue === '' || newValue.toLowerCase() === 'n/a') newValue = null;
          } else if (fieldName === 'coach' || fieldName === 'program' || fieldName === 'student') {
            if (newValue === '' || newValue.toLowerCase() === 'null') newValue = null;
          } else if (fieldName === 'date' && td.innerText.includes('/')) {
            const parts = newValue.split('/');
            if (parts.length === 3) newValue = `${parts[2]}-${parts[0].padStart(2, '0')}-${parts[1].padStart(2, '0')}`;
          } else if (fieldName === 'lesson_cost') {
            newValue = newValue.replace('$', '').trim();
            if (newValue === '' && originalValue !== '') newValue = null; 
            else if (newValue !== '' && isNaN(Number(newValue))) {
                console.warn(`ADMIN_HISTORY: Invalid cost for booking ${bookingId}: ${newValue}. Skipping.`);
                return; 
            }
          } else if (fieldName === 'paid') {
            const lowerNewValue = newValue.toLowerCase();
            if (lowerNewValue === 'yes' || lowerNewValue === 'true') newValue = true;
            else if (lowerNewValue === 'no' || lowerNewValue === 'false') newValue = false;
          }
          if (String(newValue) !== String(originalValue)) changed = true; // Compare as strings to handle type differences like boolean vs "true"
        }

        if (changed) {
          updates.push({ bookingId, fieldName, newValue });
        }
      });

      if (updates.length === 0) {
        alert('No actual changes detected to save.');
        if (enableHistoryEditingBtn) enableHistoryEditingBtn.disabled = false;
        if (editing) saveHistoryBtn.disabled = false;
        else saveHistoryBtn.disabled = true;
        return;
      }

      let successes = 0;
      let failures = 0;
      const failureDetails = [];

      for (const upd of updates) {
        try {
          const res = await fetch(`/api/admin/history/${upd.bookingId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json', 'Credentials': 'include' },
            body: JSON.stringify({ field: upd.fieldName, value: upd.newValue })
          });
          if (res.ok) {
            successes++;
          } else {
            failures++;
            const errData = await res.json().catch(() => ({ message: `Update failed for ID ${upd.bookingId}, Field ${upd.fieldName} with status ${res.status}` }));
            failureDetails.push(errData.message || `Failed for ${upd.fieldName}`);
          }
        } catch (networkError) {
          failures++;
          failureDetails.push(`Network error for ID ${upd.bookingId}, Field ${upd.fieldName}: ${networkError.message}`);
        }
      }

      let summaryMessage = `${successes} updates successful.`;
      if (failures > 0) summaryMessage += `\n${failures} updates failed.\nDetails:\n${failureDetails.join('\n')}`;
      alert(summaryMessage);

      editing = false;
      if (enableHistoryEditingBtn) {
        enableHistoryEditingBtn.disabled = false;
        enableHistoryEditingBtn.textContent = 'Enable Editing';
      }
      if (saveHistoryBtn) saveHistoryBtn.disabled = true;
      document.querySelectorAll('.history-cell').forEach(cell => cell.contentEditable = false);
      loadHistory();
    });
  }

  const bulkCostUpdateButton = document.querySelector('.bulk-update-costs-btn');
  if (bulkCostUpdateButton) {
    // This button seems to be for a different bulk update type (costs from inputs, not general actions)
    // Its existing logic (handleBulkUpdatePrices) should be preserved if it's still meant to function.
    // For now, I'm assuming its event listener setup is separate or handled by its own function.
    // If it was meant to be the `bulkUpdateButton` for checkbox actions, this needs clarification.
    // The original prompt mentioned adding a new button with ID "bulkUpdateButton".
    // The existing button with class "bulk-update-costs-btn" might be different.
    // The provided code has `bulkUpdateButton = document.getElementById('bulkUpdateButton');`
    // and its event listener. The `handleBulkUpdatePrices` and its button seems distinct.
  }

  const searchInput = document.getElementById('historySearchInput');
  if (searchInput) {
    searchInput.addEventListener('input', () => {
      filterAndRenderHistory(searchInput.value.toLowerCase().trim());
    });
  }

  const filterButtons = document.querySelectorAll('#category-filters .category-filter-button');
  filterButtons.forEach(button => {
    button.addEventListener('click', () => {
      activeCategoryFilter = button.getAttribute('data-category');
      filterButtons.forEach(btn => btn.classList.remove('active-filter-button'));
      button.classList.add('active-filter-button');
      filterAndRenderHistory(searchInput ? searchInput.value.toLowerCase().trim() : '');
    });
  });
});
// Corrected JavaScript logic provided by the user ends here
</script>
  <script>
  // This entire block is for mobile menu and session management, remains unchanged.
  document.addEventListener('DOMContentLoaded', () => {
      const menuToggle = document.querySelector('.mobile-menu-toggle');
      const mobileMenuClose = document.querySelector('.mobile-menu-close');
      const mainNav = document.querySelector('nav.main-navigation');

      if (menuToggle && mainNav && mobileMenuClose) {
          menuToggle.addEventListener('click', () => {
              const isMenuOpen = mainNav.classList.toggle('mobile-menu--open');
              menuToggle.setAttribute('aria-expanded', isMenuOpen);
              if (isMenuOpen) {
                  menuToggle.innerHTML = '&times;'; 
                  menuToggle.setAttribute('aria-label', 'Close navigation menu');
              } else {
                  menuToggle.innerHTML = '&#9776;'; 
                  menuToggle.setAttribute('aria-label', 'Open navigation menu');
              }
          });
          mobileMenuClose.addEventListener('click', () => {
              mainNav.classList.remove('mobile-menu--open');
              if (menuToggle) {
                 menuToggle.setAttribute('aria-expanded', 'false');
                 menuToggle.innerHTML = '&#9776;'; 
                 menuToggle.setAttribute('aria-label', 'Open navigation menu');
              }
          });
      }
      const mobileNavLinks = document.querySelectorAll('.mobile-menu-container a');
      if (mainNav && mobileNavLinks.length > 0) {
          mobileNavLinks.forEach(link => {
              link.addEventListener('click', () => {
                  if (mainNav.classList.contains('mobile-menu--open')) {
                      mainNav.classList.remove('mobile-menu--open');
                      if (menuToggle) {
                          menuToggle.setAttribute('aria-expanded', 'false');
                          menuToggle.innerHTML = '&#9776;';
                          menuToggle.setAttribute('aria-label', 'Open navigation menu');
                      }
                  }
              });
          });
      }
      async function checkSession() {
          const existingGreeting = document.querySelector('.welcome-greeting');
          if (existingGreeting) existingGreeting.remove();
          try {
              const res = await fetch('/api/check-session', { credentials: 'include' });
              const data = await res.json(); 
              const authContainerDesktop = document.getElementById('authContainerDesktop');
              const authContainerMobile = document.getElementById('authContainerMobile');
              if (data && data.loggedIn === true && data.isAdmin === true) {
                  const portalButtonText = data.firstName ? 'Admin (' + data.firstName + ')' : 'Admin Portal';
                  const loggedInHTML = '<a href="admin.html"><button>' + portalButtonText + '</button></a><button onclick="logout()">Logout</button>';
                  const loggedInMobileHTML = loggedInHTML; 
                  if (authContainerDesktop) authContainerDesktop.innerHTML = loggedInHTML;
                  if (authContainerMobile) authContainerMobile.innerHTML = loggedInMobileHTML;
                  const welcomeMessageText = data.firstName ? 'Welcome, ' + data.firstName + '!' : 'Welcome, Admin!';
                  const greeting = document.createElement('div');
                  greeting.className = 'welcome-greeting';
                  greeting.textContent = welcomeMessageText;
                  greeting.style.cssText = 'background:#0c3c78;color:white;padding:10px;text-align:center;font-weight:bold;';
                  const existingGreeting = document.querySelector('.welcome-greeting');
                  if (existingGreeting) existingGreeting.remove();
                  if(document.body.firstChild) { 
                      document.body.insertBefore(greeting, document.body.firstChild);
                  } else { 
                      document.body.appendChild(greeting);
                  }
              } else {
                  window.location.href = 'login.html'; 
                  const loggedOutHTML = `<a href="login.html"><button>Login</button></a>`;
                  if (authContainerDesktop) authContainerDesktop.innerHTML = loggedOutHTML;
                  if (authContainerMobile) authContainerMobile.innerHTML = loggedOutHTML;
              }
          } catch (err) {
              console.error('Session check failed, redirecting to login:', err);
              window.location.href = 'login.html'; 
              const authContainerDesktop = document.getElementById('authContainerDesktop');
              const authContainerMobile = document.getElementById('authContainerMobile');
              const loggedOutHTML = `<a href="login.html"><button>Login</button></a>`;
              if (authContainerDesktop) authContainerDesktop.innerHTML = loggedOutHTML;
              if (authContainerMobile) authContainerMobile.innerHTML = loggedOutHTML;
          }
      }
      window.logout = function() { 
          fetch('/api/logout', { method: 'POST', credentials: 'include' })
              .then(() => {
                  const existingGreeting = document.querySelector('.welcome-greeting');
                  if (existingGreeting) existingGreeting.remove();
                  document.cookie = "userFirstName=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
                  window.location.href = 'login.html'; 
              });
      }
      checkSession(); 
  });
  </script>
</body>
</html>