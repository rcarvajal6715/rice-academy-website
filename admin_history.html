<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lesson History - Admin Portal - C2 Tennis Academy</title>

  <style>
    html, body { height: 100%; margin: 0; display: flex; flex-direction: column; font-family: Arial, sans-serif; }
    header, footer { background-color: #0c3c78; color: white; text-align: center; padding: 20px; }
    nav { background-color: #092e5e; display: flex; justify-content: center; }
    nav a { color: white; padding: 14px 20px; text-decoration: none; }
    nav a:hover { background-color: #0f4fa0; }
    section { flex: 1; padding: 40px 20px; max-width: 1400px; width: 90%; margin: auto; background: white; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    h2 { color: #0c3c78; }
    form { margin-top: 30px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .full-width { grid-column: 1 / -1; }
    label { display: block; font-weight: bold; color: #0c3c78; margin-bottom: 5px; }
    input, select, button { width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #ccc; box-sizing: border-box; }
    button { background-color: #0c3c78; color: white; cursor: pointer; grid-column: 1 / -1; margin-top: 20px; }
    button:hover { background-color: #0f4fa0; }
    #student-name-container { display: none; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { padding: 8px; border:1px solid #ddd; }
    thead th { background: #0c3c78; color: white; }
/* === Global Header & Navigation Styles (Finalized Version) === */
     header {
       background-color: #0c3c78; 
       color: white; 
       padding: 30px 20px; 
       position: relative; 
       text-align: center; 
     }
     .header-content { 
       display: flex; justify-content: center; align-items: center; 
       max-width: 1200px; margin: 0 auto;
       position: relative; 
     }
     .site-title { text-align: center; } 
     .site-title h1 { 
       font-size: 2.2em;    
       margin-top: 0;
       margin-bottom: 0; /* Adjusted for portal pages with no subtitle */
       color: white; 
     } 
     .site-title p { 
       font-size: 1em;    
       margin-top: 0;
       margin-bottom: 0;
       color: #f0f0f0;
       /* display: none; /* Subtitle can be shown or hidden based on page */
     }
     
     .mobile-menu-toggle { display: none; background: none; border: none; color: white; font-size: 28px; cursor: pointer; padding: 5px; }
     nav.main-navigation { background-color: #092e5e; }
     .nav-wrapper-desktop { 
         display: flex; justify-content: center; align-items: center;
         width: 100%; max-width: 1200px; margin: 0 auto; padding: 0 20px; box-sizing: border-box;
     }
     ul.nav-links-desktop { list-style: none; margin: 0; padding: 0; display: flex; }
     ul.nav-links-desktop li a { color: white; padding: 14px 20px; text-decoration: none; display: block; } 
     ul.nav-links-desktop li a:hover { background-color: #0f4fa0; }
     ul.nav-links-desktop li a.highlighted-nav, ul.nav-links-desktop li a.current-page { 
        background-color: #d8f352; color: black; font-weight: bold; border-radius: 5px; 
     }
     ul.nav-links-desktop li a.highlighted-nav:hover, ul.nav-links-desktop li a.current-page:hover { background-color: #c1da3b; }
     
     .auth-buttons-desktop { 
       position: absolute;
       top: 20px; 
       right: 20px; 
       display: flex;
       align-items: center;
       gap: 15px; /* Added gap property */
     }
     .auth-buttons-desktop a button, .auth-buttons-desktop button {
       background-color: white; color: #0c3c78; border: none; padding: 10px 20px; 
       /* margin-left: 15px; */ /* Removed margin-left */
       border-radius: 5px; font-weight: bold; cursor: pointer;
       transition: all 0.3s ease; white-space: nowrap;
     }
     .auth-buttons-desktop a button:hover, .auth-buttons-desktop button:hover { background-color: #0f4fa0; color: white; }
     .mobile-menu-container {
       display: none; background-color: #092e5e; position: fixed;
       top: 0; left: 0; width: 100%; height: 100%;
       z-index: 1000; padding-top: 20px;
       box-sizing: border-box; overflow-y: auto; text-align: center;
     }
     nav.main-navigation.mobile-menu--open .mobile-menu-container { display: block; }
     .mobile-menu-close {
        display: block; 
        position: absolute; 
        top: 10px; /* Adjusted */
        right: 10px; /* Adjusted */
        left: auto; /* Explicitly set */
        bottom: auto; /* Explicitly set */
        background: none; 
        border: none; 
        color: white; 
        font-size: 28px; 
        cursor: pointer;
        z-index: 10; /* Optionally add a z-index */
     }
     ul.nav-links-mobile { list-style: none; padding: 0; margin: 50px 0 20px; }
     ul.nav-links-mobile li a {
       color: white; padding: 15px 20px; text-decoration: none; display: block;
       border-bottom: 1px solid #0c3c78;
     }
     ul.nav-links-mobile li:last-child a { border-bottom: none; }
     ul.nav-links-mobile li a:hover { background-color: #0f4fa0; }
     .auth-buttons-mobile { padding: 20px; }
     .auth-buttons-mobile a button, .auth-buttons-mobile button {
       background-color: #d8f352; color: #0c3c78; border: none; padding: 12px 20px;
       border-radius: 5px; font-weight: bold; cursor: pointer; display: block;
       width: 80%; max-width: 250px; margin: 10px auto; box-sizing: border-box;
     }
     .auth-buttons-mobile a button:hover, .auth-buttons-mobile button:hover { background-color: #c1da3b; }
     
     
     footer { /* Global footer style */
        background-color: #0c3c78; color: white; text-align: center; padding: 20px; margin-top:auto; /* Pushes to bottom in flex if body is flex column */
     }

     @media (max-width: 768px) {
       body { -webkit-text-size-adjust: 100%; -ms-text-size-adjust: 100%; } 
       header { padding: 10px 15px; } 
       .header-content {
         justify-content: space-between; 
         width:100%; 
       }
       .site-title { text-align: left; }
       .site-title h1 { font-size: 1.2em; margin-bottom: 0; }
       .site-title p { display: none; } 
       .mobile-menu-toggle { display: block; }
       .nav-wrapper-desktop { display: none; }
       .auth-buttons-desktop { display: none; } 
       nav.main-navigation { padding: 0; background-color: transparent; }

      /* Mobile-specific layout adjustments */
      form {
        grid-template-columns: 1fr; /* Change to single column layout */
      }

      h2 {
        margin-bottom: 20px; /* Add bottom margin for h2 */
      }

      section {
        padding: 20px 10px; /* Reduce padding for smaller screens */
      }

      #all-lessons-container {
        overflow-x: auto; /* Allow horizontal scrolling only for the table container */
        -webkit-overflow-scrolling: touch; /* Optional: for smoother scrolling on iOS */
      }
    }
  /* Override the highlighted “Book” pill to be fully rounded */
ul.nav-links-desktop li a.highlighted-nav {
  border-radius: 9999px;
}

/* If you also want the mobile “Book” link rounded, do: */
ul.nav-links-mobile li a.highlighted-nav {
  border-radius: 9999px;
}
/* Make desktop nav links more pill-shaped */
ul.nav-links-desktop li a {
  border-radius: 9999px;
}

/* Ensure highlighted tab stays pill-shaped */
ul.nav-links-desktop li a.highlighted-nav {
  border-radius: 9999px;
}

/* Make mobile nav links match */
ul.nav-links-mobile li a {
  border-radius: 9999px;
}
/* === End Global Header & Navigation Styles === */

.explore-button {
  font-family: Arial, sans-serif;
  font-size: 1rem;
  font-weight: 400;
  background-color: #3b82f6; /* Blue background */
  color: white !important; /* Ensure white text overrules other <a> styles */
  padding: 0.75rem 2rem;
  border: none;
  border-radius: 9999px; /* Pill shape */
  box-shadow:
    0 10px 15px -3px rgba(0, 0, 0, 0.1),
    0   4px  6px -2px rgba(0, 0, 0, 0.05);
  cursor: pointer;
  transform-origin: center center;
  transition: background-color 0.2s ease, transform 0.2s ease;
  text-decoration: none; /* Remove underline from <a> */
  display: inline-block; /* Make <a> behave like a button */
  text-align: center;
  margin-top: 30px; /* Add some space above the button */
}

.explore-button:hover {
  background-color: #2563eb; /* Darker blue on hover */
  transform: scale(1.05);
  color: white !important;
  text-decoration: none;
}
  </style>
</head>
<body>

<header>
  <div class="header-content">
    <div class="site-title">
      <h1>Lesson History</h1> <!-- Specific title -->
      <p>C2 Tennis Academy</p> <!-- Consistent subtitle -->
    </div>
    <button class="mobile-menu-toggle" aria-label="Open navigation menu" aria-expanded="false" aria-controls="mainNavigation">
      &#9776; <!-- Hamburger icon -->
    </button>
  </div>
  <div class="auth-buttons-desktop" id="authContainerDesktop">
    <!-- Populated by checkSession JS - will show Logout, Admin Home etc. -->
  </div>
</header>

<nav class="main-navigation" id="mainNavigation">
  <div class="nav-wrapper-desktop"> 
     <ul class="nav-links-desktop">
       <li><a href="index.html">Home</a></li>
       <li><a href="about.html">About</a></li>
       <li><a href="programs.html">Programs</a></li>
       <li><a href="schedule.html">Schedule</a></li>
       <li><a href="contact.html">Contact</a></li>
       <!-- No "Book" link by default for admin, can be added if needed -->
     </ul>
  </div>
  <div class="mobile-menu-container">
    <button class="mobile-menu-close" aria-label="Close navigation menu">&times;</button>
    <ul class="nav-links-mobile">
      <li><a href="index.html">Home</a></li>
      <li><a href="about.html">About</a></li>
      <li><a href="programs.html">Programs</a></li>
      <li><a href="schedule.html">Schedule</a></li>
      <li><a href="contact.html">Contact</a></li>
    </ul>
    <div class="auth-buttons-mobile" id="authContainerMobile">
      <!-- Populated by checkSession JS -->
    </div>
  </div>
</nav>

  <section>
    <!-- All Scheduled Lessons -->
    <h2>Past Lesson History</h2>
    <div style="margin-bottom: 20px; margin-top: 10px;">
      <label for="historySearchInput" style="margin-right: 10px; font-weight: bold;">Search Past Lessons:</label>
      <input type="text" id="historySearchInput" placeholder="Enter keyword (student, program, coach, email, date)..." style="width: 50%; padding: 8px;">
    </div>
    <div id="private-lessons-section" style="margin-bottom: 30px;">
        <h3>Private Lessons</h3>
        <div id="private-lessons-table-container">Loading private lessons...</div>
    </div>

    <div id="camp-lessons-section" style="margin-bottom: 30px;">
        <h3>Camps & Passes</h3>
        <div id="camp-lessons-table-container">Loading camp & pass lessons...</div>
    </div>

    <div id="clinic-lessons-section" style="margin-bottom: 30px;">
        <h3>Clinics & Other Group Lessons</h3>
        <div id="clinic-lessons-table-container">Loading clinic lessons...</div>
    </div>

    <div id="other-bookings-section" style="margin-bottom: 30px;">
        <h3>Other Bookings</h3>
        <div id="other-bookings-table-container">Loading other bookings...</div>
    </div>
    삭제됨 <div style="text-align: center; margin-top: 40px; margin-bottom: 20px;"> <!-- Wrapper for centering -->
      삭제됨 <a href="admin_history.html" class="explore-button">View Lesson History</a>
    삭제됨 </div>
  </section>

  <footer>
    <p>&copy; 2025 C2 Tennis Academy. All rights reserved.</p>
  </footer>

  <script>
    // Toggle student field
    const programEl = document.getElementById('program');
    const studentDiv = document.getElementById('student-name-container');
    programEl.addEventListener('change', () => {
      studentDiv.style.display = programEl.value === 'Private Lessons' ? 'block' : 'none';
    });

    // Submit new lesson
    document.getElementById('lesson-form').addEventListener('submit', async e => {
      e.preventDefault();
      const payload = {
        program: programEl.value,
        coachName: document.getElementById('coach').value,
        date: document.getElementById('date').value,
        time: document.getElementById('time').value,
        student: document.getElementById('student-name').value || ''
      };
      const res = await fetch('/api/admin/lessons', {
        method: 'POST',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      if (res.ok) {
        alert('Lesson saved');
        loadAllLessons();
        e.target.reset();
        studentDiv.style.display = 'none';
      } else {
        alert('Save failed: ' + await res.text());
      }
    });
  </script>

  <script>
  let allFetchedPastLessons = []; // For storing all lessons to search through

  // Helper function to format time to 12-hour AM/PM
  function formatTime_12hr(timeStr) {
    if (!timeStr || !timeStr.includes(':')) {
      return timeStr; // Return original if invalid
    }
    const parts = timeStr.split(':');
    let hours = parseInt(parts[0], 10);
    const minutes = parseInt(parts[1], 10);
    
    const ampm = hours >= 12 ? 'PM' : 'AM';
    hours = hours % 12;
    hours = hours ? hours : 12; // the hour '0' should be '12'
    
    const minutesStr = minutes < 10 ? '0' + minutes : minutes;
    
    return hours + ':' + minutesStr + ' ' + ampm;
  }

  // Helper function to render a table for a specific set of lessons
  function renderLessonsTable(lessonsArray, containerId, placeholderMessage) {
    const container = document.getElementById(containerId);
    if (!container) {
      console.error('Container not found for ID:', containerId);
      return;
    }

    if (lessonsArray.length === 0) {
      container.innerHTML = `<p>${placeholderMessage}</p>`;
      return;
    }

    let html = `
      <table style="width:100%; border-collapse:collapse; margin-top:10px;">
        <thead>
          <tr style="background:#0c3c78; color:white;">
            <th style="padding:8px; border:1px solid #ddd;">Program</th>
            <th style="padding:8px; border:1px solid #ddd;">Coach</th>
            <th style="padding:8px; border:1px solid #ddd;">Date</th>
            <th style="padding:8px; border:1px solid #ddd;">Time</th>
            <th style="padding:8px; border:1px solid #ddd;">Student</th>
            <th style="padding:8px; border:1px solid #ddd;">Email</th>
            <th style="padding:8px; border:1px solid #ddd;">Phone</th>
            <th style="padding:8px; border:1px solid #ddd;">Paid?</th>
            <th style="padding:8px; border:1px solid #ddd;">Actions</th>
            삭제됨 ${containerId === 'camp-lessons-table-container' ? '<th style="padding:8px; border:1px solid #ddd;">Attendance / Pass Status</th>' : ''}
          </tr>
        </thead>
        <tbody>
    `;

    lessonsArray.forEach(les => {
      const dateStr = new Date(les.date).toLocaleDateString();
      const paidText = les.paid ? 'Yes' : 'NO - Pay Later';
      const formattedTime = formatTime_12hr(les.time);
      html += `
        <tr data-id="${les.id}" ${!les.paid ? 'style="background-color: #ffebee;"' : ''}>
          <td style="padding:8px; border:1px solid #ddd;">${les.program}</td>
          <td style="padding:8px; border:1px solid #ddd;">${les.coach}</td>
          <td style="padding:8px; border:1px solid #ddd;">${dateStr}</td>
          <td style="padding:8px; border:1px solid #ddd;">${formattedTime}</td>
          <td style="padding:8px; border:1px solid #ddd;">${les.student || '—'}</td>
          <td style="padding:8px; border:1px solid #ddd;">${les.email || '—'}</td>
          <td style="padding:8px; border:1px solid #ddd;">${les.phone || '—'}</td>
          <td style="padding:8px; border:1px solid #ddd;">${paidText}</td>
          <td style="padding:8px; border:1px solid #ddd;">
            <button onclick="deleteAdminLesson(${les.id})">Delete</button>
          </td>
      `;
      // Attendance UI removed for history page
      // if (containerId === 'camp-lessons-table-container') { ... } 
      html += `</tr>`;
    });

    html += `</tbody></table>`;
    container.innerHTML = html;

    // Event listener attachment for checkboxes removed for history page
    // if (containerId === 'camp-lessons-table-container') { ... }
  }

  // Load & render the admin lessons table
  async function loadPastLessons() {
    const res = await fetch('/api/admin/lessons', { credentials: 'include' });
    // Initial error check (applies to all tables if fetch fails)
    if (!res.ok) {
      const errorMsg = '<p style="color:red;">Could not load lessons data.</p>';
      document.getElementById('private-lessons-table-container').innerHTML = errorMsg;
      document.getElementById('camp-lessons-table-container').innerHTML = errorMsg;
      document.getElementById('clinic-lessons-table-container').innerHTML = errorMsg;
      document.getElementById('other-bookings-table-container').innerHTML = errorMsg;
      return;
    }
    const lessons = await res.json();

    const now = new Date();
    // Filter for past lessons
    const pastLessons = lessons.filter(les => {
        const lessonTime = les.time || '23:59:59'; // Default to end of day for past lessons
        // Assuming les.date is 'YYYY-MM-DD' and les.time is 'HH:MM' or 'HH:MM:SS'
        const lessonDateTimeStr = `${les.date}T${lessonTime}`;
        try {
            const lessonDate = new Date(lessonDateTimeStr);
            return lessonDate < now; // Keep only lessons strictly in the past
        } catch (e) {
            console.error(`Invalid date format for lesson: ${les.date} ${lessonTime}`, les);
            return false; // Exclude if date is invalid
        }
    });

    allFetchedPastLessons = [...pastLessons]; // Store a copy for filtering

    const privateLessons = [];
    const campLessons = [];
    const clinicLessons = [];
    const otherBookings = [];

    pastLessons.forEach(les => { // Initial render uses all past lessons
        const programName = les.program ? les.program.toLowerCase() : '';
        if (programName.includes('private') || programName.includes('tennis private')) {
            privateLessons.push(les);
        } else if (programName.includes('camp') || programName.includes('pass')) {
            campLessons.push(les);
        } else if (programName.includes('clinic') || programName.includes('high performance')) {
            clinicLessons.push(les);
        } else {
            otherBookings.push(les);
        }
    });

    renderLessonsTable(privateLessons, 'private-lessons-table-container', 'No private lessons scheduled.');
    renderLessonsTable(campLessons, 'camp-lessons-table-container', 'No camp or pass lessons scheduled.');
    renderLessonsTable(clinicLessons, 'clinic-lessons-table-container', 'No clinic or other group lessons scheduled.');
    renderLessonsTable(otherBookings, 'other-bookings-table-container', 'No other bookings.');
  }

  // Call the delete endpoint, then refresh the table
  async function deleteAdminLesson(id) {
    if (!confirm('Are you sure you want to delete this lesson?')) return;
    const res = await fetch(`/api/admin/lessons/${id}`, {
      method: 'DELETE',
      credentials: 'include'
    });
    if (res.ok) {
      loadPastLessons();
    } else {
      alert('Delete failed: ' + await res.text());
    }
  }

  // Kick it off on page load
  window.addEventListener('DOMContentLoaded', () => {
    loadPastLessons(); // Initial load

    const searchInput = document.getElementById('historySearchInput');
    if (searchInput) {
        searchInput.addEventListener('input', () => {
            const searchTerm = searchInput.value.toLowerCase().trim();
            filterAndRenderHistory(searchTerm);
        });
    }
  });

function filterAndRenderHistory(searchTerm) {
    let filteredLessons;
    if (!searchTerm) {
        filteredLessons = [...allFetchedPastLessons]; 
    } else {
        filteredLessons = allFetchedPastLessons.filter(les => {
            const dateStr = new Date(les.date).toLocaleDateString().toLowerCase();
            return (
                (les.program && les.program.toLowerCase().includes(searchTerm)) ||
                (les.coach && les.coach.toLowerCase().includes(searchTerm)) ||
                (les.student && les.student.toLowerCase().includes(searchTerm)) ||
                (les.email && les.email.toLowerCase().includes(searchTerm)) ||
                (dateStr.includes(searchTerm)) 
            );
        });
    }

    // Now, categorize and render 'filteredLessons'
    const privateLessons = [];
    const campLessons = [];
    const clinicLessons = [];
    const otherBookings = [];

    filteredLessons.forEach(les => {
        const programName = les.program ? les.program.toLowerCase() : '';
        if (programName.includes('private') || programName.includes('tennis private')) {
            privateLessons.push(les);
        } else if (programName.includes('camp') || programName.includes('pass')) {
            campLessons.push(les);
        } else if (programName.includes('clinic') || programName.includes('high performance')) {
            clinicLessons.push(les);
        } else {
            otherBookings.push(les);
        }
    });

    renderLessonsTable(privateLessons, 'private-lessons-table-container', 'No matching private lessons found.');
    renderLessonsTable(campLessons, 'camp-lessons-table-container', 'No matching camp or pass lessons found.');
    renderLessonsTable(clinicLessons, 'clinic-lessons-table-container', 'No matching clinic lessons found.');
    renderLessonsTable(otherBookings, 'other-bookings-table-container', 'No other matching bookings found.');
}

// TODO: BACKEND REQUIREMENT for full attendance tracking functionality:
// This function currently only provides mock UI feedback and console logs.
// For persistence, it should make an API call to a new backend endpoint, e.g.:
// POST /api/admin/mark-attendance
// Request body example: { "bookingId": bookingId, "dayIndex": dayIndex, "attended": isChecked }
// The backend would then update the 'days_used' or a similar field/table for this booking in the database.
function handleAttendanceChange(bookingId, dayIndex, isChecked) {
    console.log(`Attendance change: Booking ID ${bookingId}, Day Index ${dayIndex}, Checked: ${isChecked}`);
    // Mock UI update:
    const daysUsedSpan = document.querySelector(`.days-used[data-booking-id="${bookingId}"]`);
    const statusSpan = document.querySelector(`.attendance-status[data-booking-id="${bookingId}"]`);

    if (daysUsedSpan) { // For multi-day passes
        let currentDaysUsed = 0;
        // Recalculate based on all checkboxes for this booking
        document.querySelectorAll(`.attendance-checkbox[data-booking-id="${bookingId}"]`).forEach(cb => {
            if (cb.checked) currentDaysUsed++;
        });
        daysUsedSpan.textContent = currentDaysUsed;
    } else if (statusSpan) { // For single-day passes
        statusSpan.textContent = isChecked ? 'Attended' : 'Not Attended';
    }
}
</script>
  <script>
  // This entire block to be added as a new script, or integrated if a single DOMContentLoaded is preferred.
  document.addEventListener('DOMContentLoaded', () => {
      // --- Mobile Menu Toggle Script --- 
      const menuToggle = document.querySelector('.mobile-menu-toggle');
      const mobileMenuClose = document.querySelector('.mobile-menu-close');
      const mainNav = document.querySelector('nav.main-navigation');

      if (menuToggle && mainNav && mobileMenuClose) {
          menuToggle.addEventListener('click', () => {
              const isMenuOpen = mainNav.classList.toggle('mobile-menu--open');
              menuToggle.setAttribute('aria-expanded', isMenuOpen);
              if (isMenuOpen) {
                  menuToggle.innerHTML = '&times;'; 
                  menuToggle.setAttribute('aria-label', 'Close navigation menu');
              } else {
                  menuToggle.innerHTML = '&#9776;'; 
                  menuToggle.setAttribute('aria-label', 'Open navigation menu');
              }
          });

          mobileMenuClose.addEventListener('click', () => {
              mainNav.classList.remove('mobile-menu--open');
              if (menuToggle) {
                 menuToggle.setAttribute('aria-expanded', 'false');
                 menuToggle.innerHTML = '&#9776;'; 
                 menuToggle.setAttribute('aria-label', 'Open navigation menu');
              }
          });
      }

      const mobileNavLinks = document.querySelectorAll('.mobile-menu-container a');
      if (mainNav && mobileNavLinks.length > 0) {
          mobileNavLinks.forEach(link => {
              link.addEventListener('click', () => {
                  if (mainNav.classList.contains('mobile-menu--open')) {
                      mainNav.classList.remove('mobile-menu--open');
                      if (menuToggle) {
                          menuToggle.setAttribute('aria-expanded', 'false');
                          menuToggle.innerHTML = '&#9776;';
                          menuToggle.setAttribute('aria-label', 'Open navigation menu');
                      }
                  }
              });
          });
      }

      // --- checkSession and logout functions for Admin Portal --- 
      async function checkSession() {
          // Ensure existing greetings are removed before adding a new one to prevent duplicates from multiple calls
          const existingGreeting = document.querySelector('.welcome-greeting');
          if (existingGreeting) existingGreeting.remove();
           
          // Original admin.html had <p>Admin Portal: Welcome Admin</p> in header.
          // New header has "Admin Portal" as h1, "C2 Tennis Academy" as p.
          // Greeting banner will add "Welcome, [firstName]" if available, or just "Welcome, Admin".

          try {
              const res = await fetch('/api/check-session', { credentials: 'include' });
              const data = await res.json(); 

              const authContainerDesktop = document.getElementById('authContainerDesktop');
              const authContainerMobile = document.getElementById('authContainerMobile');
              
              if (data && data.loggedIn === true && data.isAdmin === true) {
                  // Corrected logic for portal button text
                  const portalButtonText = data.firstName ? 'Admin (' + data.firstName + ')' : 'Admin Portal';
                  
                  const loggedInHTML = '<a href="admin.html"><button>' + portalButtonText + '</button></a><button onclick="logout()">Logout</button>';
                  const loggedInMobileHTML = loggedInHTML; // Assuming it's the same

                  if (authContainerDesktop) authContainerDesktop.innerHTML = loggedInHTML;
                  if (authContainerMobile) authContainerMobile.innerHTML = loggedInMobileHTML;

                  // Corrected logic for welcome message text
                  const welcomeMessageText = data.firstName ? 'Welcome, ' + data.firstName + '!' : 'Welcome, Admin!';
                  
                  const greeting = document.createElement('div');
                  greeting.className = 'welcome-greeting';
                  greeting.textContent = welcomeMessageText;
                  greeting.style.cssText = 'background:#0c3c78;color:white;padding:10px;text-align:center;font-weight:bold;';
                  
                  // This logic for inserting the greeting is already here.
                  // Ensure existing greetings are removed before adding a new one to prevent duplicates from multiple calls
                  const existingGreeting = document.querySelector('.welcome-greeting');
                  if (existingGreeting) existingGreeting.remove();

                  if(document.body.firstChild) { // Attempt to insert before first child of body
                      document.body.insertBefore(greeting, document.body.firstChild);
                  } else { // Fallback if body has no children
                      document.body.appendChild(greeting);
                  }
              } else {
                  // Not logged in as an Admin
                  window.location.href = 'login.html'; 
                  const loggedOutHTML = `<a href="login.html"><button>Login</button></a>`;
                  if (authContainerDesktop) authContainerDesktop.innerHTML = loggedOutHTML;
                  if (authContainerMobile) authContainerMobile.innerHTML = loggedOutHTML;
              }
          } catch (err) {
              console.error('Session check failed, redirecting to login:', err);
              window.location.href = 'login.html'; 
              const authContainerDesktop = document.getElementById('authContainerDesktop');
              const authContainerMobile = document.getElementById('authContainerMobile');
              const loggedOutHTML = `<a href="login.html"><button>Login</button></a>`;
              if (authContainerDesktop) authContainerDesktop.innerHTML = loggedOutHTML;
              if (authContainerMobile) authContainerMobile.innerHTML = loggedOutHTML;
          }
      }

      window.logout = function() { // Make logout globally accessible
          fetch('/api/logout', { method: 'POST', credentials: 'include' })
              .then(() => {
                  const existingGreeting = document.querySelector('.welcome-greeting');
                  if (existingGreeting) existingGreeting.remove();
                  document.cookie = "userFirstName=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
                  window.location.href = 'login.html'; 
              });
      }

      checkSession(); 
  });
  </script>
</body>
</html>