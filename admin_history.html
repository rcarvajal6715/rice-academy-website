<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lesson History - Admin Portal - C2 Tennis Academy</title>

  <style>
    html, body { height: 100%; margin: 0; display: flex; flex-direction: column; font-family: Arial, sans-serif; }
    header, footer { background-color: #0c3c78; color: white; text-align: center; padding: 20px; }
    nav { background-color: #092e5e; display: flex; justify-content: center; }
    nav a { color: white; padding: 14px 20px; text-decoration: none; }
    nav a:hover { background-color: #0f4fa0; }
    section { flex: 1; padding: 40px 20px; max-width: 1400px; width: 90%; margin: auto; background: white; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    h2 { color: #0c3c78; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { padding: 8px; border:1px solid #ddd; }
    thead th { background: #0c3c78; color: white; }
/* === Global Header & Navigation Styles (Finalized Version) === */
     header {
       background-color: #0c3c78; 
       color: white; 
       padding: 30px 20px; 
       position: relative; 
       text-align: center; 
     }
     .header-content { 
       display: flex; justify-content: center; align-items: center; 
       max-width: 1200px; margin: 0 auto;
       position: relative; 
     }
     .site-title { text-align: center; } 
     .site-title h1 { 
       font-size: 2.2em;    
       margin-top: 0;
       margin-bottom: 0; 
       color: white; 
     } 
     .site-title p { 
       font-size: 1em;    
       margin-top: 0;
       margin-bottom: 0;
       color: #f0f0f0;
     }
     
     .mobile-menu-toggle { display: none; background: none; border: none; color: white; font-size: 28px; cursor: pointer; padding: 5px; }
     nav.main-navigation { background-color: #092e5e; }
     .nav-wrapper-desktop { 
         display: flex; justify-content: center; align-items: center;
         width: 100%; max-width: 1200px; margin: 0 auto; padding: 0 20px; box-sizing: border-box;
     }
     ul.nav-links-desktop { list-style: none; margin: 0; padding: 0; display: flex; }
     ul.nav-links-desktop li a { color: white; padding: 14px 20px; text-decoration: none; display: block; } 
     ul.nav-links-desktop li a:hover { background-color: #0f4fa0; }
     ul.nav-links-desktop li a.highlighted-nav, ul.nav-links-desktop li a.current-page { 
        background-color: #d8f352; color: black; font-weight: bold; border-radius: 5px; 
     }
     ul.nav-links-desktop li a.highlighted-nav:hover, ul.nav-links-desktop li a.current-page:hover { background-color: #c1da3b; }
     
     .auth-buttons-desktop { 
       position: absolute;
       top: 20px; 
       right: 20px; 
       display: flex;
       align-items: center;
       gap: 15px; 
     }
     .auth-buttons-desktop a button, .auth-buttons-desktop button {
       background-color: white; color: #0c3c78; border: none; padding: 10px 20px; 
       border-radius: 5px; font-weight: bold; cursor: pointer;
       transition: all 0.3s ease; white-space: nowrap;
     }
     .auth-buttons-desktop a button:hover, .auth-buttons-desktop button:hover { background-color: #0f4fa0; color: white; }
     .mobile-menu-container {
       display: none; background-color: #092e5e; position: fixed;
       top: 0; left: 0; width: 100%; height: 100%;
       z-index: 1000; padding-top: 20px;
       box-sizing: border-box; overflow-y: auto; text-align: center;
     }
     nav.main-navigation.mobile-menu--open .mobile-menu-container { display: block; }
     .mobile-menu-close {
        display: block; 
        position: absolute; 
        top: 10px; 
        right: 10px; 
        left: auto; 
        bottom: auto; 
        background: none; 
        border: none; 
        color: white; 
        font-size: 28px; 
        cursor: pointer;
        z-index: 10; 
     }
     ul.nav-links-mobile { list-style: none; padding: 0; margin: 50px 0 20px; }
     ul.nav-links-mobile li a {
       color: white; padding: 15px 20px; text-decoration: none; display: block;
       border-bottom: 1px solid #0c3c78;
     }
     ul.nav-links-mobile li:last-child a { border-bottom: none; }
     ul.nav-links-mobile li a:hover { background-color: #0f4fa0; }
     .auth-buttons-mobile { padding: 20px; }
     .auth-buttons-mobile a button, .auth-buttons-mobile button {
       background-color: #d8f352; color: #0c3c78; border: none; padding: 12px 20px;
       border-radius: 5px; font-weight: bold; cursor: pointer; display: block;
       width: 80%; max-width: 250px; margin: 10px auto; box-sizing: border-box;
     }
     .auth-buttons-mobile a button:hover, .auth-buttons-mobile button:hover { background-color: #c1da3b; }
     
     footer { 
        background-color: #0c3c78; color: white; text-align: center; padding: 20px; margin-top:auto; 
     }

     @media (max-width: 768px) {
       body { -webkit-text-size-adjust: 100%; -ms-text-size-adjust: 100%; } 
       header { padding: 10px 15px; } 
       .header-content {
         justify-content: space-between; 
         width:100%; 
       }
       .site-title { text-align: left; }
       .site-title h1 { font-size: 1.2em; margin-bottom: 0; }
       .site-title p { display: none; } 
       .mobile-menu-toggle { display: block; }
       .nav-wrapper-desktop { display: none; }
       .auth-buttons-desktop { display: none; } 
       nav.main-navigation { padding: 0; background-color: transparent; }
      h2 {
        margin-bottom: 20px; 
      }
      section {
        padding: 20px 10px; 
      }
    }
ul.nav-links-desktop li a.highlighted-nav {
  border-radius: 9999px;
}
ul.nav-links-mobile li a.highlighted-nav {
  border-radius: 9999px;
}
ul.nav-links-desktop li a {
  border-radius: 9999px;
}
ul.nav-links-desktop li a.highlighted-nav {
  border-radius: 9999px;
}
ul.nav-links-mobile li a {
  border-radius: 9999px;
}

.explore-button {
  font-family: Arial, sans-serif;
  font-size: 1rem;
  font-weight: 400;
  background-color: #3b82f6; 
  color: white !important; 
  padding: 0.75rem 2rem;
  border: none;
  border-radius: 9999px; 
  box-shadow:
    0 10px 15px -3px rgba(0, 0, 0, 0.1),
    0   4px  6px -2px rgba(0, 0, 0, 0.05);
  cursor: pointer;
  transform-origin: center center;
  transition: background-color 0.2s ease, transform 0.2s ease;
  text-decoration: none; 
  display: inline-block; 
  text-align: center;
  margin-top: 30px; 
}

.explore-button:hover {
  background-color: #2563eb; 
  transform: scale(1.05);
  color: white !important;
  text-decoration: none;
}

.category-filter-button {
  background-color: #f0f0f0; 
  color: #333;            
  border: 1px solid #ccc;
  padding: 8px 15px;
  margin: 0 5px 10px 0; 
  border-radius: 5px;
  cursor: pointer;
  font-size: 0.9rem;
  transition: background-color 0.2s ease, color 0.2s ease;
}
.category-filter-button:hover {
  background-color: #e0e0e0; 
}
.category-filter-button.active-filter-button {
  background-color: #0c3c78; 
  color: white;
  border-color: #0c3c78;
  font-weight: bold;
}
#category-filters-title {
    margin-top: 20px;
    margin-bottom: 10px;
    font-weight: bold;
    color: #0c3c78; 
}
.update-payment-btn {
    background-color: #4CAF50; /* Green */
    color: white;
    padding: 5px 10px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9em;
}
.update-payment-btn:hover {
    background-color: #45a049;
}
  </style>
</head>
<body>

<header>
  <div class="header-content">
    <div class="site-title">
      <h1>Lesson History</h1> 
      <p>C2 Tennis Academy</p> 
    </div>
    <button class="mobile-menu-toggle" aria-label="Open navigation menu" aria-expanded="false" aria-controls="mainNavigation">
      &#9776; 
    </button>
  </div>
  <div class="auth-buttons-desktop" id="authContainerDesktop">
  </div>
</header>

<nav class="main-navigation" id="mainNavigation">
  <div class="nav-wrapper-desktop"> 
     <ul class="nav-links-desktop">
       <li><a href="index.html">Home</a></li>
       <li><a href="about.html">About</a></li>
       <li><a href="programs.html">Programs</a></li>
       <li><a href="schedule.html">Schedule</a></li>
       <li><a href="contact.html">Contact</a></li>
     </ul>
  </div>
  <div class="mobile-menu-container">
    <button class="mobile-menu-close" aria-label="Close navigation menu">&times;</button>
    <ul class="nav-links-mobile">
      <li><a href="index.html">Home</a></li>
      <li><a href="about.html">About</a></li>
      <li><a href="programs.html">Programs</a></li>
      <li><a href="schedule.html">Schedule</a></li>
      <li><a href="contact.html">Contact</a></li>
    </ul>
    <div class="auth-buttons-mobile" id="authContainerMobile">
    </div>
  </div>
</nav>

  <section>
    <h2>Past Lesson History</h2>
    <div style="margin-bottom: 20px; margin-top: 10px;">
      <label for="historySearchInput" style="margin-right: 10px; font-weight: bold;">Search Past Lessons:</label>
      <input type="text" id="historySearchInput" placeholder="Enter keyword (student, program, coach, email, date)..." style="width: 50%; padding: 8px;">
    </div>
    <div id="category-filters-title">Filters:</div>
    <div id="category-filters" style="margin-bottom: 20px;">
      <button class="category-filter-button active-filter-button" data-category="All">All</button>
      <button class="category-filter-button" data-category="Privates">Private Lessons</button>
      <button class="category-filter-button" data-category="Camps">Camps & Passes</button>
      <button class="category-filter-button" data-category="Clinics">Clinics & Other</button>
    </div>
    
    <button id="enable-history-editing-btn" style="margin-bottom:10px;">Enable Editing</button>
    <div style="text-align:right; margin-bottom: 5px;">
      <button id="save-history-btn" disabled>Save All History Changes</button>
    </div>
    
    <!-- The bulk update button for costs is kept separate for now, can be integrated later if needed -->
    <div style="text-align: right; margin-bottom: 5px;">
        <button class="bulk-update-costs-btn" data-table-id="past-lessons-table-container" disabled>Update All Changed Prices</button>
    </div>
    <div id="past-lessons-table-container" style="margin-top: 20px;">
        <!-- The single table of past lessons will be rendered here by JavaScript -->
    </div>
  </section>

  <footer>
    <p>&copy; 2025 C2 Tennis Academy. All rights reserved.</p>
  </footer>

  <script>
  // This script block is intentionally left empty as the form-related JS was removed.
  // New JS logic will be added in the next script tag or by replacing this one.
  </script>

  <script>
  let allFetchedPastLessons = []; 
  let activeCategoryFilter = 'All'; 
  let editing = false; // Flag for editing state

  // DOM Elements
  let enableHistoryEditingBtn;
  let saveHistoryBtn;
  let historyTableContainer; // Will be past-lessons-table-container

  // Helper to format time (assuming it's still needed)
  function formatTime_12hr(timeStr) {
    if (!timeStr || String(timeStr).toLowerCase() === 'null' || !String(timeStr).includes(':')) { return ''; }
    const parts = String(timeStr).split(':'); // Ensure timeStr is treated as a string
    let hours = parseInt(parts[0], 10);
    const minutes = parseInt(parts[1], 10);
    const ampm = hours >= 12 ? 'PM' : 'AM';
    hours = hours % 12;
    hours = hours ? hours : 12; 
    const minutesStr = minutes < 10 ? '0' + minutes : minutes;
    return hours + ':' + minutesStr + ' ' + ampm;
  }

  function checkTableInputChanges(tableContainerId) {
    const container = document.getElementById(tableContainerId);
    if (!container) {
        console.error(`checkTableInputChanges: Container not found for ID: ${tableContainerId}`);
        return;
    }

    const bulkButton = document.querySelector(`.bulk-update-costs-btn[data-table-id="${tableContainerId}"]`);
    if (!bulkButton) {
        console.error(`checkTableInputChanges: Bulk update button not found for table ID: ${tableContainerId}`);
        return;
    }

    const inputs = container.querySelectorAll('.lesson-cost-input');
    let hasChanges = false;

    for (const inputField of inputs) {
        const originalCostStr = inputField.getAttribute('data-original-cost');
        const originalCost = parseFloat(originalCostStr); // NaN if empty or invalid

        const currentValue = inputField.value.trim();
        
        if (currentValue === '' && (originalCostStr === '' || isNaN(originalCost))) {
            // Both original and current are effectively "empty" or "not set"
            continue;
        }
        if (currentValue === '' && (originalCostStr !== '' && !isNaN(originalCost)) ) {
            // Original had a value, now it's cleared
            hasChanges = true;
            break;
        }

        const currentCost = parseFloat(currentValue);

        if (isNaN(currentCost) && currentValue !== '') { // Invalid non-empty input
            continue; 
        }
        
        if (currentValue !== '' && isNaN(originalCost) && !isNaN(currentCost)) { // New valid price for previously empty
             hasChanges = true;
             break;
        }
        if (!isNaN(originalCost) && !isNaN(currentCost) && currentCost !== originalCost) { // Different numeric values
             hasChanges = true;
             break;
        }
    }
    bulkButton.disabled = !hasChanges;
}

  // Duplicate formatTime_12hr removed, the one above is modified.

  function renderPastLessonsTable(lessonsArray, containerId, placeholderMessage) {
    const minutes = parseInt(parts[1], 10);
    const ampm = hours >= 12 ? 'PM' : 'AM';
    hours = hours % 12;
    hours = hours ? hours : 12; 
    const minutesStr = minutes < 10 ? '0' + minutes : minutes;
    return hours + ':' + minutesStr + ' ' + ampm;
  }

  function renderPastLessonsTable(lessonsArray, containerId, placeholderMessage) {
    console.log('HISTORY.HTML: renderPastLessonsTable START for container:', containerId, 'with lessons:', lessonsArray.length);
    const container = document.getElementById(containerId); 
    if (!container) {
      console.error('Container not found for ID:', containerId);
      return;
    }

    if (lessonsArray.length === 0) {
      console.log('HISTORY.HTML: Rendering placeholder for:', containerId);
      container.innerHTML = `<p>${placeholderMessage}</p>`;
      return;
    }

    let html = `
      <table style="width:100%; border-collapse:collapse; margin-top:10px;">
        <thead>
          <tr style="background:#0c3c78; color:white;">
            <th style="padding:8px; border:1px solid #ddd;">Program</th>
            <th style="padding:8px; border:1px solid #ddd;">Coach</th>
            <th style="padding:8px; border:1px solid #ddd;">Date</th>
            <th style="padding:8px; border:1px solid #ddd;">Time</th>
            <th style="padding:8px; border:1px solid #ddd;">Student</th>
            <th style="padding:8px; border:1px solid #ddd;">Email</th>
            <th style="padding:8px; border:1px solid #ddd;">Phone</th>
            <th style="padding:8px; border:1px solid #ddd;">Lesson Cost</th>
            <th style="padding:8px; border:1px solid #ddd;">Referral Source</th>
            <th style="padding:8px; border:1px solid #ddd;">Paid</th>
            <th style="padding:8px; border:1px solid #ddd;">Referral Source</th>
            <th style="padding:8px; border:1px solid #ddd;">Paid</th>
            <th style="padding:8px; border:1px solid #ddd;">Actions</th>
          </tr>
        </thead>
        <tbody>
    `;

    lessonsArray.forEach(les => {
      const dateStr = new Date(les.date).toLocaleDateString();
      
      const originalTimeValue = les.time;
      const displayTime = (originalTimeValue && String(originalTimeValue).toLowerCase() !== 'null') ? formatTime_12hr(originalTimeValue) : '';
      const dataOriginalTime = (originalTimeValue && String(originalTimeValue).toLowerCase() !== 'null') ? originalTimeValue : '';

      let rowStyle = '';
      // The specific styling for unpaid rows might be redundant now.
      // if (!les.paid) { rowStyle = 'background-color: #ffebee;'; }

      // Add referral_source to the displayed columns if it's part of `les` object
      const referralSourceDisplay = les.referral_source || '—';

      const originalDate = les.date ? les.date.substring(0,10) : ''; // Assuming les.date is in ISO format or similar

      html += `
        <tr data-id="${les.id}" ${rowStyle ? `style="${rowStyle}"` : ''}>
          <td class="history-cell" data-id="${les.id}" data-field="program" data-original-value="${les.program || ''}" style="padding:8px; border:1px solid #ddd;">${les.program}</td>
          <td class="history-cell" data-id="${les.id}" data-field="coach" data-original-value="${les.coach || ''}" style="padding:8px; border:1px solid #ddd;">${les.coach}</td>
          <td class="history-cell" data-id="${les.id}" data-field="date" data-original-value="${originalDate}" style="padding:8px; border:1px solid #ddd;">${dateStr}</td>
          <td class="history-cell" data-id="${les.id}" data-field="time" data-original-value="${dataOriginalTime}" style="padding:8px; border:1px solid #ddd;">${displayTime}</td>
          <td class="history-cell" data-id="${les.id}" data-field="student" data-original-value="${les.student || ''}" style="padding:8px; border:1px solid #ddd;">${les.student || '—'}</td>
          <td style="padding:8px; border:1px solid #ddd;">${les.email || '—'}</td> <!-- Email not typically editable here -->
          <td style="padding:8px; border:1px solid #ddd;">${les.phone || '—'}</td> <!-- Phone not typically editable here -->
          <td class="history-cell" data-id="${les.id}" data-field="lesson_cost" data-original-value="${les.lesson_cost !== null && les.lesson_cost !== undefined ? les.lesson_cost : ''}" style="padding:8px; border:1px solid #ddd;">${les.lesson_cost !== null && les.lesson_cost !== undefined ? les.lesson_cost : ''}</td>
          <td class="history-cell" data-id="${les.id}" data-field="referral_source" data-original-value="${referralSourceDisplay}" style="padding:8px; border:1px solid #ddd;">${referralSourceDisplay}</td>
          <td class="history-cell" data-id="${les.id}" data-field="paid" data-original-value="${String(les.paid === true || String(les.paid).toLowerCase() === 'true')}" style="padding:8px; border:1px solid #ddd;">${(les.paid === true || String(les.paid).toLowerCase() === 'true') ? 'Yes' : 'No'}</td>
          <td style="padding:8px; border:1px solid #ddd;">
            <button onclick="deleteAdminLesson(${les.id})">Delete</button>
          </td>
        </tr>
      `;
    });
    html += `</tbody></table>`;
    container.innerHTML = html;
    console.log('HISTORY.HTML: Rendering actual table into:', containerId, 'HTML length:', html.length > 0 ? html.length : 'EMPTY!');
    
    // Cost input specific logic is removed from here as cells are now directly editable.
    // The general checkTableInputChanges for the bulk cost update button remains if that button is kept.
    // If the bulk-update-costs-btn is still desired, its checkTableInputChanges will need to be adjusted or it should be removed.
    // For now, assuming it might still be there for cost inputs if any remain.
    // checkTableInputChanges(containerId); // This might be redundant if cost inputs are removed in favor of editable cells
  }

  async function loadHistory() { // Renamed from loadPastLessons
    if (!historyTableContainer) historyTableContainer = document.getElementById('past-lessons-table-container');
    historyTableContainer.innerHTML = '<p>Loading history...</p>';
    
    try {
      const res = await fetch('/api/admin/lessons', { credentials: 'include' }); // Assuming this endpoint provides all necessary data
      if (!res.ok) {
        const errorMsg = '<p style="color:red;">Could not load lesson history data.</p>';
        historyTableContainer.innerHTML = errorMsg;
        return;
      }
      const lessons = await res.json();
      console.log('HISTORY.HTML: Fetched total lessons for history:', lessons.length);

      const now = new Date();
      const pastLessons = lessons.filter(les => {
        if (!les.date) return false; 
        const dateStr = les.date.substring(0, 10); 
        const dateParts = dateStr.split('-');
        if (dateParts.length !== 3) return false; 
        const year = parseInt(dateParts[0]);
        const month = parseInt(dateParts[1]) - 1; 
        const day = parseInt(dateParts[2]);
        let hours = 23, minutes = 59, seconds = 59; 
        if (les.time) {
            const timeParts = les.time.split(':');
            if (timeParts.length >= 2) {
                hours = parseInt(timeParts[0]);
                minutes = parseInt(timeParts[1]);
                seconds = timeParts[2] ? parseInt(timeParts[2]) : 0;
            }
        }
        try {
            const lessonDate = new Date(year, month, day, hours, minutes, seconds);
            if (lessonDate.toDateString() === now.toDateString()) { 
                return lessonDate < now; 
            }
            return lessonDate < now; 
        } catch (e) {
            console.error(`HISTORY.HTML: Invalid date components for lesson: Y:${year} M:${month} D:${day} H:${hours} M:${minutes}`, les, e);
            return false;
        }
    });
      console.log('HISTORY.HTML: Filtered past lessons count for history:', pastLessons.length);
      allFetchedPastLessons = [...pastLessons]; 
      filterAndRenderHistory(''); // Initial render with no search term
    } catch (error) {
        console.error('Error loading lesson history:', error);
        historyTableContainer.innerHTML = '<p style="color:red;">Failed to load history due to a network error.</p>';
    }
  }

  async function deleteAdminLesson(id) {
    if (!confirm('Are you sure you want to delete this lesson?')) return;
    try {
        const res = await fetch(`/api/admin/lessons/${id}`, {
            method: 'DELETE',
            credentials: 'include'
        });
        if (res.ok) {
            loadHistory(); // Refresh after delete
        } else {
            alert('Delete failed: ' + await res.text());
        }
    } catch (err) {
        console.error('Error deleting lesson:', err);
        alert('Delete failed due to a network error.');
    }
  }
  
  // Removed handleUpdatePayment(bookingId) function (if any was left)
  // Removed markAsPaid(bookingId) function (if any was left)

  // async function handleUpdateCost(bookingId) { ... } // This function is now removed.

  async function handleBulkUpdatePrices(tableContainerId) {
    const container = document.getElementById(tableContainerId);
    if (!container) {
        console.error('Table container not found for ID:', tableContainerId);
        return;
    }

    const inputFields = container.querySelectorAll('.lesson-cost-input');
    const pendingUpdates = [];
    const results = { successes: [], failures: [] };

    inputFields.forEach(inputField => {
        const bookingId = inputField.getAttribute('data-booking-id');
        const originalCostStr = inputField.getAttribute('data-original-cost');
        const originalCost = parseFloat(originalCostStr); // Will be NaN if originalCostStr is empty
        
        const currentValue = inputField.value.trim();

        if (currentValue === '') { // If input is empty, skip (treat as no change or invalid for bulk update).
            return; 
        }

        const currentCost = parseFloat(currentValue);

        if (isNaN(currentCost)) {
            results.failures.push(`Booking ID ${bookingId}: Invalid cost format ('${currentValue}').`);
            return;
        }
        
        let isChanged = false;
        if (isNaN(originalCost) && !isNaN(currentCost)) { // Original was empty/NaN, new is valid number
             isChanged = true;
        } else if (!isNaN(originalCost) && currentCost !== originalCost) { // Original was a number, new is different number
             isChanged = true;
        }
        // Note: This logic doesn't explicitly count clearing a field (original number, current empty) as a "pendingUpdate"
        // because the initial check `if (currentValue === '')` skips it. If clearing should be an update to zero or null,
        // this logic would need adjustment, or the backend needs to interpret empty cost as such.
        // For now, only valid new numbers or changes between valid numbers are processed for bulk update.

        if (isChanged) {
            pendingUpdates.push({ bookingId, newCost: currentCost });
        }
    });

    if (pendingUpdates.length === 0 && results.failures.length === 0) {
        alert("No valid changes detected to update.");
        return;
    }
     if (pendingUpdates.length === 0 && results.failures.length > 0) {
        let summaryMessage = "Update Summary:\n";
        summaryMessage += `0 prices to update successfully.\n`;
        summaryMessage += `${results.failures.length} items had issues:\n`;
        results.failures.forEach(failure => {
            summaryMessage += `- ${failure}\n`;
        });
        alert(summaryMessage);
        return;
    }


    for (const update of pendingUpdates) {
        try {
            const res = await fetch(`/api/admin/booking-payment/${update.bookingId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json', 'Credentials': 'include' },
                body: JSON.stringify({ lesson_cost_from_req: update.newCost })
            });

            if (res.ok) {
                results.successes.push(`Booking ID ${update.bookingId}: Cost updated to ${update.newCost}.`);
            } else {
                let errorMsg = `Booking ID ${update.bookingId}: Update failed (status ${res.status}).`;
                try {
                    const errorData = await res.json();
                    errorMsg += ` ${errorData.message || ''}`;
                } catch (e) { /* ignore if response not json */ }
                results.failures.push(errorMsg);
            }
        } catch (err) {
            results.failures.push(`Booking ID ${update.bookingId}: Network error - ${err.message}`);
        }
    }

    let summaryMessage = "Update Summary:\n";
    summaryMessage += `${results.successes.length} prices updated successfully.\n`;
    if (results.failures.length > 0) {
        summaryMessage += `${results.failures.length} updates failed or had issues:\n`;
        results.failures.forEach(failure => {
            summaryMessage += `- ${failure}\n`;
        });
    }
    alert(summaryMessage);

    loadPastLessons(); // Crucially, call loadPastLessons to refresh data for the history page
  }

  function filterAndRenderHistory(searchTerm) {
    console.log('HISTORY.HTML: filterAndRenderHistory called with searchTerm:', searchTerm, 'and activeCategoryFilter:', activeCategoryFilter);
    let searchFilteredLessons;
    if (!searchTerm) {
        searchFilteredLessons = [...allFetchedPastLessons]; 
    } else {
        searchFilteredLessons = allFetchedPastLessons.filter(les => {
            if (!les) return false; 
            const dateStr = les.date ? new Date(les.date).toLocaleDateString().toLowerCase() : '';
            const programName = les.program ? les.program.toLowerCase() : '';
            const coachName = les.coach ? les.coach.toLowerCase() : '';
            const studentName = les.student ? les.student.toLowerCase() : '';
            const emailAddr = les.email ? les.email.toLowerCase() : '';
            const phoneNum = les.phone ? les.phone.toLowerCase() : '';
            return (
                programName.includes(searchTerm) ||
                coachName.includes(searchTerm) ||
                studentName.includes(searchTerm) ||
                emailAddr.includes(searchTerm) ||
                phoneNum.includes(searchTerm) ||
                dateStr.includes(searchTerm)
            );
        });
    }

    let finalDisplayLessons;
    if (activeCategoryFilter === 'All') {
        finalDisplayLessons = [...searchFilteredLessons];
    } else {
        finalDisplayLessons = searchFilteredLessons.filter(les => {
            if (!les || !les.program) return false;
            const programName = les.program.toLowerCase();
            if (activeCategoryFilter === 'Privates') {
                return programName.includes('private') || programName.includes('tennis private');
            } else if (activeCategoryFilter === 'Camps') {
                return programName.includes('camp') || programName.includes('pass');
            } else if (activeCategoryFilter === 'Clinics') {
                return programName.includes('clinic') || programName.includes('high performance');
            }
            return false; 
        });
    }
    console.log(`HISTORY.HTML: Displaying ${finalDisplayLessons.length} lessons for category '${activeCategoryFilter}' and search '${searchTerm}'`);
        
    renderPastLessonsTable(finalDisplayLessons, 'past-lessons-table-container', 'No matching past lessons found.');
  }

  window.addEventListener('DOMContentLoaded', () => {
    enableHistoryEditingBtn = document.getElementById('enable-history-editing-btn');
    saveHistoryBtn = document.getElementById('save-history-btn');
    historyTableContainer = document.getElementById('past-lessons-table-container'); // Ensure this ID matches your table container

    loadHistory(); // Initial load of lesson history
    
    if (enableHistoryEditingBtn) {
        enableHistoryEditingBtn.addEventListener('click', () => {
            editing = !editing;
            enableHistoryEditingBtn.textContent = editing ? 'Disable Editing' : 'Enable Editing';
            if (saveHistoryBtn) saveHistoryBtn.disabled = !editing;

            const cells = document.querySelectorAll('.history-cell');
            cells.forEach(td => {
                if (td.dataset.field === 'referral_source') {
                    td.contentEditable = false; // Main TD is not editable, select is
                    if (editing) {
                        const originalValue = td.dataset.originalValue;
                        td.innerHTML = ''; // Clear current text content
                        const selectEl = document.createElement('select');
                        selectEl.className = 'history-referral-select'; // For styling or specific targeting if needed
                        
                        const options = [
                            { value: '', text: 'None' },
                            { value: 'Ricardo', text: 'Referred by Ricardo' },
                            { value: 'Jacob', text: "Jacob's Own" },
                            { value: 'Paula', text: "Paula's Own" },
                            { value: 'Zach', text: "Zach's Own" },
                            { value: 'RicardoOwn', text: "Ricardo's Own" }
                        ];

                        options.forEach(opt => {
                            const optionEl = document.createElement('option');
                            optionEl.value = opt.value;
                            optionEl.textContent = opt.text;
                            if (opt.value === originalValue) {
                                optionEl.selected = true;
                            }
                            selectEl.appendChild(optionEl);
                        });
                        td.appendChild(selectEl);
                    } else { // Disabling editing
                        const selectEl = td.querySelector('select.history-referral-select');
                        if (selectEl) {
                            const selectedText = selectEl.options[selectEl.selectedIndex]?.text || selectEl.value;
                            td.innerHTML = ''; // Clear the select
                            td.textContent = selectedText;
                            // td.dataset.originalValue = selectEl.value; // Update originalValue if change is "committed" to cell display
                        }
                    }
                } else { // For other editable cells
                    td.contentEditable = editing;
                    if (!editing) {
                        td.blur(); 
                    }
                }
            });
        });
    }

    if (saveHistoryBtn) {
        saveHistoryBtn.addEventListener('click', async () => {
            if (!confirm('Are you sure you want to save all changes to the history?')) return;

            if (enableHistoryEditingBtn) enableHistoryEditingBtn.disabled = true;
            saveHistoryBtn.disabled = true;

            const updates = [];
            document.querySelectorAll('.history-cell').forEach(td => {
                if (td.contentEditable === 'true') { // Ensure we only check editable cells
                    const bookingId = td.dataset.id;
                    const fieldName = td.dataset.field;
                    const originalValue = td.dataset.originalValue;
                    let newValue = td.innerText.trim();

                    // Special handling for date display vs actual value if needed
                    // Special handling for fields before comparison and for payload
                    if (fieldName === 'date' && td.innerText.includes('/')) {
                        // Attempt to convert display MM/DD/YYYY to YYYY-MM-DD for consistency if user edits this way
                        // This is a basic conversion and might need a more robust date parsing library for other formats
                        const parts = newValue.split('/');
                        if (parts.length === 3) {
                            newValue = `${parts[2]}-${parts[0].padStart(2, '0')}-${parts[1].padStart(2, '0')}`;
                        }
                        // It's generally better to use originalValue for dates if display format is ambiguous
                        // or use a proper date picker input when editing.
                        // For this implementation, we'll assume originalValue is the reliable YYYY-MM-DD.
                        // If user manually types a date, it should be YYYY-MM-DD or server validation will catch it.
                    } else if (fieldName === 'lesson_cost') {
                        newValue = newValue.replace('$', '').trim();
                    } else if (fieldName === 'paid') {
                        // Normalize to "true" or "false" string for consistent comparison and sending
                        const lowerNewValue = newValue.toLowerCase();
                        if (lowerNewValue === 'yes' || lowerNewValue === 'true') {
                            newValue = 'true';
                        } else if (lowerNewValue === 'no' || lowerNewValue === 'false') {
                            newValue = 'false';
                        }
                        // originalValue for 'paid' is already "true" or "false" string
                    }

                    if (newValue !== originalValue) {
                        updates.push({
                            bookingId: bookingId,
                            fieldName: fieldName,
                            newValue: newValue,
                            originalValueForDebug: originalValue 
                        });
                    }
                }
            });

            if (updates.length === 0) {
                alert('No actual changes detected to save.');
                if (enableHistoryEditingBtn) enableHistoryEditingBtn.disabled = false;
                if (editing) { // If editing was active, save button should reflect that (it's disabled if no changes)
                   saveHistoryBtn.disabled = false; 
                } else {
                   saveHistoryBtn.disabled = true;
                }
                return;
            }

            let successes = 0;
            let failures = 0;
            const failureDetails = [];

            for (const upd of updates) {
                try {
                    const res = await fetch(`/api/admin/history/${upd.bookingId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json', 'Credentials': 'include' },
                        body: JSON.stringify({ field: upd.fieldName, value: upd.newValue })
                    });
                    if (res.ok) {
                        successes++;
                    } else {
                        failures++;
                        const errData = await res.json().catch(() => ({ message: `Update failed for ID ${upd.bookingId}, Field ${upd.fieldName} with status ${res.status}` }));
                        failureDetails.push(errData.message);
                    }
                } catch (networkError) {
                    failures++;
                    failureDetails.push(`Network error for ID ${upd.bookingId}, Field ${upd.fieldName}: ${networkError.message}`);
                }
            }

            let summaryMessage = `${successes} updates successful.`;
            if (failures > 0) {
                summaryMessage += `\n${failures} updates failed.\nDetails:\n${failureDetails.join('\n')}`;
            }
            alert(summaryMessage);

            // Reset editing state
            editing = false;
            if (enableHistoryEditingBtn) {
                enableHistoryEditingBtn.disabled = false;
                enableHistoryEditingBtn.textContent = 'Enable Editing';
            }
            if (saveHistoryBtn) saveHistoryBtn.disabled = true;
            document.querySelectorAll('.history-cell').forEach(cell => cell.contentEditable = false);
            
            loadHistory(); // Refresh table
        });
    }
    
    // Keep existing bulk cost update button logic if it's still relevant
    // Ensure bulkCostUpdateButton is declared before use and consistently named.
    const bulkCostUpdateButton = document.querySelector('.bulk-update-costs-btn[data-table-id="past-lessons-table-container"]');
    
    if (bulkCostUpdateButton) {
        bulkCostUpdateButton.addEventListener('click', function() {
            const tableId = this.getAttribute('data-table-id'); // 'past-lessons-table-container'
            if (tableId) { 
                 handleBulkUpdatePrices(tableId);
            } else {
                // This case should ideally not be reached if the button is correctly identified.
                console.error('Bulk update button on history page clicked without a data-table-id attribute or button not found.');
            }
        });
    } else {
        console.warn("Bulk cost update button for 'past-lessons-table-container' not found on DOMContentLoaded. Ensure HTML is correct.");
    }

    const searchInput = document.getElementById('historySearchInput');
    if (searchInput) {
        searchInput.addEventListener('input', () => {
            const searchTerm = searchInput.value.toLowerCase().trim();
            filterAndRenderHistory(searchTerm);
        });
    }
    const filterButtons = document.querySelectorAll('#category-filters .category-filter-button');
    filterButtons.forEach(button => {
        button.addEventListener('click', () => {
            activeCategoryFilter = button.getAttribute('data-category');
            filterButtons.forEach(btn => btn.classList.remove('active-filter-button'));
            button.classList.add('active-filter-button');
            const currentSearchTerm = searchInput ? searchInput.value.toLowerCase().trim() : '';
            filterAndRenderHistory(currentSearchTerm); 
        });
    });
    // Note: The checkSession() and logout() functions are in the subsequent script tag,
    // so their functionality should remain as is.
  });
</script>
  <script>
  // This entire block is for mobile menu and session management, remains unchanged.
  document.addEventListener('DOMContentLoaded', () => {
      const menuToggle = document.querySelector('.mobile-menu-toggle');
      const mobileMenuClose = document.querySelector('.mobile-menu-close');
      const mainNav = document.querySelector('nav.main-navigation');

      if (menuToggle && mainNav && mobileMenuClose) {
          menuToggle.addEventListener('click', () => {
              const isMenuOpen = mainNav.classList.toggle('mobile-menu--open');
              menuToggle.setAttribute('aria-expanded', isMenuOpen);
              if (isMenuOpen) {
                  menuToggle.innerHTML = '&times;'; 
                  menuToggle.setAttribute('aria-label', 'Close navigation menu');
              } else {
                  menuToggle.innerHTML = '&#9776;'; 
                  menuToggle.setAttribute('aria-label', 'Open navigation menu');
              }
          });
          mobileMenuClose.addEventListener('click', () => {
              mainNav.classList.remove('mobile-menu--open');
              if (menuToggle) {
                 menuToggle.setAttribute('aria-expanded', 'false');
                 menuToggle.innerHTML = '&#9776;'; 
                 menuToggle.setAttribute('aria-label', 'Open navigation menu');
              }
          });
      }
      const mobileNavLinks = document.querySelectorAll('.mobile-menu-container a');
      if (mainNav && mobileNavLinks.length > 0) {
          mobileNavLinks.forEach(link => {
              link.addEventListener('click', () => {
                  if (mainNav.classList.contains('mobile-menu--open')) {
                      mainNav.classList.remove('mobile-menu--open');
                      if (menuToggle) {
                          menuToggle.setAttribute('aria-expanded', 'false');
                          menuToggle.innerHTML = '&#9776;';
                          menuToggle.setAttribute('aria-label', 'Open navigation menu');
                      }
                  }
              });
          });
      }
      async function checkSession() {
          const existingGreeting = document.querySelector('.welcome-greeting');
          if (existingGreeting) existingGreeting.remove();
          try {
              const res = await fetch('/api/check-session', { credentials: 'include' });
              const data = await res.json(); 
              const authContainerDesktop = document.getElementById('authContainerDesktop');
              const authContainerMobile = document.getElementById('authContainerMobile');
              if (data && data.loggedIn === true && data.isAdmin === true) {
                  const portalButtonText = data.firstName ? 'Admin (' + data.firstName + ')' : 'Admin Portal';
                  const loggedInHTML = '<a href="admin.html"><button>' + portalButtonText + '</button></a><button onclick="logout()">Logout</button>';
                  const loggedInMobileHTML = loggedInHTML; 
                  if (authContainerDesktop) authContainerDesktop.innerHTML = loggedInHTML;
                  if (authContainerMobile) authContainerMobile.innerHTML = loggedInMobileHTML;
                  const welcomeMessageText = data.firstName ? 'Welcome, ' + data.firstName + '!' : 'Welcome, Admin!';
                  const greeting = document.createElement('div');
                  greeting.className = 'welcome-greeting';
                  greeting.textContent = welcomeMessageText;
                  greeting.style.cssText = 'background:#0c3c78;color:white;padding:10px;text-align:center;font-weight:bold;';
                  const existingGreeting = document.querySelector('.welcome-greeting');
                  if (existingGreeting) existingGreeting.remove();
                  if(document.body.firstChild) { 
                      document.body.insertBefore(greeting, document.body.firstChild);
                  } else { 
                      document.body.appendChild(greeting);
                  }
              } else {
                  window.location.href = 'login.html'; 
                  const loggedOutHTML = `<a href="login.html"><button>Login</button></a>`;
                  if (authContainerDesktop) authContainerDesktop.innerHTML = loggedOutHTML;
                  if (authContainerMobile) authContainerMobile.innerHTML = loggedOutHTML;
              }
          } catch (err) {
              console.error('Session check failed, redirecting to login:', err);
              window.location.href = 'login.html'; 
              const authContainerDesktop = document.getElementById('authContainerDesktop');
              const authContainerMobile = document.getElementById('authContainerMobile');
              const loggedOutHTML = `<a href="login.html"><button>Login</button></a>`;
              if (authContainerDesktop) authContainerDesktop.innerHTML = loggedOutHTML;
              if (authContainerMobile) authContainerMobile.innerHTML = loggedOutHTML;
          }
      }
      window.logout = function() { 
          fetch('/api/logout', { method: 'POST', credentials: 'include' })
              .then(() => {
                  const existingGreeting = document.querySelector('.welcome-greeting');
                  if (existingGreeting) existingGreeting.remove();
                  document.cookie = "userFirstName=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
                  window.location.href = 'login.html'; 
              });
      }
      checkSession(); 
  });
  </script>
</body>
</html>