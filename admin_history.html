<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lesson History - Admin Portal - C2 Tennis Academy</title>

  <style>
    html, body { height: 100%; margin: 0; display: flex; flex-direction: column; font-family: Arial, sans-serif; }
    header, footer { background-color: #0c3c78; color: white; text-align: center; padding: 20px; }
    nav { background-color: #092e5e; display: flex; justify-content: center; }
    nav a { color: white; padding: 14px 20px; text-decoration: none; }
    nav a:hover { background-color: #0f4fa0; }
    section { flex: 1; padding: 40px 20px; max-width: 1400px; width: 90%; margin: auto; background: white; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    h2 { color: #0c3c78; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { padding: 8px; border:1px solid #ddd; }
    thead th { background: #0c3c78; color: white; }
/* === Global Header & Navigation Styles (Finalized Version) === */
     header {
       background-color: #0c3c78; 
       color: white; 
       padding: 30px 20px; 
       position: relative; 
       text-align: center; 
     }
     .header-content { 
       display: flex; justify-content: center; align-items: center; 
       max-width: 1200px; margin: 0 auto;
       position: relative; 
     }
     .site-title { text-align: center; } 
     .site-title h1 { 
       font-size: 2.2em;    
       margin-top: 0;
       margin-bottom: 0; 
       color: white; 
     } 
     .site-title p { 
       font-size: 1em;    
       margin-top: 0;
       margin-bottom: 0;
       color: #f0f0f0;
     }
     
     .mobile-menu-toggle { display: none; background: none; border: none; color: white; font-size: 28px; cursor: pointer; padding: 5px; }
     nav.main-navigation { background-color: #092e5e; }
     .nav-wrapper-desktop { 
         display: flex; justify-content: center; align-items: center;
         width: 100%; max-width: 1200px; margin: 0 auto; padding: 0 20px; box-sizing: border-box;
     }
     ul.nav-links-desktop { list-style: none; margin: 0; padding: 0; display: flex; }
     ul.nav-links-desktop li a { color: white; padding: 14px 20px; text-decoration: none; display: block; } 
     ul.nav-links-desktop li a:hover { background-color: #0f4fa0; }
     ul.nav-links-desktop li a.highlighted-nav, ul.nav-links-desktop li a.current-page { 
        background-color: #d8f352; color: black; font-weight: bold; border-radius: 5px; 
     }
     ul.nav-links-desktop li a.highlighted-nav:hover, ul.nav-links-desktop li a.current-page:hover { background-color: #c1da3b; }
     
     .auth-buttons-desktop { 
       position: absolute;
       top: 20px; 
       right: 20px; 
       display: flex;
       align-items: center;
       gap: 15px; 
     }
     .auth-buttons-desktop a button, .auth-buttons-desktop button {
       background-color: white; color: #0c3c78; border: none; padding: 10px 20px; 
       border-radius: 5px; font-weight: bold; cursor: pointer;
       transition: all 0.3s ease; white-space: nowrap;
     }
     .auth-buttons-desktop a button:hover, .auth-buttons-desktop button:hover { background-color: #0f4fa0; color: white; }
     .mobile-menu-container {
       display: none; background-color: #092e5e; position: fixed;
       top: 0; left: 0; width: 100%; height: 100%;
       z-index: 1000; padding-top: 20px;
       box-sizing: border-box; overflow-y: auto; text-align: center;
     }
     nav.main-navigation.mobile-menu--open .mobile-menu-container { display: block; }
     .mobile-menu-close {
        display: block; 
        position: absolute; 
        top: 10px; 
        right: 10px; 
        left: auto; 
        bottom: auto; 
        background: none; 
        border: none; 
        color: white; 
        font-size: 28px; 
        cursor: pointer;
        z-index: 10; 
     }
     ul.nav-links-mobile { list-style: none; padding: 0; margin: 50px 0 20px; }
     ul.nav-links-mobile li a {
       color: white; padding: 15px 20px; text-decoration: none; display: block;
       border-bottom: 1px solid #0c3c78;
     }
     ul.nav-links-mobile li:last-child a { border-bottom: none; }
     ul.nav-links-mobile li a:hover { background-color: #0f4fa0; }
     .auth-buttons-mobile { padding: 20px; }
     .auth-buttons-mobile a button, .auth-buttons-mobile button {
       background-color: #d8f352; color: #0c3c78; border: none; padding: 12px 20px;
       border-radius: 5px; font-weight: bold; cursor: pointer; display: block;
       width: 80%; max-width: 250px; margin: 10px auto; box-sizing: border-box;
     }
     .auth-buttons-mobile a button:hover, .auth-buttons-mobile button:hover { background-color: #c1da3b; }
     
     footer { 
        background-color: #0c3c78; color: white; text-align: center; padding: 20px; margin-top:auto; 
     }

     @media (max-width: 768px) {
       body { -webkit-text-size-adjust: 100%; -ms-text-size-adjust: 100%; } 
       header { padding: 10px 15px; } 
       .header-content {
         justify-content: space-between; 
         width:100%; 
       }
       .site-title { text-align: left; }
       .site-title h1 { font-size: 1.2em; margin-bottom: 0; }
       .site-title p { display: none; } 
       .mobile-menu-toggle { display: block; }
       .nav-wrapper-desktop { display: none; }
       .auth-buttons-desktop { display: none; } 
       nav.main-navigation { padding: 0; background-color: transparent; }
      h2 {
        margin-bottom: 20px; 
      }
      section {
        padding: 20px 10px; 
      }
    }
ul.nav-links-desktop li a.highlighted-nav {
  border-radius: 9999px;
}
ul.nav-links-mobile li a.highlighted-nav {
  border-radius: 9999px;
}
ul.nav-links-desktop li a {
  border-radius: 9999px;
}
ul.nav-links-desktop li a.highlighted-nav {
  border-radius: 9999px;
}
ul.nav-links-mobile li a {
  border-radius: 9999px;
}

.explore-button {
  font-family: Arial, sans-serif;
  font-size: 1rem;
  font-weight: 400;
  background-color: #3b82f6; 
  color: white !important; 
  padding: 0.75rem 2rem;
  border: none;
  border-radius: 9999px; 
  box-shadow:
    0 10px 15px -3px rgba(0, 0, 0, 0.1),
    0   4px  6px -2px rgba(0, 0, 0, 0.05);
  cursor: pointer;
  transform-origin: center center;
  transition: background-color 0.2s ease, transform 0.2s ease;
  text-decoration: none; 
  display: inline-block; 
  text-align: center;
  margin-top: 30px; 
}

.explore-button:hover {
  background-color: #2563eb; 
  transform: scale(1.05);
  color: white !important;
  text-decoration: none;
}

.category-filter-button {
  background-color: #f0f0f0; 
  color: #333;            
  border: 1px solid #ccc;
  padding: 8px 15px;
  margin: 0 5px 10px 0; 
  border-radius: 5px;
  cursor: pointer;
  font-size: 0.9rem;
  transition: background-color 0.2s ease, color 0.2s ease;
}
.category-filter-button:hover {
  background-color: #e0e0e0; 
}
.category-filter-button.active-filter-button {
  background-color: #0c3c78; 
  color: white;
  border-color: #0c3c78;
  font-weight: bold;
}
#category-filters-title {
    margin-top: 20px;
    margin-bottom: 10px;
    font-weight: bold;
    color: #0c3c78; 
}
.update-payment-btn {
    background-color: #4CAF50; /* Green */
    color: white;
    padding: 5px 10px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9em;
}
.update-payment-btn:hover {
    background-color: #45a049;
}
  </style>
</head>
<body>

<header>
  <div class="header-content">
    <div class="site-title">
      <h1>Lesson History</h1> 
      <p>C2 Tennis Academy</p> 
    </div>
    <button class="mobile-menu-toggle" aria-label="Open navigation menu" aria-expanded="false" aria-controls="mainNavigation">
      &#9776; 
    </button>
  </div>
  <div class="auth-buttons-desktop" id="authContainerDesktop">
  </div>
</header>

<nav class="main-navigation" id="mainNavigation">
  <div class="nav-wrapper-desktop"> 
     <ul class="nav-links-desktop">
       <li><a href="index.html">Home</a></li>
       <li><a href="about.html">About</a></li>
       <li><a href="programs.html">Programs</a></li>
       <li><a href="schedule.html">Schedule</a></li>
       <li><a href="contact.html">Contact</a></li>
     </ul>
  </div>
  <div class="mobile-menu-container">
    <button class="mobile-menu-close" aria-label="Close navigation menu">&times;</button>
    <ul class="nav-links-mobile">
      <li><a href="index.html">Home</a></li>
      <li><a href="about.html">About</a></li>
      <li><a href="programs.html">Programs</a></li>
      <li><a href="schedule.html">Schedule</a></li>
      <li><a href="contact.html">Contact</a></li>
    </ul>
    <div class="auth-buttons-mobile" id="authContainerMobile">
    </div>
  </div>
</nav>

  <section>
    <h2>Past Lesson History</h2>
    <div style="margin-bottom: 20px; margin-top: 10px;">
      <label for="historySearchInput" style="margin-right: 10px; font-weight: bold;">Search Past Lessons:</label>
      <input type="text" id="historySearchInput" placeholder="Enter keyword (student, program, coach, email, date)..." style="width: 50%; padding: 8px;">
    </div>
    <div id="category-filters-title">Filters:</div>
    <div id="category-filters" style="margin-bottom: 20px;">
      <button class="category-filter-button active-filter-button" data-category="All">All</button>
      <button class="category-filter-button" data-category="Privates">Private Lessons</button>
      <button class="category-filter-button" data-category="Camps">Camps & Passes</button>
      <button class="category-filter-button" data-category="Clinics">Clinics & Other</button>
    </div>
    
    <button id="enable-history-editing-btn" style="margin-bottom:10px;">Enable Editing</button>
    <div style="text-align:right; margin-bottom: 5px;">
      <button id="save-history-btn" disabled>Save All History Changes</button>
    </div>
    
    <!-- The bulk update button for costs is kept separate for now, can be integrated later if needed -->
    <div style="text-align: right; margin-bottom: 5px;">
        <button class="bulk-update-costs-btn" data-table-id="past-lessons-table-container" disabled>Update All Changed Prices</button>
        <button id="bulkUpdateButton" style="margin-left: 10px;">Bulk Update Placeholder</button>
    </div>
    <div id="past-lessons-table-container" style="margin-top: 20px;">
        <!-- The single table of past lessons will be rendered here by JavaScript -->
    </div>
  </section>

  <footer>
    <p>&copy; 2025 C2 Tennis Academy. All rights reserved.</p>
  </footer>

  <script>
  // This script block is intentionally left empty as the form-related JS was removed.
  // New JS logic will be added in the next script tag or by replacing this one.
  </script>

  <script>
// Corrected JavaScript logic provided by the user starts here
let allFetchedPastLessons = []; 
let activeCategoryFilter = 'All'; 
let editing = false; 

let enableHistoryEditingBtn;
let saveHistoryBtn;
let historyTableContainer; 
let bulkUpdateButton; // Added for the new bulk update button

function formatTime_12hr(timeStr) {
  if (!timeStr || !timeStr.includes(':')) { return timeStr; }
  const parts = timeStr.split(':');
  let hours = parseInt(parts[0], 10);
  const minutes = parseInt(parts[1], 10);
  const ampm = hours >= 12 ? 'PM' : 'AM';
  hours = hours % 12;
  hours = hours ? hours : 12; 
  const minutesStr = minutes < 10 ? '0' + minutes : minutes;
  return hours + ':' + minutesStr + ' ' + ampm;
}

function renderPastLessonsTable(lessonsArray, containerId, placeholderMessage) {
  const container = document.getElementById(containerId);
  if (!container) {
    console.error('Container not found for ID:', containerId);
    return;
  }

  if (lessonsArray.length === 0) {
    container.innerHTML = `<p>${placeholderMessage}</p>`;
    return;
  }

  let tableHTML = `
    <table style="width:100%; border-collapse:collapse; margin-top:10px;">
      <thead>
        <tr style="background:#0c3c78; color:white;">
          <th style="padding:8px; border:1px solid #ddd;"><input type="checkbox" id="selectAllHistoryRows"></th>
          <th style="padding:8px; border:1px solid #ddd;">Program</th>
          <th style="padding:8px; border:1px solid #ddd;">Coach</th>
          <th style="padding:8px; border:1px solid #ddd;">Date</th>
          <th style="padding:8px; border:1px solid #ddd;">Time</th>
          <th style="padding:8px; border:1px solid #ddd;">Student</th>
          <th style="padding:8px; border:1px solid #ddd;">Email</th>
          <th style="padding:8px; border:1px solid #ddd;">Phone</th>
          <th style="padding:8px; border:1px solid #ddd;">Lesson Cost</th>
          <th style="padding:8px; border:1px solid #ddd;">Referral Source</th>
          <th style="padding:8px; border:1px solid #ddd;">Paid</th>
          <th style="padding:8px; border:1px solid #ddd;">Actions</th>
        </tr>
      </thead>
      <tbody>
  `;

  lessonsArray.forEach(les => {
    const dateStr = les.date ? new Date(les.date).toLocaleDateString() : 'N/A';
    const formattedTime = les.time ? formatTime_12hr(les.time) : 'N/A';
    const referralSourceDisplay = les.referral_source || '—';
    const originalDate = les.date ? les.date.substring(0,10) : '';
    const isPaid = les.paid === true || String(les.paid).toLowerCase() === 'true';

    tableHTML += `
      <tr data-id="${les.id}">
        <td style="padding:8px; border:1px solid #ddd;"><input type="checkbox" class="history-row-checkbox" data-id="${les.id}"></td>
        <td class="history-cell" data-id="${les.id}" data-field="program" data-original-value="${les.program || ''}" style="padding:8px; border:1px solid #ddd;">${les.program || '—'}</td>
        <td class="history-cell" data-id="${les.id}" data-field="coach" data-original-value="${les.coach || ''}" style="padding:8px; border:1px solid #ddd;">${les.coach || '—'}</td>
        <td class="history-cell" data-id="${les.id}" data-field="date" data-original-value="${originalDate}" style="padding:8px; border:1px solid #ddd;">${dateStr}</td>
        <td class="history-cell" data-id="${les.id}" data-field="time" data-original-value="${les.time || ''}" style="padding:8px; border:1px solid #ddd;">${formattedTime}</td>
        <td class="history-cell" data-id="${les.id}" data-field="student" data-original-value="${les.student || ''}" style="padding:8px; border:1px solid #ddd;">${les.student || '—'}</td>
        <td style="padding:8px; border:1px solid #ddd;">${les.email || '—'}</td>
        <td style="padding:8px; border:1px solid #ddd;">${les.phone || '—'}</td>
        <td class="history-cell" data-id="${les.id}" data-field="lesson_cost" data-original-value="${les.lesson_cost !== null && les.lesson_cost !== undefined ? les.lesson_cost : ''}" style="padding:8px; border:1px solid #ddd;">${les.lesson_cost !== null && les.lesson_cost !== undefined ? les.lesson_cost : ''}</td>
        <td class="history-cell" data-id="${les.id}" data-field="referral_source" data-original-value="${referralSourceDisplay}" style="padding:8px; border:1px solid #ddd;">${referralSourceDisplay}</td>
        <td class="history-cell" data-id="${les.id}" data-field="paid" data-original-value="${String(isPaid)}" style="padding:8px; border:1px solid #ddd;">${isPaid ? 'Yes' : 'No'}</td>
        <td style="padding:8px; border:1px solid #ddd;">
          <button onclick="deleteAdminLesson(${les.id})">Delete</button>
        </td>
      </tr>
    `;
  });
  tableHTML += `</tbody></table>`;
  container.innerHTML = tableHTML;

  const selectAllCheckbox = document.getElementById('selectAllHistoryRows');
  if (selectAllCheckbox) {
    selectAllCheckbox.addEventListener('change', (event) => {
      document.querySelectorAll('.history-row-checkbox').forEach(checkbox => {
        checkbox.checked = event.target.checked;
      });
      if (bulkUpdateButton) bulkUpdateButton.disabled = !event.target.checked && !Array.from(document.querySelectorAll('.history-row-checkbox')).some(cb => cb.checked);
    });
  }

  document.querySelectorAll('.history-row-checkbox').forEach(checkbox => {
    checkbox.addEventListener('change', () => {
        if (bulkUpdateButton) {
            const anyChecked = Array.from(document.querySelectorAll('.history-row-checkbox')).some(cb => cb.checked);
            bulkUpdateButton.disabled = !anyChecked;
        }
        if (selectAllCheckbox && !checkbox.checked) {
            selectAllCheckbox.checked = false;
        }
    });
  });
}

async function loadHistory() {
  if (!historyTableContainer) historyTableContainer = document.getElementById('past-lessons-table-container');
  historyTableContainer.innerHTML = '<p>Loading history...</p>';
  
  try {
    const res = await fetch('/api/admin/lessons', { credentials: 'include' });
    if (!res.ok) {
      historyTableContainer.innerHTML = '<p style="color:red;">Could not load lesson history data.</p>';
      return;
    }
    const lessons = await res.json();
    const now = new Date();
    const pastLessons = lessons.filter(les => {
      if (!les.date) return false;
      const dateStr = les.date.substring(0, 10);
      const dateParts = dateStr.split('-');
      if (dateParts.length !== 3) return false;
      const year = parseInt(dateParts[0]);
      const month = parseInt(dateParts[1]) - 1;
      const day = parseInt(dateParts[2]);
      let hours = 23, minutes = 59, seconds = 59;
      if (les.time) {
        const timeParts = les.time.split(':');
        if (timeParts.length >= 2) {
          hours = parseInt(timeParts[0]);
          minutes = parseInt(timeParts[1]);
          seconds = timeParts[2] ? parseInt(timeParts[2]) : 0;
        }
      }
      try {
        const lessonDate = new Date(year, month, day, hours, minutes, seconds);
        return lessonDate < now;
      } catch (e) {
        console.error(`Error parsing date for lesson: ${les.id}`, e);
        return false;
      }
    });
    allFetchedPastLessons = [...pastLessons];
    filterAndRenderHistory('');
  } catch (error) {
    console.error('Error loading lesson history:', error);
    historyTableContainer.innerHTML = '<p style="color:red;">Failed to load history due to a network error.</p>';
  }
}

async function deleteAdminLesson(id) {
  if (!confirm('Are you sure you want to delete this lesson?')) return;
  try {
    const res = await fetch(`/api/admin/lessons/${id}`, { method: 'DELETE', credentials: 'include' });
    if (res.ok) {
      loadHistory();
    } else {
      alert('Delete failed: ' + await res.text());
    }
  } catch (err) {
    console.error('Error deleting lesson:', err);
    alert('Delete failed due to a network error.');
  }
}

function filterAndRenderHistory(searchTerm) {
  let searchFilteredLessons;
  if (!searchTerm) {
    searchFilteredLessons = [...allFetchedPastLessons];
  } else {
    searchFilteredLessons = allFetchedPastLessons.filter(les => {
      if (!les) return false;
      const dateStr = les.date ? new Date(les.date).toLocaleDateString().toLowerCase() : '';
      return [les.program, les.coach, les.student, les.email, les.phone, dateStr]
        .some(field => field && String(field).toLowerCase().includes(searchTerm));
    });
  }

  let finalDisplayLessons;
  if (activeCategoryFilter === 'All') {
    finalDisplayLessons = [...searchFilteredLessons];
  } else {
    finalDisplayLessons = searchFilteredLessons.filter(les => {
      if (!les || !les.program) return false;
      const programName = les.program.toLowerCase();
      if (activeCategoryFilter === 'Privates') return programName.includes('private');
      if (activeCategoryFilter === 'Camps') return programName.includes('camp') || programName.includes('pass');
      if (activeCategoryFilter === 'Clinics') return programName.includes('clinic') || programName.includes('high performance');
      return false;
    });
  }
  renderPastLessonsTable(finalDisplayLessons, 'past-lessons-table-container', 'No matching past lessons found.');
}

window.addEventListener('DOMContentLoaded', () => {
  enableHistoryEditingBtn = document.getElementById('enable-history-editing-btn');
  saveHistoryBtn = document.getElementById('save-history-btn');
  historyTableContainer = document.getElementById('past-lessons-table-container');
  bulkUpdateButton = document.getElementById('bulkUpdateButton'); // Initialize new button

  if(bulkUpdateButton) {
    bulkUpdateButton.disabled = true; // Initially disabled
    bulkUpdateButton.addEventListener('click', async () => {
        const selectedIds = Array.from(document.querySelectorAll('.history-row-checkbox:checked')).map(cb => cb.dataset.id);
        if(selectedIds.length === 0) {
            alert('No lessons selected for bulk update.');
            return;
        }
        // Placeholder for bulk update action type
        const actionType = prompt("Enter action type for selected lessons (e.g., 'markPaid', 'archive'):");
        if (!actionType) {
            alert('No action specified.');
            return;
        }
        alert(`Bulk updating ${selectedIds.length} lessons with action: ${actionType}. IDs: ${selectedIds.join(', ')}.\n(Actual update logic not yet implemented)`);
        // Example: await bulkUpdateLessons(selectedIds, actionType);
        // After action, potentially reload history or update UI
        // loadHistory(); 
        // document.getElementById('selectAllHistoryRows').checked = false; // Uncheck select all
        // bulkUpdateButton.disabled = true; // Disable button again
    });
  }


  loadHistory();

  if (enableHistoryEditingBtn) {
    enableHistoryEditingBtn.addEventListener('click', () => {
      editing = !editing;
      enableHistoryEditingBtn.textContent = editing ? 'Disable Editing' : 'Enable Editing';
      if (saveHistoryBtn) saveHistoryBtn.disabled = !editing;

      document.querySelectorAll('.history-cell').forEach(td => {
        if (td.dataset.field === 'referral_source') {
          td.contentEditable = false;
          if (editing) {
            const originalValue = td.dataset.originalValue === '—' ? '' : td.dataset.originalValue;
            td.innerHTML = '';
            const selectEl = document.createElement('select');
            selectEl.className = 'history-referral-select';
            const options = [
                { value: '', text: 'None' }, // "None" option with an empty string value
                { value: 'Ricardo', text: 'Referred by Ricardo' },
                { value: 'Jacob', text: 'Jacob - Own Booking' },
                { value: 'Paula', text: 'Paula - Own Booking' },
                { value: 'Zach', text: 'Zach - Own Booking' },
                { value: 'RicardoOwn', text: 'Ricardo - Teaches Himself' }
            ];
            options.forEach(opt => {
              const optionEl = document.createElement('option');
              optionEl.value = opt.value;
              optionEl.textContent = opt.text;
              if (opt.value === originalValue) optionEl.selected = true;
              selectEl.appendChild(optionEl);
            });
            td.appendChild(selectEl);
          } else {
            const selectEl = td.querySelector('select.history-referral-select');
            if (selectEl) {
              const selectedText = selectEl.options[selectEl.selectedIndex]?.text || selectEl.value;
              td.innerHTML = '';
              td.textContent = selectedText || '—';
            }
          }
        } else { // For other editable cells
          td.contentEditable = editing;
          if (!editing) td.blur();
        }
      });
    });
  }

  if (saveHistoryBtn) {
    saveHistoryBtn.addEventListener('click', async () => {
      if (!confirm('Are you sure you want to save all changes to the history?')) return;
      if (enableHistoryEditingBtn) enableHistoryEditingBtn.disabled = true;
      saveHistoryBtn.disabled = true;

      const updates = [];
      document.querySelectorAll('.history-cell[data-id]').forEach(td => {
        console.log(`Processing cell for save: Booking ID ${td.dataset.id}, Field: ${td.dataset.field}, Original Value Attr: '${td.dataset.originalValue}'`);
        const bookingId = td.dataset.id;
        const fieldName = td.dataset.field;
        const originalValue = td.dataset.originalValue;
        let newValue;
        let changed = false;

        if (fieldName === 'referral_source') {
          console.log(`Entering referral_source specific logic for Booking ID ${bookingId}. Cell content editable: ${td.contentEditable}`);
          const selectEl = td.querySelector('select.history-referral-select');
          if (selectEl) {
            newValue = selectEl.value;
            // Normalize originalValue of '—' to empty string for comparison
            const normalizedOriginalValue = originalValue === '—' ? '' : originalValue;

            console.log(`Referral Save Check: Booking ID ${bookingId}`);
            console.log(`  Original Value (from dataset): '${originalValue}'`);
            console.log(`  Normalized Original Value: '${normalizedOriginalValue}'`);
            console.log(`  New Value (from select): '${newValue}'`);
            console.log(`  Comparison: '${newValue}' !== '${normalizedOriginalValue}' is ${newValue !== normalizedOriginalValue}`);
            
            if (newValue !== normalizedOriginalValue) changed = true;
          }
        } else if (td.contentEditable === 'true') {
          newValue = td.innerText.trim();
          if (fieldName === 'date' && td.innerText.includes('/')) {
            const parts = newValue.split('/');
            if (parts.length === 3) newValue = `${parts[2]}-${parts[0].padStart(2, '0')}-${parts[1].padStart(2, '0')}`;
          } else if (fieldName === 'lesson_cost') {
            newValue = newValue.replace('$', '').trim();
            if (newValue === '' && originalValue !== '') newValue = null; // Allow clearing cost
            else if (newValue !== '' && isNaN(Number(newValue))) { // If not empty and not a number, skip change
                console.warn(`Invalid cost for booking ${bookingId}: ${newValue}. Skipping update for this field.`);
                return; 
            }
          } else if (fieldName === 'paid') {
            const lowerNewValue = newValue.toLowerCase();
            if (lowerNewValue === 'yes' || lowerNewValue === 'true') newValue = 'true';
            else if (lowerNewValue === 'no' || lowerNewValue === 'false') newValue = 'false';
          }
          if (newValue !== originalValue) changed = true;
        }

        if (changed) {
          updates.push({ bookingId, fieldName, newValue, originalValueForDebug: originalValue });
        }
      });

      if (updates.length === 0) {
        alert('No actual changes detected to save.');
        if (enableHistoryEditingBtn) enableHistoryEditingBtn.disabled = false;
        if (editing) saveHistoryBtn.disabled = false;
        else saveHistoryBtn.disabled = true;
        return;
      }

      let successes = 0;
      let failures = 0;
      const failureDetails = [];

      for (const upd of updates) {
        try {
          const res = await fetch(`/api/admin/history/${upd.bookingId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json', 'Credentials': 'include' },
            body: JSON.stringify({ field: upd.fieldName, value: upd.newValue })
          });
          if (res.ok) {
            successes++;
          } else {
            failures++;
            const errData = await res.json().catch(() => ({ message: `Update failed for ID ${upd.bookingId}, Field ${upd.fieldName} with status ${res.status}` }));
            failureDetails.push(errData.message || `Failed for ${upd.fieldName}`);
          }
        } catch (networkError) {
          failures++;
          failureDetails.push(`Network error for ID ${upd.bookingId}, Field ${upd.fieldName}: ${networkError.message}`);
        }
      }

      let summaryMessage = `${successes} updates successful.`;
      if (failures > 0) summaryMessage += `\n${failures} updates failed.\nDetails:\n${failureDetails.join('\n')}`;
      alert(summaryMessage);

      editing = false;
      if (enableHistoryEditingBtn) {
        enableHistoryEditingBtn.disabled = false;
        enableHistoryEditingBtn.textContent = 'Enable Editing';
      }
      if (saveHistoryBtn) saveHistoryBtn.disabled = true;
      document.querySelectorAll('.history-cell').forEach(cell => cell.contentEditable = false);
      loadHistory();
    });
  }

  const bulkCostUpdateButton = document.querySelector('.bulk-update-costs-btn');
  if (bulkCostUpdateButton) {
    // This button seems to be for a different bulk update type (costs from inputs, not general actions)
    // Its existing logic (handleBulkUpdatePrices) should be preserved if it's still meant to function.
    // For now, I'm assuming its event listener setup is separate or handled by its own function.
    // If it was meant to be the `bulkUpdateButton` for checkbox actions, this needs clarification.
    // The original prompt mentioned adding a new button with ID "bulkUpdateButton".
    // The existing button with class "bulk-update-costs-btn" might be different.
    // The provided code has `bulkUpdateButton = document.getElementById('bulkUpdateButton');`
    // and its event listener. The `handleBulkUpdatePrices` and its button seems distinct.
  }

  const searchInput = document.getElementById('historySearchInput');
  if (searchInput) {
    searchInput.addEventListener('input', () => {
      filterAndRenderHistory(searchInput.value.toLowerCase().trim());
    });
  }

  const filterButtons = document.querySelectorAll('#category-filters .category-filter-button');
  filterButtons.forEach(button => {
    button.addEventListener('click', () => {
      activeCategoryFilter = button.getAttribute('data-category');
      filterButtons.forEach(btn => btn.classList.remove('active-filter-button'));
      button.classList.add('active-filter-button');
      filterAndRenderHistory(searchInput ? searchInput.value.toLowerCase().trim() : '');
    });
  });
});
// Corrected JavaScript logic provided by the user ends here
</script>
  <script>
  // This entire block is for mobile menu and session management, remains unchanged.
  document.addEventListener('DOMContentLoaded', () => {
      const menuToggle = document.querySelector('.mobile-menu-toggle');
      const mobileMenuClose = document.querySelector('.mobile-menu-close');
      const mainNav = document.querySelector('nav.main-navigation');

      if (menuToggle && mainNav && mobileMenuClose) {
          menuToggle.addEventListener('click', () => {
              const isMenuOpen = mainNav.classList.toggle('mobile-menu--open');
              menuToggle.setAttribute('aria-expanded', isMenuOpen);
              if (isMenuOpen) {
                  menuToggle.innerHTML = '&times;'; 
                  menuToggle.setAttribute('aria-label', 'Close navigation menu');
              } else {
                  menuToggle.innerHTML = '&#9776;'; 
                  menuToggle.setAttribute('aria-label', 'Open navigation menu');
              }
          });
          mobileMenuClose.addEventListener('click', () => {
              mainNav.classList.remove('mobile-menu--open');
              if (menuToggle) {
                 menuToggle.setAttribute('aria-expanded', 'false');
                 menuToggle.innerHTML = '&#9776;'; 
                 menuToggle.setAttribute('aria-label', 'Open navigation menu');
              }
          });
      }
      const mobileNavLinks = document.querySelectorAll('.mobile-menu-container a');
      if (mainNav && mobileNavLinks.length > 0) {
          mobileNavLinks.forEach(link => {
              link.addEventListener('click', () => {
                  if (mainNav.classList.contains('mobile-menu--open')) {
                      mainNav.classList.remove('mobile-menu--open');
                      if (menuToggle) {
                          menuToggle.setAttribute('aria-expanded', 'false');
                          menuToggle.innerHTML = '&#9776;';
                          menuToggle.setAttribute('aria-label', 'Open navigation menu');
                      }
                  }
              });
          });
      }
      async function checkSession() {
          const existingGreeting = document.querySelector('.welcome-greeting');
          if (existingGreeting) existingGreeting.remove();
          try {
              const res = await fetch('/api/check-session', { credentials: 'include' });
              const data = await res.json(); 
              const authContainerDesktop = document.getElementById('authContainerDesktop');
              const authContainerMobile = document.getElementById('authContainerMobile');
              if (data && data.loggedIn === true && data.isAdmin === true) {
                  const portalButtonText = data.firstName ? 'Admin (' + data.firstName + ')' : 'Admin Portal';
                  const loggedInHTML = '<a href="admin.html"><button>' + portalButtonText + '</button></a><button onclick="logout()">Logout</button>';
                  const loggedInMobileHTML = loggedInHTML; 
                  if (authContainerDesktop) authContainerDesktop.innerHTML = loggedInHTML;
                  if (authContainerMobile) authContainerMobile.innerHTML = loggedInMobileHTML;
                  const welcomeMessageText = data.firstName ? 'Welcome, ' + data.firstName + '!' : 'Welcome, Admin!';
                  const greeting = document.createElement('div');
                  greeting.className = 'welcome-greeting';
                  greeting.textContent = welcomeMessageText;
                  greeting.style.cssText = 'background:#0c3c78;color:white;padding:10px;text-align:center;font-weight:bold;';
                  const existingGreeting = document.querySelector('.welcome-greeting');
                  if (existingGreeting) existingGreeting.remove();
                  if(document.body.firstChild) { 
                      document.body.insertBefore(greeting, document.body.firstChild);
                  } else { 
                      document.body.appendChild(greeting);
                  }
              } else {
                  window.location.href = 'login.html'; 
                  const loggedOutHTML = `<a href="login.html"><button>Login</button></a>`;
                  if (authContainerDesktop) authContainerDesktop.innerHTML = loggedOutHTML;
                  if (authContainerMobile) authContainerMobile.innerHTML = loggedOutHTML;
              }
          } catch (err) {
              console.error('Session check failed, redirecting to login:', err);
              window.location.href = 'login.html'; 
              const authContainerDesktop = document.getElementById('authContainerDesktop');
              const authContainerMobile = document.getElementById('authContainerMobile');
              const loggedOutHTML = `<a href="login.html"><button>Login</button></a>`;
              if (authContainerDesktop) authContainerDesktop.innerHTML = loggedOutHTML;
              if (authContainerMobile) authContainerMobile.innerHTML = loggedOutHTML;
          }
      }
      window.logout = function() { 
          fetch('/api/logout', { method: 'POST', credentials: 'include' })
              .then(() => {
                  const existingGreeting = document.querySelector('.welcome-greeting');
                  if (existingGreeting) existingGreeting.remove();
                  document.cookie = "userFirstName=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
                  window.location.href = 'login.html'; 
              });
      }
      checkSession(); 
  });
  </script>
</body>
</html>