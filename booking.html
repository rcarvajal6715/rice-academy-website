
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Book a Session - C2 Tennis Academy</title>
  <meta name="description" content="C2 Tennis Academy in Texas offers elite tennis training, junior programs, and high-performance coaching using AI and video analysis.">
  <meta name="keywords" content="C2 Tennis Academy, tennis lessons Texas, UTR tennis, junior tennis, adult clinics, tennis training academy">
  <meta name="author" content="C2 Tennis Academy">
  <meta property="og:title" content="C2 Tennis Academy | Elite Tennis Training in Texas">
  <meta property="og:description" content="Boost your UTR with expert coaching, AI video feedback, and elite tennis programs at C2 Tennis Academy.">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://c2tennisacademy.com/">

  <!-- Flatpickr CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <style>
    html, body {
      /* height: 100%; Ensure this doesn't conflict if booking page content is long */
      margin: 0;
      display: flex;
      flex-direction: column;
      font-family: Arial, sans-serif;
    }
    main {
      flex: 1; /* Allows footer to stick to bottom if content is short */
    }
    footer {
      background-color: #0c3c78;
      color: white;
      text-align: center;
      padding: 20px;
      /* position: relative; /* Generally not needed unless specific positioning is required */
    }

    /* === Styles from index.html for Header & Navigation === */
    header {
       background-color: #0c3c78; 
       color: white; 
       padding: 30px 20px;
       position: relative; 
       text-align: center; 
     }
     .header-content {
       display: flex; justify-content: center; align-items: center;
       max-width: 1200px; margin: 0 auto;
       position: relative;
     }
     .site-title { text-align: center; }
     .site-title h1 { 
       font-size: 2.2em;
       margin-top: 0;
       margin-bottom: 0.25em; 
       color: white; 
     } 
     .site-title p { 
       font-size: 1em;    
       margin-top: 0;
       margin-bottom: 0;
       color: #f0f0f0;
     }

     .mobile-menu-toggle { display: none; background: none; border: none; color: white; font-size: 28px; cursor: pointer; padding: 5px; }

     nav.main-navigation { background-color: #092e5e; }
     .nav-wrapper-desktop {
         display: flex; justify-content: center; align-items: center;
         width: 100%; max-width: 1200px; margin: 0 auto; padding: 0 20px; box-sizing: border-box;
     }
     ul.nav-links-desktop { list-style: none; margin: 0; padding: 0; display: flex; }
     ul.nav-links-desktop li a { color: white; padding: 14px 20px; text-decoration: none; display: block; }
     ul.nav-links-desktop li a:hover { background-color: #0f4fa0; }
     /* Highlight for "Book" link if needed on booking.html, can be added via class */
     ul.nav-links-desktop li a.highlighted-nav { background-color: #d8f352; color: black; font-weight: bold; border-radius: 5px; }
     ul.nav-links-desktop li a.highlighted-nav:hover { background-color: #c1da3b; }


     .auth-buttons-desktop {
       position: absolute;
       top: 20px; 
       right: 20px; 
       display: flex;
       align-items: center;
     }
     .auth-buttons-desktop a button, .auth-buttons-desktop button,
     .auth-buttons-desktop a.coach-link-button { /* Include coach link button styling here */
       background-color: white; color: #0c3c78; border: none; padding: 10px 20px;
       margin-left: 10px; border-radius: 5px; font-weight: bold; cursor: pointer;
       transition: all 0.3s ease; white-space: nowrap; text-decoration: none; /* For <a> tags */
       display: inline-flex; align-items: center; justify-content: center; /* For proper button appearance on <a> */
     }
     .auth-buttons-desktop a button:hover, .auth-buttons-desktop button:hover,
     .auth-buttons-desktop a.coach-link-button:hover { background-color: #0f4fa0; color: white; }
     
     .auth-buttons-desktop a.coach-link-button { /* Specific override for coach link if needed */
        background-color: #d8f352;
        color: #0c3c78;
     }
     .auth-buttons-desktop a.coach-link-button:hover {
        background-color: #c1da3b;
        color: #0c3c78;
     }


     .mobile-menu-container {
       display: none; background-color: #092e5e; position: fixed;
       top: 0; left: 0; width: 100%; height: 100%;
       z-index: 1000; 
       padding-top: 20px; 
       box-sizing: border-box; overflow-y: auto; text-align: center;
     }
     nav.main-navigation.mobile-menu--open .mobile-menu-container { display: block; }
     .mobile-menu-close {
        display: block; 
        position: absolute;
        top: 15px;
        right: 20px;
        background: none;
        border: none;
        color: white;
        font-size: 28px;
        cursor: pointer;
     }
     ul.nav-links-mobile { list-style: none; padding: 0; margin: 20px 0; }
     ul.nav-links-mobile li a {
       color: white; padding: 15px 20px; text-decoration: none; display: block;
       border-bottom: 1px solid #0c3c78;
     }
     ul.nav-links-mobile li:last-child a { border-bottom: none; }
     ul.nav-links-mobile li a:hover { background-color: #0f4fa0; }

     .auth-buttons-mobile { padding: 20px; }
     .auth-buttons-mobile a button, .auth-buttons-mobile button {
       background-color: #d8f352; color: #0c3c78; border: none; padding: 12px 20px;
       border-radius: 5px; font-weight: bold; cursor: pointer; display: block;
       width: 80%; max-width: 250px; margin: 10px auto; box-sizing: border-box;
       text-decoration: none;
     }
     .auth-buttons-mobile a button:hover, .auth-buttons-mobile button:hover { background-color: #c1da3b; }
     

     @media (max-width: 768px) {
       body { -webkit-text-size-adjust: 100%; -ms-text-size-adjust: 100%; }

       header { padding: 10px 15px; }
       .header-content {
         justify-content: space-between; 
         width:100%; 
       }
       .site-title { text-align: left; }
       .site-title h1 { font-size: 1.2em; margin-bottom: 0; }
       .site-title p { display: none; } 

       .mobile-menu-toggle { display: block; }
       
       .nav-wrapper-desktop { display: none; }
       .auth-buttons-desktop { display: none; }

       nav.main-navigation { padding: 0; background-color: transparent; }
     }

    /* === Styles specific to booking.html === */
    .flatpickr-day.week-highlight {
      background: #0c3c78 !important;
      color: white !important;
      border-radius: 50%;
    }
    section { padding: 40px 20px; } /* Original booking section padding */
    .booking-container {
      max-width: 500px; margin: auto; background: #fff; padding: 30px;
      border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .booking-container h2 { margin-top: 0; color: #0c3c78; }
    label { display: block; margin-top: 15px; font-weight: bold; }
    input, select {
      width: 100%; padding: 10px; margin-top: 5px; box-sizing: border-box;
      border: 1px solid #ccc; border-radius: 5px;
    }
    /* General button style for booking form, distinct from auth buttons */
    .booking-container button[type="submit"] {
      margin-top: 20px; width: 100%; padding: 12px; background-color: #0c3c78;
      color: white; border: none; border-radius: 5px; font-size: 1rem;
      cursor: pointer;
    }
    .booking-container button[type="submit"]:hover { background-color: #0f4fa0; }

    /* Welcome greeting style */
    .welcome-greeting {
        background:#0c3c78;color:white;padding:10px;text-align:center;font-weight:bold;
    }
  /* Override the highlighted “Book” pill to be fully rounded */
ul.nav-links-desktop li a.highlighted-nav {
  border-radius: 9999px;
}

/* If you also want the mobile “Book” link rounded, do: */
ul.nav-links-mobile li a.highlighted-nav {
  border-radius: 9999px;
}
/* Make desktop nav links more pill-shaped */
ul.nav-links-desktop li a {
  border-radius: 9999px;
}

/* Ensure highlighted tab stays pill-shaped */
ul.nav-links-desktop li a.highlighted-nav {
  border-radius: 9999px;
}

/* Make mobile nav links match */
ul.nav-links-mobile li a {
  border-radius: 9999px;
}

    /* === Styles for Program and Coach Tiles === */
    .program-tiles-grid,
    .coach-tiles-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); /* Responsive columns */
      gap: 20px; /* Space between tiles */
      margin-top: 10px; /* Space above the grid */
      margin-bottom: 20px; /* Space below the grid */
    }

    .program-tile,
    .coach-tile {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      cursor: pointer;
      padding: 10px;
      border: 2px solid transparent; /* For selection outline */
      border-radius: 8px; /* Rounded corners for the tile itself */
      transition: transform 0.15s ease, box-shadow 0.15s ease, border-color 0.15s ease; /* Smooth transitions */
    }

    .program-tile img,
    .coach-tile img {
      width: 150px;   /* Fixed width */
      height: 100px;  /* Fixed height */
      object-fit: cover; /* Cover the area, cropping if necessary */
      border-radius: 8px; /* Rounded corners for images */
      margin-bottom: 8px; /* Space between image and caption */
    }

    .program-tile:hover,
    .coach-tile:hover {
      transform: scale(1.05); /* Slightly smaller scale for tile vs just image */
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* Subtle shadow */
    }

    .program-tile span,
    .coach-tile span {
      font-weight: bold;
      font-size: 0.9em;
      color: #333; /* Darker text for captions */
    }

    .selected-tile {
      border: 3px solid #0c3c78; /* Blue border, matching site theme */
      box-shadow: 0 0 10px rgba(12, 60, 120, 0.5); /* Optional: add a glow effect */
    }

    @media (max-width: 400px) { /* Adjust breakpoint if needed, 150px tile + gap might need ~350px for two columns */
      .program-tiles-grid,
      .coach-tiles-grid {
        grid-template-columns: 1fr; /* Single column */
      }
      .program-tile img, /* Optionally make images a bit smaller on very small screens */
      .coach-tile img {
        width: 120px;
        height: 80px;
      }
    }
  </style>
</head>
<body>

  <header>
    <div class="header-content">
      <div class="site-title">
        <h1>C2 Tennis Academy</h1>
        <p>Developing Champions On and Off the Court</p>
      </div>
      <button class="mobile-menu-toggle" aria-label="Open navigation menu" aria-expanded="false" aria-controls="mainNavigationMobile">
        &#9776; <!-- Hamburger icon -->
      </button>
    </div>
    <div class="auth-buttons-desktop" id="authContainerDesktop">
      <!-- Desktop auth buttons will be populated by JavaScript -->
      <!-- Fallback or initial content if JS is slow/fails -->
      <a href="register.html"><button>Register</button></a>
      <a href="login.html"><button>Login</button></a>
      <a href="about.html#meet-our-coaches" class="coach-link-button">Meet the Coaches</a>
    </div>
  </header>

  <nav class="main-navigation" id="mainNavigationMobile">
    <div class="nav-wrapper-desktop"> 
       <ul class="nav-links-desktop">
         <li><a href="index.html">Home</a></li>
         <li><a href="about.html">About</a></li>
         <li><a href="programs.html">Programs</a></li>
         <li><a href="schedule.html">Schedule</a></li>
         <li><a href="contact.html">Contact</a></li>
         <li><a href="booking.html" class="highlighted-nav">Book</a></li>
       </ul>
    </div>

    <div class="mobile-menu-container">
      <button class="mobile-menu-close" aria-label="Close navigation menu">&times;</button>
      <ul class="nav-links-mobile">
        <li><a href="index.html">Home</a></li>
        <li><a href="about.html">About</a></li>
        <li><a href="programs.html">Programs</a></li>
        <li><a href="schedule.html">Schedule</a></li>
        <li><a href="contact.html">Contact</a></li>
        <li><a href="booking.html">Book</a></li>
      </ul>
      <div class="auth-buttons-mobile" id="authContainerMobile">
        <!-- Mobile auth buttons will be populated by JavaScript -->
        <!-- Fallback or initial content -->
        <a href="register.html"><button>Register</button></a>
        <a href="login.html"><button>Login</button></a>
      </div>
    </div>
  </nav>

  <main>
    <section>
      <div class="booking-container">
        <h2>Book a Session</h2>
        <form id="bookingForm">
          <label for="student">Student Name</label>
        <input type="text" id="student" placeholder="Enter student name" required />

          <div id="programTilesContainer" class="program-tiles-grid"></div>
          <input type="hidden" id="selectedProgram" name="program">
          <label for="campDay" id="campDayLabel" style="display:none;">Choose Camp Day</label>
          <input type="text" id="campDay" placeholder="Select a weekday" style="display:none;" readonly />
          <label for="weekStart" id="weekStartLabel" style="display:none;">Select Week Start (Monday only)</label>
          <input type="text" id="weekStart" placeholder="Select a Monday" style="display:none;" readonly />

          <label for="coach" id="coachLabel" style="display:none;">Coach</label>
          <select id="coach" style="display:none;">
            <option value="">-- Select Coach --</option>
            <option value="Ricardo Carvajalino">Ricardo Carvajalino</option>
            <option value="Zachary Capone">Zachary Capone</option>
            <option value="Jacob Capone">Jacob Capone</option>
          </select>
          <div id="coachTilesContainer" class="coach-tiles-grid" style="display:none;"></div>
          <input type="hidden" id="selectedCoach" name="coach">

          <label for="date" id="dateLabel" style="display:none;">Preferred Date</label>
          <input type="text" id="date" placeholder="Select a date" style="display:none;" readonly />

          <label for="time" id="timeLabel" style="display:none;">Preferred Time</label>
          <select id="time" style="display:none;"></select>

        <div id="email-container">
          <label for="email">Your Email</label>
          <input type="email" id="email" name="email" required />
        </div>

        <div id="phone-container">
          <label for="phone">Your Phone Number</label>
          <input type="tel" id="phone" name="phone" required />
        </div>

          <button type="submit" id="submitBookingBtn">Book Session</button>
        </form>
      </div>
    </section>
  </main>
  

  <footer>
    <p>&copy; 2025 C2 Tennis Academy. All rights reserved.</p>
  </footer>

  <!-- Flatpickr JS -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

  <script>
// Helper Functions & Availability Map (Unchanged)
function parseTime(str) {
  const [time, mer] = str.split(' ');
  let [h, m] = time.split(':').map(Number);
  if (mer === 'PM' && h < 12) h += 12;
  if (mer === 'AM' && h === 12) h = 0;
  return h * 60 + m;
}
function fmtTime(mins) {
  let h = Math.floor(mins / 60), m = mins % 60;
  const mer = h >= 12 ? 'PM' : 'AM';
  if (h > 12) h -= 12;
  if (h === 0) h = 12;
  return `${h}:${m.toString().padStart(2,'0')} ${mer}`;
}
window.parseTime = parseTime; // Make global
window.fmtTime = fmtTime; // Make global

const availability = {
  'Jacob Capone':        { days: [4,5,6], times: { 4:{min:'3:00 PM',max:'8:00 PM'},5:{min:'3:00 PM',max:'8:00 PM'},6:{min:'8:00 AM',max:'4:00 PM'} } },
  'Zachary Capone':      { days: [1,2,3,4,5,6], times: { default:{min:'9:00 AM',max:'7:00 PM'},6:{min:'9:00 AM',max:'5:00 PM'} } },
  'Ricardo Carvajalino': { days: [1,2,3,4,5,6], times: { default:{min:'8:00 AM',max:'2:00 PM'} } }
};
window.availability = availability; // Make global
</script>

  <script>
document.addEventListener('DOMContentLoaded', () => {
    // --- START PROGRAM SELECTION LOGIC ---

    const programTilesContainer = document.getElementById('programTilesContainer');
    const selectedProgramInput = document.getElementById('selectedProgram');

    // Original form elements (still needed for their logic)
    // const originalProgramEl = document.getElementById('program'); // No longer exists
    const coachEl = document.getElementById('coach'); // Original coach select, kept for now but hidden
    const coachLbl = document.getElementById('coachLabel'); // Original coach label
    const dateEl = document.getElementById('date');
    const dateLbl = document.getElementById('dateLabel');
    const timeEl = document.getElementById('time');
    const timeLbl = document.getElementById('timeLabel');
    const campDayInput = document.getElementById('campDay');
    const campDayLabel = document.getElementById('campDayLabel');
    const weekStartInput = document.getElementById('weekStart');
    const weekStartLabel = document.getElementById('weekStartLabel');
    // let datePicker = null; // This will be replaced by window.datePickerInstance

    // Coach tiles container and input
    const coachTilesContainer = document.getElementById('coachTilesContainer');
    const selectedCoachInput = document.getElementById('selectedCoach');

    // Program data
    const programTileElements = []; // To store program tile DOM elements for keyboard navigation
    const programs = [
      { name: "Private Lesson",       value: "Private Lesson",       image: "images/private.jpg",    price: "$80"  },
      { name: "Adult Camp",           value: "Adult Camp",           image: "images/adult.jpg",        price: "$20"  },
      { name: "Summer Camp Day Pass", value: "Summer Camp - Day Pass",  image: "images/camp.png",  price: "$30"  },
      { name: "Summer Camp Week Pass",value: "Summer Camp - Week Pass", image: "images/camp.png", price: "$130" },
      { name: "Kids Camp Day Pass",   value: "Kids Camp - Day Pass",   image: "images/junior.jpg",    price: "$30"  },
      { name: "Kids Camp Week Pass",  value: "Kids Camp - Week Pass",  image: "images/junior.jpg",   price: "$80" }
    ];

    const coaches = [
      { name: "Ricardo Carvajalino", value: "Ricardo Carvajalino", image: "ricky.jpg" },
      { name: "Zachary Capone",      value: "Zachary Capone",      image: "zach.jpg" },
      { name: "Jacob Capone",        value: "Jacob Capone",        image: "Jacob.jpg"     }
    ];

    async function handleCoachSelection(coachValue) {
        const selectedCoachInputField = document.getElementById('selectedCoach'); 
        const datePickerEl = document.getElementById('date');
        const timePickerEl = document.getElementById('time');
        const dateLabelEl = document.getElementById('dateLabel');
        const timeLabelEl = document.getElementById('timeLabel');

        if (!coachValue) return;
        if (selectedCoachInputField) selectedCoachInputField.value = coachValue;

        let blockedDays = [];
        let timeBlocks = [];

        try {
            const response = await fetch(`/api/public-availability?coach=${encodeURIComponent(coachValue)}`);
            if (!response.ok) {
                let errorDetail = response.statusText;
                try {
                    const errorData = await response.json();
                    if (errorData && errorData.message) errorDetail = errorData.message;
                } catch(e) { /* ignore parsing error */ }
                throw new Error(`Failed to fetch availability: ${errorDetail}`);
            }
            const data = await response.json();
            blockedDays = data.days || [];
            timeBlocks = data.times || [];
        } catch (err) {
            console.error('❌ Failed to fetch public availability:', err);
            alert(`Could not load availability for ${coachValue}. Please try another coach or contact support.`);
            blockedDays = []; timeBlocks = [];
        }

        if (window.datePickerInstance) { 
            window.datePickerInstance.destroy();
            window.datePickerInstance = null;
        }
        if (datePickerEl) datePickerEl.value = '';
        if (timePickerEl) timePickerEl.innerHTML = '<option value="">-- Select Time --</option>';
        
        if (dateLabelEl && datePickerEl) {
            dateLabelEl.style.display = 'block';
            datePickerEl.style.display = 'block';
        }
        if (timeLabelEl && timePickerEl) { 
            timeLabelEl.style.display = 'none';
            timePickerEl.style.display = 'none';
        }

        const coachAvailabilityData = window.availability[coachValue]; 
        if (!coachAvailabilityData) {
            console.error(`Availability data not found for coach: ${coachValue}`);
            if (datePickerEl) datePickerEl.disabled = true;
            alert(`Availability data not found for ${coachValue}. They may not be available for Private Lessons.`);
            return;
        }
        if (datePickerEl) datePickerEl.disabled = false;

        if (datePickerEl) {
           window.datePickerInstance = flatpickr(datePickerEl, {
                dateFormat: 'Y-m-d',
                minDate: 'today',
                disable: [
                    d => !coachAvailabilityData.days.includes(d.getDay()),
                    ...blockedDays.map(dStr => {
                        const dateObj = new Date(dStr);
                        return new Date(dateObj.getUTCFullYear(), dateObj.getUTCMonth(), dateObj.getUTCDate());
                    })
                ],
                onChange(selectedDates) {
                    if (!selectedDates.length) return;
                    const d = selectedDates[0];
                    const dow = d.getDay();
                    const slot = coachAvailabilityData.times[dow] || coachAvailabilityData.times.default;

                    if (!slot) {
                        console.error(`No time slots defined for coach ${coachValue} on day ${dow}`);
                        if (timePickerEl) timePickerEl.innerHTML = '<option value="">No slots available</option>';
                         if (timeLabelEl && timePickerEl) {
                             timeLabelEl.style.display = 'block'; 
                             timePickerEl.style.display = 'block'; 
                        }
                        return;
                    }

                    if (timePickerEl) timePickerEl.innerHTML = '<option value="">-- Select Time --</option>';

                    const selectedDateStr = d.toISOString().split('T')[0];
                    const blockedTimesForDate = timeBlocks
                        .filter(tb => tb.date === selectedDateStr)
                        .map(tb => [window.parseTime(tb.start), window.parseTime(tb.end)]); 

                    for (let t = window.parseTime(slot.min); t + 30 <= window.parseTime(slot.max); t += 30) {
                        const isBlocked = blockedTimesForDate.some(([start, end]) => t >= start && t < end);
                        if (!isBlocked) {
                            const opt = document.createElement('option');
                            opt.value = window.fmtTime(t); 
                            opt.textContent = window.fmtTime(t);
                            if (timePickerEl) timePickerEl.appendChild(opt);
                        }
                    }
                    if (timeLabelEl && timePickerEl) {
                        timeLabelEl.style.display = 'block';
                        timePickerEl.style.display = 'block';
                    }
                }
            });
        }
    }

    function populateCoachTiles() {
        const coachTilesContainerEl = document.getElementById('coachTilesContainer'); 
        if (!coachTilesContainerEl) {
            console.error('Coach tiles container not found.');
            return;
        }
        coachTilesContainerEl.innerHTML = ''; 

        coaches.forEach((coach, index) => { // Added index
            const tile = document.createElement('div');
            tile.classList.add('coach-tile');
            tile.setAttribute('data-value', coach.value);
            tile.setAttribute('role', 'button');
            tile.setAttribute('tabindex', index === 0 ? '0' : '-1'); // Set initial tabindex

            const img = document.createElement('img');
            img.src = coach.image; 
            img.alt = coach.name; 

            const caption = document.createElement('span');
            caption.textContent = coach.name;

            tile.appendChild(img);
            tile.appendChild(caption);

            tile.addEventListener('click', () => {
                // Correctly select all coach tiles within their container for modification
                const allCoachTiles = coachTilesContainerEl.querySelectorAll('.coach-tile');
                allCoachTiles.forEach(ct => { 
                    ct.classList.remove('selected-tile');
                    ct.setAttribute('tabindex', '-1');
                }); // End of forEach for coach tiles

                // Apply changes to the clicked coach tile
                tile.classList.add('selected-tile');
                tile.setAttribute('tabindex', '0');

                // Call the handler function for coach selection
                handleCoachSelection(coach.value); 
            });

            tile.addEventListener('keydown', (event) => {
                if (event.key === 'Enter' || event.key === ' ') {
                    event.preventDefault();
                    // tile.click() will trigger the click handler above,
                    // which now correctly handles tabindex for all tiles.
                    tile.click(); 
                } else if (event.key === 'ArrowLeft' || event.key === 'ArrowRight') {
                    event.preventDefault();
                    const allCoachTiles = Array.from(coachTilesContainerEl.querySelectorAll('.coach-tile'));
                    const currentIndex = allCoachTiles.indexOf(tile);
                    let nextIndex;

                    if (event.key === 'ArrowLeft') {
                        nextIndex = currentIndex > 0 ? currentIndex - 1 : allCoachTiles.length - 1;
                    } else { // ArrowRight
                        nextIndex = currentIndex < allCoachTiles.length - 1 ? currentIndex + 1 : 0;
                    }

                    if (allCoachTiles[currentIndex]) allCoachTiles[currentIndex].setAttribute('tabindex', '-1');
                    if (allCoachTiles[nextIndex]) {
                        allCoachTiles[nextIndex].setAttribute('tabindex', '0');
                        allCoachTiles[nextIndex].focus();
                    }
                }
            });
            coachTilesContainerEl.appendChild(tile);
        });
        coachTilesContainerEl.style.display = 'grid';
        
        // Corrected focus logic:
        // Query all tiles within the container after they are added.
        const allTilesInContainer = coachTilesContainerEl.querySelectorAll('.coach-tile');
        if (allTilesInContainer.length > 0) {
            // Ensure tabindexes are set correctly (e.g. if a default selection is made later)
            // This might be redundant if the loop sets it perfectly, but good for robustness.
            allTilesInContainer.forEach((tile, idx) => {
                // The loop already sets this, but if we wanted to ensure only ONE is 0:
                // tile.setAttribute('tabindex', idx === 0 ? '0' : '-1');
            });
            // Focus the first tile. The tabindex should already be '0' from the loop.
            allTilesInContainer[0].focus();
        }
    }

    function handleProgramSelection(programValue) {
        if (selectedProgramInput) selectedProgramInput.value = programValue;

        const isCampDay = programValue === 'Summer Camp - Day Pass' || programValue === 'Kids Camp - Day Pass';
        const isCampWeek = programValue === 'Summer Camp - Week Pass' || programValue === 'Kids Camp - Week Pass';
        const showCoachSelection = programValue === 'Private Lesson';

        // Get fresh references to elements that might be affected
        const currentProgramTilesContainer = document.getElementById('programTilesContainer');
        const currentCoachLbl = document.getElementById('coachLabel');
        const currentCoachTilesContainer = document.getElementById('coachTilesContainer');
        const currentSelectedCoachInput = document.getElementById('selectedCoach');
        const currentDateEl = document.getElementById('date');
        const currentDateLbl = document.getElementById('dateLabel');
        const currentTimeEl = document.getElementById('time');
        const currentTimeLbl = document.getElementById('timeLabel');
        const currentCampDayInput = document.getElementById('campDay');
        const currentCampDayLabel = document.getElementById('campDayLabel');
        const currentWeekStartInput = document.getElementById('weekStart');
        const currentWeekStartLabel = document.getElementById('weekStartLabel');

        // Ensure program tiles remain visible or are set to their default display
        if (currentProgramTilesContainer) {
            // Assuming 'grid' is the default/desired display. Adjust if it's 'block' or other.
            currentProgramTilesContainer.style.display = 'grid'; 
        }

        if (showCoachSelection) {
            // if (currentProgramTilesContainer) currentProgramTilesContainer.style.display = 'none'; // This line is removed
            if (currentCoachLbl) currentCoachLbl.style.display = 'block';
            
            populateCoachTiles(); // This will make coachTilesContainer visible and focus the first tile
            
            // Date/time pickers are hidden until a coach is selected.
            if (currentDateEl) currentDateEl.style.display = 'none';
            if (currentDateLbl) currentDateLbl.style.display = 'none';
            if (currentTimeEl) currentTimeEl.style.display = 'none';
            if (currentTimeLbl) currentTimeLbl.style.display = 'none';
            if (window.datePickerInstance) {
                 window.datePickerInstance.destroy();
                 window.datePickerInstance = null;
                 if(currentDateEl) currentDateEl.value = '';
                 if(currentTimeEl) currentTimeEl.innerHTML = '<option value="">-- Select Time --</option>';
            }
        } else {
            // Not "Private Lesson"
            if (currentProgramTilesContainer) currentProgramTilesContainer.style.display = 'grid';
            programTileElements.forEach((pt, idx) => {
                if (pt.classList.contains('selected-tile')) {
                    pt.setAttribute('tabindex', '0');
                    pt.focus();
                } else if (idx === 0 && !document.querySelector('.program-tile.selected-tile')) {
                    // If no tile is selected, focus the first one
                    pt.setAttribute('tabindex', '0');
                    pt.focus();
                } else {
                    pt.setAttribute('tabindex', '-1');
                }
            });
            if (currentCoachLbl) currentCoachLbl.style.display = 'none';
            if (currentCoachTilesContainer) currentCoachTilesContainer.style.display = 'none';
            if (currentSelectedCoachInput) currentSelectedCoachInput.value = '';

            if (currentDateEl) currentDateEl.style.display = 'none';
            if (currentDateLbl) currentDateLbl.style.display = 'none';
            if (currentTimeEl) currentTimeEl.style.display = 'none';
            if (currentTimeLbl) currentTimeLbl.style.display = 'none';
            if (window.datePickerInstance) {
                window.datePickerInstance.destroy();
                window.datePickerInstance = null;
                if(currentDateEl) currentDateEl.value = '';
                if(currentTimeEl) currentTimeEl.innerHTML = '<option value="">-- Select Time --</option>';
            }
        }

        // Camp day selection logic - ensure elements are accessed via current references
        if (currentCampDayInput && currentCampDayLabel) {
            currentCampDayLabel.style.display = isCampDay ? 'block' : 'none';
            currentCampDayInput.style.display = isCampDay ? 'block' : 'none';
            if (isCampDay) {
                setTimeout(() => { 
                    if (currentCampDayInput._flatpickr) currentCampDayInput._flatpickr.destroy();
                    flatpickr(currentCampDayInput, {
                        dateFormat: 'Y-m-d', minDate: 'today',
                        disable: [
                            ...(programValue === 'Summer Camp - Day Pass' ? [d => d.getDay() === 0 || d.getDay() === 6] : []), // No weekends for Summer Camp
                            ...(programValue === 'Kids Camp - Day Pass' ? [d => d.getDay() < 1 || d.getDay() > 3] : [])     // Mon-Wed for Kids Camp
                        ]
                    });
                }, 10);
            } else {
                if (currentCampDayInput._flatpickr) currentCampDayInput._flatpickr.destroy(); 
                currentCampDayInput.value = '';
            }
        }

        // Week start selection logic - ensure elements are accessed via current references
        if (currentWeekStartInput && currentWeekStartLabel) {
            currentWeekStartLabel.style.display = isCampWeek ? 'block' : 'none';
            currentWeekStartInput.style.display = isCampWeek ? 'block' : 'none';
            if (isCampWeek) {
                setTimeout(() => {
                    if (currentWeekStartInput._flatpickr) currentWeekStartInput._flatpickr.destroy();
                    flatpickr(currentWeekStartInput, {
                        dateFormat: 'Y-m-d', minDate: 'today',
                        disable: [(date) => date.getDay() !== 1], // Only Mondays
                        clickOpens: true, allowInput: false
                    });
                }, 10);
            } else {
                if (currentWeekStartInput._flatpickr) currentWeekStartInput._flatpickr.destroy();
                currentWeekStartInput.value = '';
            }
        }
    }

    if (programTilesContainer && selectedProgramInput) { // Check programTilesContainer exists
        programs.forEach((program, index) => {
            const tile = document.createElement('div');
            tile.classList.add('program-tile');
            tile.setAttribute('data-value', program.value); 
            tile.setAttribute('role', 'button');
            tile.setAttribute('tabindex', index === 0 ? '0' : '-1'); // First tile focusable

            programTileElements.push(tile); // Store the tile element

            const img = document.createElement('img');
            img.src = program.image; 
            img.alt = program.name; // program.name used here for alt text

            const caption = document.createElement('span');
            caption.textContent = `${program.name} - ${program.price}`; // program.name and program.price

            tile.appendChild(img);
            tile.appendChild(caption);

            tile.addEventListener('click', () => {
                // Correctly select all program tiles within their container for modification
                const allProgramTiles = programTilesContainer.querySelectorAll('.program-tile');
                allProgramTiles.forEach(pt => {
                    pt.classList.remove('selected-tile');
                    pt.setAttribute('tabindex', '-1');
                }); // End of forEach

                // Apply changes to the clicked tile
                tile.classList.add('selected-tile');
                tile.setAttribute('tabindex', '0');

                // Call the handler function
                handleProgramSelection(program.value);
            });

            tile.addEventListener('keydown', (event) => {
                if (event.key === 'Enter' || event.key === ' ') {
                    event.preventDefault(); 
                    // tile.click() will trigger the click handler above,
                    // which now correctly handles tabindex for all tiles.
                    tile.click(); 
                } else if (event.key === 'ArrowLeft' || event.key === 'ArrowRight') {
                    event.preventDefault();
                    const currentIndex = programTileElements.indexOf(tile); // programTileElements should be in scope
                    let nextIndex;

                    if (event.key === 'ArrowLeft') {
                        nextIndex = currentIndex > 0 ? currentIndex - 1 : programTileElements.length - 1;
                    } else { // ArrowRight
                        nextIndex = currentIndex < programTileElements.length - 1 ? currentIndex + 1 : 0;
                    }
                    
                    if (programTileElements[currentIndex]) programTileElements[currentIndex].setAttribute('tabindex', '-1');
                    if (programTileElements[nextIndex]) {
                        programTileElements[nextIndex].setAttribute('tabindex', '0');
                        programTileElements[nextIndex].focus();
                    }
                }
            });

            programTilesContainer.appendChild(tile);
        });
        // Optionally, focus the first program tile on page load if no other element has autofocus
        // For now, just ensuring tabindex is set.
        // if (programTileElements.length > 0 && !document.querySelector('[autofocus]')) {
        //    programTileElements[0].focus();
        // }
    } else {
        console.error('Program tiles container or selected program input not found.');
    }

    // Initial hide for coach tiles and related elements
    if (coachLbl) coachLbl.style.display = 'none';
    if (coachTilesContainer) coachTilesContainer.style.display = 'none';
    if (coachEl) coachEl.style.display = 'none'; // Ensure original dropdown is hidden
});
</script>

  <script>
  // Main Booking Logic (Submit and supporting consts)
  // Note: programEl and its listener have been removed as the element is gone.
  // coachEl listener has been removed as its functionality is replaced by tile selection.
  // const programEl     = document.getElementById('program'); // Removed
  const coachEl       = document.getElementById('coach'); // Kept for now, but hidden and not primary interaction
  const coachLbl      = document.getElementById('coachLabel'); // Referenced by new logic
  const dateEl        = document.getElementById('date'); // Referenced by new logic and submission
  const dateLbl       = document.getElementById('dateLabel'); // Referenced by new logic
  const timeEl        = document.getElementById('time'); // Referenced by new logic and submission
  const timeLbl       = document.getElementById('timeLabel'); // Referenced by new logic
  const campDayInput  = document.getElementById('campDay'); // Referenced by new logic and submission
  const campDayLabel  = document.getElementById('campDayLabel'); // Referenced by new logic
  const weekStartInput  = document.getElementById('weekStart'); // Referenced by new logic and submission
  const weekStartLabel  = document.getElementById('weekStartLabel'); // Referenced by new logic
  // let datePicker = null; // Superseded by window.datePickerInstance for private lessons

  // Obsolete programEl.addEventListener('change', ...) has been removed.
  // Obsolete coachEl.addEventListener('change', ...) has been removed.

  document.getElementById('bookingForm').addEventListener('submit', async e => {
    e.preventDefault();
    const student = document.getElementById('student').value;
    const program = document.getElementById('selectedProgram').value; // Updated
    const coach   = document.getElementById('selectedCoach').value || ''; // Updated
    let date;
    // Date selection logic based on program type - uses selectedProgram.value
    if (program.includes('Week Pass')) {
        date = weekStartInput.value;
    } else if (program.includes('Day Pass')) {
        date = campDayInput.value;
    } else { // Assumes Private Lesson or other types that use the main date picker
        date = dateEl.value;
    }
    const time  = timeEl.value;
    const email = document.getElementById('email').value;
    const phone = document.getElementById('phone').value;

    try {
        const bookingData = { student, program, coach, date, time, email, phone }; // Ensure only specified fields
        const res = await fetch('/api/book-pay-later', { // ← use the existing pay-later route  [oai_citation:0‡server.js](file-service://file-3q69ouFcoynfZ2Mc4FKCgS)
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include', // Keep credentials
            body: JSON.stringify(bookingData)
        });
        if (!res.ok) {
            let errorMsg = 'Booking failed. Please try again.'; // Generic error
            try {
                const errorData = await res.json();
                if (errorData && errorData.message) {
                    errorMsg = errorData.message;
                } else if (res.statusText) {
                    errorMsg = res.statusText;
                }
            } catch (parseErr) { /* ignore parsing error */ }
            throw new Error(errorMsg);
        }
         window.location.href = 'pay-later-success.html'; // ← point at your pay-later confirmation page  [oai_citation:1‡pay-later-success.html](file-service://file-SYqk64fsbawVKmA7r4ph8n)
    } catch (err) {
        console.error('Booking error:', err.message);
        alert(err.message);
    }
  });
</script>

<!-- SCRIPT FOR MOBILE MENU, CHECK-SESSION, LOGOUT (Adapted for new structure) -->
<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- Mobile Menu Toggle Script (Adapted from index.html) ---
    const menuToggle = document.querySelector('.mobile-menu-toggle');
    const mobileMenuClose = document.querySelector('.mobile-menu-close');
    // The main <nav> element is now the one that gets the 'mobile-menu--open' class
    const mainNavElement = document.querySelector('nav.main-navigation'); 

    if (menuToggle && mainNavElement && mobileMenuClose) {
        menuToggle.addEventListener('click', () => {
            const isMenuOpen = mainNavElement.classList.toggle('mobile-menu--open');
            menuToggle.setAttribute('aria-expanded', String(isMenuOpen));
            // Optional: Change hamburger to X and back if desired (not in index.html script)
            // menuToggle.innerHTML = isMenuOpen ? '&times;' : '&#9776;';
        });

        mobileMenuClose.addEventListener('click', () => {
            mainNavElement.classList.remove('mobile-menu--open');
            menuToggle.setAttribute('aria-expanded', 'false');
            // menuToggle.innerHTML = '&#9776;';
        });
    }

    // Close mobile menu when a nav link is clicked (Adapted from index.html)
    const mobileNavLinks = document.querySelectorAll('.mobile-menu-container ul.nav-links-mobile li a');
    if (mainNavElement && mobileNavLinks.length > 0) {
        mobileNavLinks.forEach(link => {
            link.addEventListener('click', () => {
                if (mainNavElement.classList.contains('mobile-menu--open')) {
                    mainNavElement.classList.remove('mobile-menu--open');
                    if(menuToggle) menuToggle.setAttribute('aria-expanded', 'false');
                    // if(menuToggle) menuToggle.innerHTML = '&#9776;';
                }
            });
        });
    }

    // --- Updated checkSession and logout functions (Content largely same, targets updated) ---
    async function checkSession() {
        const existingGreeting = document.querySelector('div.welcome-greeting'); 
        if (existingGreeting) existingGreeting.remove();

        const emailContainer = document.getElementById('email-container');
        const emailInput = document.getElementById('email');
        const phoneContainer = document.getElementById('phone-container');
        const phoneInput = document.getElementById('phone');

        try {
            const res = await fetch('/api/check-session', { credentials: 'include' });
            const data = await res.json();

            const authContainerDesktop = document.getElementById('authContainerDesktop'); // Targets .auth-buttons-desktop
            const authContainerMobile = document.getElementById('authContainerMobile');   // Targets .auth-buttons-mobile

            // Default logged-out HTML now includes the "Meet the Coaches" link for desktop
            const loggedOutDesktopHTML = `
                <a href="register.html"><button>Register</button></a>
                <a href="login.html"><button>Login</button></a>
                <a href="about.html#meet-our-coaches" class="coach-link-button">Meet the Coaches</a>
            `;
            const loggedOutMobileHTML = `
                <a href="register.html"><button>Register</button></a>
                <a href="login.html"><button>Login</button></a>
            `;

            if (data && data.loggedIn) {
                if (emailContainer) { emailContainer.style.display = 'none'; if(emailInput) emailInput.required = false; }
                if (phoneContainer) { phoneContainer.style.display = 'none'; if(phoneInput) phoneInput.required = false; }

                const portal = data.isAdmin ? 'admin.html'
                             : data.isCoach ? 'instructor_portal.html'
                             : 'parent_portal.html';
                const portalName = data.isAdmin ? 'Admin Portal'
                               : data.isCoach ? 'Instructor Portal'
                               : 'Parent Portal';

                // Logged-in HTML for desktop also includes "Meet the Coaches"
                const loggedInDesktopHTML = '<a href="' + portal + '"><button>' + portalName + '</button></a>' +
                                            '<button onclick="logout()">Logout</button>' +
                                            '<a href="about.html#meet-our-coaches" class="coach-link-button">Meet the Coaches</a>';
                
                const loggedInMobileHTML = '<a href="' + portal + '"><button>' + portalName + '</button></a>' +
                                           '<button onclick="logout()">Logout</button>';

                if (authContainerDesktop) authContainerDesktop.innerHTML = loggedInDesktopHTML;
                if (authContainerMobile) authContainerMobile.innerHTML = loggedInMobileHTML;

                if (data.firstName) {
                    const welcomeMessageText = 'Welcome, ' + data.firstName + '!';
                    const greeting = document.createElement('div');
                    greeting.className = 'welcome-greeting'; 
                    greeting.textContent = welcomeMessageText;
                    // greeting.style.cssText is now handled by the .welcome-greeting class in <style>
                    
                    const existingGreeting = document.querySelector('div.welcome-greeting'); 
                    if (existingGreeting) existingGreeting.remove();

                    if(document.body.firstChild && document.body.firstChild.nodeName !== 'SCRIPT' && document.body.firstChild.nodeName !== 'LINK') {
                        document.body.insertBefore(greeting, document.body.firstChild);
                    } else {
                        // Fallback if firstChild is script/link or body is empty
                        const mainContentArea = document.querySelector('main') || document.body;
                        mainContentArea.parentNode.insertBefore(greeting, mainContentArea);
                    }
                }
            } else {
                if (authContainerDesktop) authContainerDesktop.innerHTML = loggedOutDesktopHTML;
                if (authContainerMobile) authContainerMobile.innerHTML = loggedOutMobileHTML;
                if (emailContainer) { emailContainer.style.display = 'block'; if(emailInput) emailInput.required = true; }
                if (phoneContainer) { phoneContainer.style.display = 'block'; if(phoneInput) phoneInput.required = true; }
            }
        } catch (err) {
            console.error('Session check failed:', err);
            if (emailContainer) emailContainer.style.display = 'block';
            if (emailInput) emailInput.required = true;
            if (phoneContainer) phoneContainer.style.display = 'block';
            if (phoneInput) phoneInput.required = true;

            const authContainerDesktop = document.getElementById('authContainerDesktop');
            const authContainerMobile = document.getElementById('authContainerMobile');
            const loggedOutDesktopHTML = `
                <a href="register.html"><button>Register</button></a>
                <a href="login.html"><button>Login</button></a>
                <a href="about.html#meet-our-coaches" class="coach-link-button">Meet the Coaches</a>
            `;
            const loggedOutMobileHTML = `
                <a href="register.html"><button>Register</button></a>
                <a href="login.html"><button>Login</button></a>
            `;
            if (authContainerDesktop) authContainerDesktop.innerHTML = loggedOutDesktopHTML;
            if (authContainerMobile) authContainerMobile.innerHTML = loggedOutMobileHTML;
        }
    }

    window.logout = function() { // Ensure logout is global
        fetch('/api/logout', { method: 'POST', credentials: 'include' })
            .then(() => {
                const existingGreeting = document.querySelector('div.welcome-greeting');
                if (existingGreeting) existingGreeting.remove();
                document.cookie = "userFirstName=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;"; // Keep old cookie cleanup
                location.reload();
            })
            .catch(err => {
                console.error('Logout failed:', err);
                location.reload();
            });
    }

    checkSession();
});
</script>
</body>
</html>
