<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Financials - C2 Tennis Academy</title>
  <style>
    html, body { height: 100%; margin: 0; display: flex; flex-direction: column; font-family: Arial, sans-serif; }
    header, footer { background-color: #0c3c78; color: white; text-align: center; padding: 20px; }
    nav { background-color: #092e5e; display: flex; justify-content: center; }
    nav a { color: white; padding: 14px 20px; text-decoration: none; }
    nav a:hover { background-color: #0f4fa0; }
    section { flex: 1; padding: 40px 20px; max-width: 1400px; width: 90%; margin: auto; background: white; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    h2 { color: #0c3c78; }
    form { margin-top: 30px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .full-width { grid-column: 1 / -1; }
    label { display: block; font-weight: bold; color: #0c3c78; margin-bottom: 5px; }
    input, select, button { width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #ccc; box-sizing: border-box; }
    button { background-color: #0c3c78; color: white; cursor: pointer; grid-column: 1 / -1; margin-top: 20px; }
    button:hover { background-color: #0f4fa0; }
    #student-name-container { display: none; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { padding: 8px; border:1px solid #ddd; }
    thead th { background: #0c3c78; color: white; }
/* === Global Header & Navigation Styles (Finalized Version) === */
     header {
       background-color: #0c3c78; 
       color: white; 
       padding: 30px 20px; 
       position: relative; 
       text-align: center; 
     }
     .header-content { 
       display: flex; justify-content: center; align-items: center; 
       max-width: 1200px; margin: 0 auto;
       position: relative; 
     }
     .site-title { text-align: center; } 
     .site-title h1 { 
       font-size: 2.2em;    
       margin-top: 0;
       margin-bottom: 0; /* Adjusted for portal pages with no subtitle */
       color: white; 
     } 
     .site-title p { 
       font-size: 1em;    
       margin-top: 0;
       margin-bottom: 0;
       color: #f0f0f0;
       /* display: none; /* Subtitle can be shown or hidden based on page */
     }
     
     .mobile-menu-toggle { display: none; background: none; border: none; color: white; font-size: 28px; cursor: pointer; padding: 5px; }
     nav.main-navigation { background-color: #092e5e; }
     .nav-wrapper-desktop { 
         display: flex; justify-content: center; align-items: center;
         width: 100%; max-width: 1200px; margin: 0 auto; padding: 0 20px; box-sizing: border-box;
     }
     ul.nav-links-desktop { list-style: none; margin: 0; padding: 0; display: flex; }
     ul.nav-links-desktop li a { color: white; padding: 14px 20px; text-decoration: none; display: block; } 
     ul.nav-links-desktop li a:hover { background-color: #0f4fa0; }
     ul.nav-links-desktop li a.highlighted-nav, ul.nav-links-desktop li a.current-page { 
        background-color: #d8f352; color: black; font-weight: bold; border-radius: 5px; 
     }
     ul.nav-links-desktop li a.highlighted-nav:hover, ul.nav-links-desktop li a.current-page:hover { background-color: #c1da3b; }
     
     .auth-buttons-desktop { 
       position: absolute;
       top: 20px; 
       right: 20px; 
       display: flex;
       align-items: center;
       gap: 15px; /* Added gap property */
     }
     .auth-buttons-desktop a button, .auth-buttons-desktop button {
       background-color: white; color: #0c3c78; border: none; padding: 10px 20px; 
       /* margin-left: 15px; */ /* Removed margin-left */
       border-radius: 5px; font-weight: bold; cursor: pointer;
       transition: all 0.3s ease; white-space: nowrap;
     }
     .auth-buttons-desktop a button:hover, .auth-buttons-desktop button:hover { background-color: #0f4fa0; color: white; }
     .mobile-menu-container {
       display: none; background-color: #092e5e; position: fixed;
       top: 0; left: 0; width: 100%; height: 100%;
       z-index: 1000; padding-top: 20px;
       box-sizing: border-box; overflow-y: auto; text-align: center;
     }
     nav.main-navigation.mobile-menu--open .mobile-menu-container { display: block; }
     .mobile-menu-close {
        display: block; 
        position: absolute; 
        top: 10px; /* Adjusted */
        right: 10px; /* Adjusted */
        left: auto; /* Explicitly set */
        bottom: auto; /* Explicitly set */
        background: none; 
        border: none; 
        color: white; 
        font-size: 28px; 
        cursor: pointer;
        z-index: 10; /* Optionally add a z-index */
     }
     ul.nav-links-mobile { list-style: none; padding: 0; margin: 50px 0 20px; }
     ul.nav-links-mobile li a {
       color: white; padding: 15px 20px; text-decoration: none; display: block;
       border-bottom: 1px solid #0c3c78;
     }
     ul.nav-links-mobile li:last-child a { border-bottom: none; }
     ul.nav-links-mobile li a:hover { background-color: #0f4fa0; }
     .auth-buttons-mobile { padding: 20px; }
     .auth-buttons-mobile a button, .auth-buttons-mobile button {
       background-color: #d8f352; color: #0c3c78; border: none; padding: 12px 20px;
       border-radius: 5px; font-weight: bold; cursor: pointer; display: block;
       width: 80%; max-width: 250px; margin: 10px auto; box-sizing: border-box;
     }
     .auth-buttons-mobile a button:hover, .auth-buttons-mobile button:hover { background-color: #c1da3b; }
     
     
     footer { /* Global footer style */
        background-color: #0c3c78; color: white; text-align: center; padding: 20px; margin-top:auto; /* Pushes to bottom in flex if body is flex column */
     }

     @media (max-width: 768px) {
       body { -webkit-text-size-adjust: 100%; -ms-text-size-adjust: 100%; } 
       header { padding: 10px 15px; } 
       .header-content {
         justify-content: space-between; 
         width:100%; 
       }
       .site-title { text-align: left; }
       .site-title h1 { font-size: 1.2em; margin-bottom: 0; }
       .site-title p { display: none; } 
       .mobile-menu-toggle { display: block; }
       .nav-wrapper-desktop { display: none; }
       .auth-buttons-desktop { display: none; } 
       nav.main-navigation { padding: 0; background-color: transparent; }

      /* Mobile-specific layout adjustments */
      form {
        grid-template-columns: 1fr; /* Change to single column layout */
      }

      h2 {
        margin-bottom: 20px; /* Add bottom margin for h2 */
      }

      section {
        padding: 20px 10px; /* Reduce padding for smaller screens */
      }

      #all-lessons-container {
        overflow-x: auto; /* Allow horizontal scrolling only for the table container */
        -webkit-overflow-scrolling: touch; /* Optional: for smoother scrolling on iOS */
      }
    }
  /* Override the highlighted ‚ÄúBook‚Äù pill to be fully rounded */
ul.nav-links-desktop li a.highlighted-nav {
  border-radius: 9999px;
}

/* If you also want the mobile ‚ÄúBook‚Äù link rounded, do: */
ul.nav-links-mobile li a.highlighted-nav {
  border-radius: 9999px;
}
/* Make desktop nav links more pill-shaped */
ul.nav-links-desktop li a {
  border-radius: 9999px;
}

/* Ensure highlighted tab stays pill-shaped */
ul.nav-links-desktop li a.highlighted-nav {
  border-radius: 9999px;
}

/* Make mobile nav links match */
ul.nav-links-mobile li a {
  border-radius: 9999px;
}
/* === End Global Header & Navigation Styles === */

.explore-button {
  font-family: Arial, sans-serif;
  font-size: 1rem;
  font-weight: 400;
  background-color: #3b82f6; /* Blue background */
  color: white !important; /* Ensure white text overrules other <a> styles */
  padding: 0.75rem 2rem;
  border: none;
  border-radius: 9999px; /* Pill shape */
  box-shadow:
    0 10px 15px -3px rgba(0, 0, 0, 0.1),
    0   4px  6px -2px rgba(0, 0, 0, 0.05);
  cursor: pointer;
  transform-origin: center center;
  transition: background-color 0.2s ease, transform 0.2s ease;
  text-decoration: none; /* Remove underline from <a> */
  display: inline-block; /* Make <a> behave like a button */
  text-align: center;
  margin-top: 30px; /* Add some space above the button */
}

.explore-button:hover {
  background-color: #2563eb; /* Darker blue on hover */
  transform: scale(1.05);
  color: white !important;
  text-decoration: none;
}
fieldset {
    border: 1px solid #ccc;
    padding: 20px;
    margin-bottom: 20px;
    border-radius: 8px;
}
legend {
    font-weight: bold;
    color: #0c3c78;
    padding: 0 10px;
}
.input-group div {
    margin-bottom: 15px;
}
.input-group label {
    margin-bottom: 5px;
}
.input-group input[type="number"] {
    width: 100%;
}
.display-group div {
    margin-bottom: 10px;
    font-size: 1.1em;
}
.display-group label {
    font-weight: bold;
    color: #0c3c78;
}
.display-group span {
    font-weight: normal;
    color: #333;
    margin-left: 10px;
}
.dashboard-item {
    padding: 10px;
    border: 1px solid #eee;
    border-radius: 5px;
    margin-bottom: 10px;
    background-color: #f9f9f9;
}
.dashboard-item span {
    display: inline-block;
    min-width: 200px;
}
.dashboard-item .value {
    font-weight: bold;
    margin-left: 5px;
}
  </style>
</head>
<body>

<header>
  <div class="header-content">
    <div class="site-title">
      <h1>Admin Portal</h1> <!-- Specific title -->
      <p>C2 Tennis Academy</p> <!-- Consistent subtitle -->
    </div>
    <button class="mobile-menu-toggle" aria-label="Open navigation menu" aria-expanded="false" aria-controls="mainNavigation">
      &#9776; <!-- Hamburger icon -->
    </button>
  </div>
  <div class="auth-buttons-desktop" id="authContainerDesktop">
    <!-- Populated by checkSession JS - will show Logout, Admin Home etc. -->
  </div>
</header>

<nav class="main-navigation" id="mainNavigation">
  <div class="nav-wrapper-desktop"> 
     <ul class="nav-links-desktop">
       <li><a href="index.html">Home</a></li>
       <li><a href="about.html">About</a></li>
       <li><a href="programs.html">Programs</a></li>
       <li><a href="schedule.html">Schedule</a></li>
       <li><a href="contact.html">Contact</a></li>
     </ul>
  </div>
  <div class="mobile-menu-container">
    <button class="mobile-menu-close" aria-label="Close navigation menu">&times;</button>
    <ul class="nav-links-mobile">
      <li><a href="index.html">Home</a></li>
      <li><a href="about.html">About</a></li>
      <li><a href="programs.html">Programs</a></li>
      <li><a href="schedule.html">Schedule</a></li>
      <li><a href="contact.html">Contact</a></li>
      <li><a href="admin.html" class="current-page">Admin Home</a></li>
    </ul>
    <div class="auth-buttons-mobile" id="authContainerMobile">
      <!-- Populated by checkSession JS -->
    </div>
  </div>
</nav>

<section>
  <div id="error-banner" style="display: none; background-color: #dc3545; color: white; text-align: center; padding: 10px; margin-bottom: 15px; border-radius: 5px;"></div>
  <div id="loading-message" style="display: none; text-align: center; padding: 20px; font-size: 1.2em; color: #0c3c78;">Loading financial data...</div>
  
  <h2>Financial Overview</h2>

  <form id="financials-form" class="full-width">
    <div class="input-group full-width">
        <fieldset>
            <legend>Select Data Period</legend>
            <div style="display: flex; gap: 10px; align-items: center;">
                <div style="flex: 1;">
                    <label for="select_year">Year:</label>
                    <input type="number" id="select_year" placeholder="YYYY" min="2000" max="2100">
                </div>
                <div style="flex: 1;">
                    <label for="select_month">Month:</label>
                    <input type="number" id="select_month" placeholder="MM" min="1" max="12">
                </div>
                <div style="align-self: flex-end; flex-basis: 200px;">
                    <button type="button" id="load_period_data_button" style="margin-top: 0;">Load Data for Selected Period</button>
                </div>
            </div>
        </fieldset>
    </div>

    <!--
    <div class="input-group full-width">
      <fieldset>
        <legend>Lesson Price Inputs</legend>
        <div>
          <label for="kids_group_fee">Kids Group Lesson Fee</label>
          <input type="number" id="kids_group_fee" placeholder="$ per kid" min="0" step="0.01">
        </div>
        <div>
          <label for="adult_group_fee">Adult Group Lesson Fee</label>
          <input type="number" id="adult_group_fee" placeholder="$ per adult" min="0" step="0.01">
        </div>
        <div>
          <label for="private_lesson_rate">Private Lesson Hourly Rate</label>
          <input type="number" id="private_lesson_rate" placeholder="$ per hour" min="0" step="0.01">
        </div>
        <div>
          <label for="clinic_camp_fee">Clinic/Camp Fee per Participant</label>
          <input type="number" id="clinic_camp_fee" placeholder="$ per participant" min="0" step="0.01">
        </div>
      </fieldset>
    </div>
    -->

    <!--
    <div class="input-group full-width">
      <fieldset>
        <legend>Enrollment / Hours Inputs</legend>
        <div>
          <label for="num_kids_enrolled">Number of kids enrolled</label>
          <input type="number" id="num_kids_enrolled" placeholder="Total kids" min="0" step="1">
        </div>
        <div>
          <label for="num_adults_enrolled">Number of adults enrolled</label>
          <input type="number" id="num_adults_enrolled" placeholder="Total adults" min="0" step="1">
        </div>
        <div>
          <label for="total_private_hours">Total private-lesson hours</label>
          <input type="number" id="total_private_hours" placeholder="Total hours" min="0" step="0.01">
        </div>
        <div>
          <label for="num_clinic_participants">Number of clinic/camp participants</label>
          <input type="number" id="num_clinic_participants" placeholder="Total participants" min="0" step="1">
        </div>
      </fieldset>
    </div>
    -->
    
    <!--
    <div class="input-group full-width">
      <fieldset>
        <legend>Coach Payout Rates</legend>
        <div>
          <label for="coach_kids_group_rate">Kids Group Lesson Coach Rate <span title="amount paid per enrolled kid to the coach.">(?)</span></label>
          <input type="number" id="coach_kids_group_rate" placeholder="$ per kid" min="0" step="0.01">
        </div>
        <div>
          <label for="coach_adult_group_rate">Adult Group Lesson Coach Rate <span title="amount paid per enrolled adult to the coach.">(?)</span></label>
          <input type="number" id="coach_adult_group_rate" placeholder="$ per adult" min="0" step="0.01">
        </div>
        <div>
          <label for="coach_clinic_camp_fee">Clinic/Camp Coach Fee <span title="flat or per-participant fee paid to coaches running clinics.">(?)</span></label>
          <input type="number" id="coach_clinic_camp_fee" placeholder="$ per participant/camp" min="0" step="0.01">
        </div>
      </fieldset>
    </div>
    -->

    <div class="input-group full-width">
      <fieldset>
        <legend>Fixed Overhead Inputs (Populated from API)</legend>
        <div>
          <label for="director_salary">Head Coach/Director Salary</label>
          <input type="number" id="director_salary" placeholder="$ monthly" min="0" step="0.01" readonly>
        </div>
        <div>
          <label for="admin_expenses">Office/Admin Expenses</label>
          <input type="number" id="admin_expenses" placeholder="$ monthly" min="0" step="0.01" readonly>
        </div>
        <div>
          <label>Total Overhead <span title="sums all monthly non-coach costs (Director salary + admin)">(?)</span>:</label> 
          <span id="display_total_overhead">$0.00</span>
        </div>
      </fieldset>
    </div>
  </form>

  <div class="display-group full-width">
    <fieldset>
      <legend>Financial Summary</legend>
      <div><label>Kids Group Revenue:</label> <span id="display_kids_group_revenue">$0.00</span></div>
      <div><label>Adult Group Revenue:</label> <span id="display_adult_group_revenue">$0.00</span></div>
      <div><label>Private Lesson Revenue:</label> <span id="display_private_lesson_revenue">$0.00</span></div>
      <div><label>Clinic/Camp Revenue:</label> <span id="display_clinic_camp_revenue">$0.00</span></div>
      <div><label>Total Revenue:</label> <span id="display_total_revenue">$0.00</span></div>
      <hr>
      <div><label>Kids Group Coach Pay:</label> <span id="display_kids_group_coach_pay">$0.00</span></div>
      <div><label>Adult Group Coach Pay:</label> <span id="display_adult_group_coach_pay">$0.00</span></div>
      <div><label>Private Lesson Coach Pay:</label> <span id="display_private_lesson_coach_pay">$0.00</span></div>
      <div><label>Clinic/Camp Coach Pay:</label> <span id="display_clinic_camp_coach_pay">$0.00</span></div>
      <div><label>Total Coach Payroll:</label> <span id="display_total_coach_payroll">$0.00</span></div>
      <hr>
      <div><label>Academy Commission (Private Lessons):</label> <span id="display_academy_commission_privates">$0.00</span></div>
      <hr>
      <div><label>Gross Profit (Revenue - Coach Payroll):</label> <span id="display_gross_profit">$0.00</span></div>
      <div><label>Net Profit (Gross Profit - Total Overhead):</label> <span id="display_net_profit">$0.00</span></div>
      <div><label>Profit Margin:</label> <span id="display_profit_margin">0.00%</span></div>
    </fieldset>
  </div>

  <div class="display-group full-width">
    <fieldset>
      <legend>Dashboard</legend>
      <div class="dashboard-item"><span>Kids Group Revenue:</span> <span class="value" id="dash_kids_revenue">$0.00</span> | <span>Kids Group Coach Pay:</span> <span class="value" id="dash_kids_coach_pay">$0.00</span></div>
      <div class="dashboard-item"><span>Adult Group Revenue:</span> <span class="value" id="dash_adult_revenue">$0.00</span> | <span>Adult Group Coach Pay:</span> <span class="value" id="dash_adult_coach_pay">$0.00</span></div>
      <div class="dashboard-item"><span>Private Lesson Revenue:</span> <span class="value" id="dash_private_revenue">$0.00</span> | <span>Private Lesson Coach Pay:</span> <span class="value" id="dash_private_coach_pay">$0.00</span></div>
      <div class="dashboard-item"><span>Academy Commission (Private Lessons):</span> <span class="value" id="dash_academy_commission_privates">$0.00</span></div>
      <div class="dashboard-item"><span>Clinic/Camp Revenue:</span> <span class="value" id="dash_camp_revenue">$0.00</span> | <span>Clinic/Camp Coach Pay:</span> <span class="value" id="dash_camp_coach_pay">$0.00</span></div>
      <hr>
      <div class="dashboard-item"><span>Total Revenue:</span> <span class="value" id="dash_total_revenue">$0.00</span> | <span>Total Coach Payroll:</span> <span class="value" id="dash_total_payroll">$0.00</span></div>
      <div class="dashboard-item"><span>Gross Profit:</span> <span class="value" id="dash_gross_profit">$0.00</span> | <span>Fixed Overhead:</span> <span class="value" id="dash_fixed_overhead">$0.00</span> | <span>Net Profit:</span> <span class="value" id="dash_net_profit">$0.00</span></div>
      <div class="dashboard-item"><span>Profit Margin (%):</span> <span class="value" id="dash_profit_margin">0.00%</span></div>
    </fieldset>
  </div>
  <!-- Note: The div with id="financial-dashboard" that was previously populated by renderFinancialDashboard is removed 
       as its content is now directly part of the "Dashboard" fieldset above using specific span IDs.
       If it was used for something else, it would need to be re-evaluated.
       For this task, assuming the detailed spans in "Dashboard" fieldset replace its purpose.
  -->
  <!-- <div id="financial-dashboard" style="margin-top: 20px;"></div> -->

  <!-- New Expenses Section HTML -->
  <fieldset style="margin-top: 20px;">
    <legend>Expenses for Selected Period</legend>
    <div style="display: flex; gap: 10px; margin-bottom: 10px; align-items: flex-end;">
        <div>
            <label for="new_expense_date" style="display: block; font-weight: bold; color: #0c3c78; margin-bottom: 5px;">Expense Date:</label>
            <input type="date" id="new_expense_date" style="width: 150px; padding: 10px; border-radius: 5px; border: 1px solid #ccc; box-sizing: border-box;">
        </div>
        <div style="flex-grow: 1;">
            <label for="new_expense_description" style="display: block; font-weight: bold; color: #0c3c78; margin-bottom: 5px;">Description:</label>
            <input type="text" id="new_expense_description" placeholder="Expense description" style="width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #ccc; box-sizing: border-box;">
        </div>
        <div>
            <label for="new_expense_amount" style="display: block; font-weight: bold; color: #0c3c78; margin-bottom: 5px;">Amount:</label>
            <input type="number" id="new_expense_amount" placeholder="Amount" style="width: 100px; padding: 10px; border-radius: 5px; border: 1px solid #ccc; box-sizing: border-box;">
        </div>
        <button type="button" id="add_expense_button" style="background-color:#4CAF50; color:white; width: auto; padding: 10px 15px; margin-bottom:0px; height: 40px; box-sizing: border-box;">Add Expense</button>
    </div>
    <div id="expenses-table-container">
        <table id="expenses-table" style="width:100%; border-collapse:collapse;">
            <thead>
                <tr>
                    <th style="text-align:left; border-bottom: 1px solid #ddd; padding: 8px;">Description</th>
                    <th style="text-align:right; border-bottom: 1px solid #ddd; padding: 8px;">Amount</th>
                    <th style="text-align:center; border-bottom: 1px solid #ddd; padding: 8px;">Actions</th>
                </tr>
            </thead>
            <tbody id="expenseTableTbody">
                <!-- Expense rows will be inserted here by JavaScript -->
            </tbody>
        </table>
    </div>
  </fieldset>
  <!-- expenses-list div is effectively replaced by the fieldset above -->

</section>

<footer>
  <p>&copy; 2025 C2 Tennis Academy. All rights reserved.</p>
</footer>

<script>
  // This entire block to be added as a new script, or integrated if a single DOMContentLoaded is preferred.
  document.addEventListener('DOMContentLoaded', () => {
      // --- Mobile Menu Toggle Script --- 
      const menuToggle = document.querySelector('.mobile-menu-toggle');
      const mobileMenuClose = document.querySelector('.mobile-menu-close');
      const mainNav = document.querySelector('nav.main-navigation');

      if (menuToggle && mainNav && mobileMenuClose) {
          menuToggle.addEventListener('click', () => {
              const isMenuOpen = mainNav.classList.toggle('mobile-menu--open');
              menuToggle.setAttribute('aria-expanded', isMenuOpen);
              if (isMenuOpen) {
                  menuToggle.innerHTML = '&times;'; 
                  menuToggle.setAttribute('aria-label', 'Close navigation menu');
              } else {
                  menuToggle.innerHTML = '&#9776;'; 
                  menuToggle.setAttribute('aria-label', 'Open navigation menu');
              }
          });

          mobileMenuClose.addEventListener('click', () => {
              mainNav.classList.remove('mobile-menu--open');
              if (menuToggle) {
                 menuToggle.setAttribute('aria-expanded', 'false');
                 menuToggle.innerHTML = '&#9776;'; 
                 menuToggle.setAttribute('aria-label', 'Open navigation menu');
              }
          });
      }

      const mobileNavLinks = document.querySelectorAll('.mobile-menu-container a');
      if (mainNav && mobileNavLinks.length > 0) {
          mobileNavLinks.forEach(link => {
              link.addEventListener('click', () => {
                  if (mainNav.classList.contains('mobile-menu--open')) {
                      mainNav.classList.remove('mobile-menu--open');
                      if (menuToggle) {
                          menuToggle.setAttribute('aria-expanded', 'false');
                          menuToggle.innerHTML = '&#9776;';
                          menuToggle.setAttribute('aria-label', 'Open navigation menu');
                      }
                  }
              });
          });
      }

      // --- checkSession and logout functions for Admin Portal --- 
      async function checkSession() {
          // Ensure existing greetings are removed before adding a new one to prevent duplicates from multiple calls
          const existingGreeting = document.querySelector('.welcome-greeting');
          if (existingGreeting) existingGreeting.remove();
           
          // Original admin.html had <p>Admin Portal: Welcome Admin</p> in header.
          // New header has "Admin Portal" as h1, "C2 Tennis Academy" as p.
          // Greeting banner will add "Welcome, [firstName]" if available, or just "Welcome, Admin".

          try {
              const res = await fetch('/api/check-session', { credentials: 'include' });
              const data = await res.json(); 

              const authContainerDesktop = document.getElementById('authContainerDesktop');
              const authContainerMobile = document.getElementById('authContainerMobile');
              
              if (data && data.loggedIn === true && data.isAdmin === true) {
                  // Corrected logic for portal button text
                  const portalButtonText = data.firstName ? 'Admin (' + data.firstName + ')' : 'Admin Portal';
                  
                  const loggedInHTML = '<a href="admin.html"><button>' + portalButtonText + '</button></a><button onclick="logout()">Logout</button>';
                  const loggedInMobileHTML = loggedInHTML; // Assuming it's the same

                  if (authContainerDesktop) authContainerDesktop.innerHTML = loggedInHTML;
                  if (authContainerMobile) authContainerMobile.innerHTML = loggedInMobileHTML;

                  // Corrected logic for welcome message text
                  const welcomeMessageText = data.firstName ? 'Welcome, ' + data.firstName + '!' : 'Welcome, Admin!';
                  
                  const greeting = document.createElement('div');
                  greeting.className = 'welcome-greeting';
                  greeting.textContent = welcomeMessageText;
                  greeting.style.cssText = 'background:#0c3c78;color:white;padding:10px;text-align:center;font-weight:bold;';
                  
                  // This logic for inserting the greeting is already here.
                  // Ensure existing greetings are removed before adding a new one to prevent duplicates from multiple calls
                  const existingGreeting = document.querySelector('.welcome-greeting');
                  if (existingGreeting) existingGreeting.remove();

                  if(document.body.firstChild) { // Attempt to insert before first child of body
                      document.body.insertBefore(greeting, document.body.firstChild);
                  } else { // Fallback if body has no children
                      document.body.appendChild(greeting);
                  }
              } else {
                  // Not logged in as an Admin
                  window.location.href = 'login.html'; 
                  const loggedOutHTML = `<a href="login.html"><button>Login</button></a>`;
                  if (authContainerDesktop) authContainerDesktop.innerHTML = loggedOutHTML;
                  if (authContainerMobile) authContainerMobile.innerHTML = loggedOutHTML;
              }
          } catch (err) {
              console.error('Session check failed, redirecting to login:', err);
              window.location.href = 'login.html'; 
              const authContainerDesktop = document.getElementById('authContainerDesktop');
              const authContainerMobile = document.getElementById('authContainerMobile');
              const loggedOutHTML = `<a href="login.html"><button>Login</button></a>`;
              if (authContainerDesktop) authContainerDesktop.innerHTML = loggedOutHTML;
              if (authContainerMobile) authContainerMobile.innerHTML = loggedOutHTML;
          }
      }

      window.logout = function() { // Make logout globally accessible
          fetch('/api/logout', { method: 'POST', credentials: 'include' })
              .then(() => {
                  const existingGreeting = document.querySelector('.welcome-greeting');
                  if (existingGreeting) existingGreeting.remove();
                  document.cookie = "userFirstName=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
                  window.location.href = 'login.html'; 
              });
      }

      checkSession(); 
  });
  </script>

<script>
function updateElement(id, value, isCurrency = true, isPercentage = false) {
    const el = document.getElementById(id);
    if (!el) return;

    let formattedValue = value;
    if (typeof value === 'number') {
        if (isCurrency) {
            formattedValue = `$${value.toFixed(2)}`;
        } else if (isPercentage) {
            formattedValue = `${value.toFixed(2)}%`;
        } else {
            formattedValue = value.toFixed(2);
        }
    }

    el.textContent = formattedValue;
}

document.addEventListener('DOMContentLoaded', () => {
    const financialsForm = document.getElementById('financials-form');
    const loadingMessage = document.getElementById('loading-message');
    const errorBanner = document.getElementById('error-banner');
    
    // Period selection elements
    const selectYear = document.getElementById('select_year');
    const selectMonth = document.getElementById('select_month');
    const loadPeriodDataButton = document.getElementById('load_period_data_button');

    // Adjusted formInputs to exclude the load period button from general disabling if needed,
    // but for simplicity, it will also be disabled during loading.
    const formInputs = financialsForm ? financialsForm.querySelectorAll('input[type="number"], select, button') : [];


    function setLoadingState(isLoading) {
        if (loadingMessage) {
            loadingMessage.style.display = isLoading ? 'block' : 'none';
        }
        formInputs.forEach(input => {
            input.disabled = isLoading;
        });
    }

    function displayError(message) {
        if (errorBanner) {
            errorBanner.textContent = message;
            errorBanner.style.display = 'block';
        }
    }

    const inputFieldIds = [
        // These are commented out as the corresponding HTML fieldsets are commented out.
        // 'kids_group_fee', 'adult_group_fee', 'private_lesson_rate', 'clinic_camp_fee',
        // 'num_kids_enrolled', 'num_adults_enrolled', 'total_private_hours', 'num_clinic_participants',
        // 'coach_kids_group_rate', 'coach_adult_group_rate', 'coach_clinic_camp_fee',
        'director_salary', 'admin_expenses' // These are kept as they are made read-only and populated by API
    ];

    // getFormValues is likely no longer needed if all display values come directly from API.
    // If any calculation still relies on it, it would need to be reassessed.
    // For now, commenting out its direct usage for calculations.
    /*
    function getFormValues() {
        const values = {};
        inputFieldIds.forEach(id => {
            const element = document.getElementById(id);
            const value = parseFloat(element ? element.value : 0);
            values[id.replace(/_([a-z])/g, (g) => g[1].toUpperCase())] = isNaN(value) ? 0 : value; // Convert to camelCase keys
        });
        return values;
    }
    */

    function renderFinancialDashboard(data) {
        // Populate Financial Summary Spans directly from API data
        updateElement('display_kids_group_revenue', data.kids_group_revenue);
        updateElement('display_adult_group_revenue', data.adult_group_revenue);
        updateElement('display_private_lesson_revenue', data.private_lesson_revenue);
        updateElement('display_clinic_camp_revenue', data.clinic_camp_revenue);
        updateElement('display_total_revenue', data.totalRevenue);

        updateElement('display_kids_group_coach_pay', data.kids_group_coach_pay);
        updateElement('display_adult_group_coach_pay', data.adult_group_coach_pay);
        updateElement('display_private_lesson_coach_pay', data.total_private_coach_pay);
        updateElement('display_clinic_camp_coach_pay', data.clinic_camp_coach_pay);
        updateElement('display_total_coach_payroll', data.totalCoachPayroll);
        
        updateElement('display_academy_commission_privates', data.total_academy_commission_from_privates);

        updateElement('display_gross_profit', data.grossProfit);
        // display_total_overhead is updated when director_salary or admin_expenses inputs change,
        // or could be updated here directly: updateElement('display_total_overhead', data.totalOverhead);
        // For now, let's explicitly update it from data.totalOverhead.
        updateElement('display_total_overhead', data.totalOverhead); 
        updateElement('display_net_profit', data.netProfit);
        updateElement('display_profit_margin', data.profitMargin, false, true);

        // Populate Dashboard Spans directly from API data
        updateElement('dash_kids_revenue', data.kids_group_revenue);
        updateElement('dash_kids_coach_pay', data.kids_group_coach_pay);
        updateElement('dash_adult_revenue', data.adult_group_revenue);
        updateElement('dash_adult_coach_pay', data.adult_group_coach_pay);
        updateElement('dash_private_revenue', data.private_lesson_revenue);
        updateElement('dash_private_coach_pay', data.total_private_coach_pay);
        updateElement('dash_academy_commission_privates', data.total_academy_commission_from_privates);
        updateElement('dash_camp_revenue', data.clinic_camp_revenue);
        updateElement('dash_camp_coach_pay', data.clinic_camp_coach_pay);
        
        updateElement('dash_total_revenue', data.totalRevenue);
        updateElement('dash_total_payroll', data.totalCoachPayroll);
        updateElement('dash_gross_profit', data.grossProfit);
        updateElement('dash_fixed_overhead', data.totalOverhead);
        updateElement('dash_net_profit', data.netProfit);
        updateElement('dash_profit_margin', data.profitMargin, false, true);

        // Populate enrollment/informational data if spans exist (optional based on requirements)
        // Example: updateElement('display_num_kids', data.num_kids_enrolled, false, false); // If a span with id 'display_num_kids' exists
        // updateElement('display_num_adults', data.num_adults_enrolled, false, false);
        // updateElement('display_private_lessons_count', data.total_private_hours, false, false); // 'total_private_hours' is lesson count
        // updateElement('display_clinic_participants', data.num_clinic_participants, false, false);
    }
    
    // updateFinancialDashboard_OLD is no longer needed as renderFinancialDashboard now uses API data.
    // Remove or comment out updateFinancialDashboard_OLD and its calls.
    /*
    function updateFinancialDashboard_OLD(apiData = null) { ... }
    */

    // This is the new renderExpensesList
    function formatDollar(value) {
        const num = parseFloat(value);
        return isNaN(num) ? '$0.00' : `$${num.toFixed(2)}`;
    }

    function renderExpensesList(expenses) {
        const expenseTableTbody = document.getElementById('expenseTableTbody');
        if (!expenseTableTbody) {
            console.error('Error: expenseTableTbody not found.');
            return;
        }
        expenseTableTbody.innerHTML = ''; // Clear existing rows

        if (!expenses || expenses.length === 0) {
            const row = expenseTableTbody.insertRow();
            const cell = row.insertCell();
            cell.colSpan = 3; // Span across all columns
            cell.textContent = 'No expenses for this period.';
            cell.style.textAlign = 'center';
            return;
        }

        expenses.forEach(exp => {
            const row = expenseTableTbody.insertRow();
            row.insertCell().textContent = exp.description || '‚Äî';
            const amountCell = row.insertCell();
            amountCell.textContent = formatDollar(exp.amount);
            amountCell.style.textAlign = 'right';
            
            const actionsCell = row.insertCell();
            actionsCell.style.textAlign = 'center';
            const deleteButton = document.createElement('button');
            deleteButton.className = 'delete-expense-btn';
            deleteButton.setAttribute('data-id', exp.id);
            deleteButton.innerHTML = 'üóë'; // Trash can icon
            deleteButton.style.background = 'none';
            deleteButton.style.border = 'none';
            deleteButton.style.color = '#dc3545';
            deleteButton.style.cursor = 'pointer';
            actionsCell.appendChild(deleteButton);
        });

        // Attach event listeners after rows are created
        document.querySelectorAll('.delete-expense-btn').forEach(button => {
            button.addEventListener('click', async (event) => {
                const expenseId = event.target.closest('button').dataset.id;
                if (confirm(`Are you sure you want to delete expense ID ${expenseId}?`)) {
                    setLoadingState(true);
                    try {
                        const response = await fetch(`/api/admin/expenses/${expenseId}`, {
                            method: 'DELETE',
                            credentials: 'include'
                        });
                        if (!response.ok) {
                            const errData = await response.json().catch(() => ({ message: 'Failed to delete expense.' }));
                            alert(`Error: ${errData.message || response.statusText}`);
                        } else {
                            alert('Expense deleted successfully.');
                            if (currentPeriod) { // currentPeriod should be defined in a higher scope
                                loadExpensesForPeriod(currentPeriod); // Refresh list
                            }
                        }
                    } catch (networkError) {
                        console.error('Network error deleting expense:', networkError);
                        alert('Network error: ' + networkError.message);
                    } finally {
                        setLoadingState(false);
                    }
                }
            });
        });
    }


    function updateFinancialDashboard_OLD(apiData = null) { // Renamed old function to avoid conflict
        const values = getFormValues();

        // Calculations for other items (Kids, Adult, Clinic/Camp) remain the same
        const kidsGroupRevenue = values.kidsGroupFee * values.numKidsEnrolled;
        const adultGroupRevenue = values.adultGroupFee * values.numAdultsEnrolled;
        // const privateLessonRevenue = values.privateLessonRate * values.totalPrivateHours; // OLD
        const clinicCampRevenue = values.clinicCampFee * values.numClinicParticipants;
        
        // Use direct values from API for private lessons if available
        const privateLessonRevenue = apiData?.private_lesson_revenue ?? (values.privateLessonRate * values.totalPrivateHours);
        
        const totalRevenue = kidsGroupRevenue + adultGroupRevenue + privateLessonRevenue + clinicCampRevenue;

        const kidsGroupCoachPay = values.coachKidsGroupRate * values.numKidsEnrolled;
        const adultGroupCoachPay = values.coachAdultGroupRate * values.numAdultsEnrolled;
        // const privateLessonCoachPay = values.coachPrivateHourlyPay * values.totalPrivateHours; // OLD - coach_private_hourly_pay is removed
        const clinicCampCoachPay = values.coachClinicCampFee * values.numClinicParticipants;

        // Use direct values from API for private lesson coach pay if available
        const privateLessonCoachPay = apiData?.total_private_coach_pay ?? 0; // Default to 0 if not in apiData and input removed

        const totalCoachPayroll = kidsGroupCoachPay + adultGroupCoachPay + privateLessonCoachPay + clinicCampCoachPay;

        // Rest of the calculations (grossProfit, totalOverhead, netProfit, profitMargin) remain the same
        const grossProfit = totalRevenue - totalCoachPayroll;
        const totalOverhead = values.directorSalary + values.adminExpenses;
        const netProfit = grossProfit - totalOverhead;
        const profitMargin = totalRevenue > 0 ? (netProfit / totalRevenue) * 100 : 0;

            // Update Financial Summary Spans (private lesson ones will use the new variables)
        updateElement('display_kids_group_revenue', kidsGroupRevenue);
        updateElement('display_adult_group_revenue', adultGroupRevenue);
            updateElement('display_private_lesson_revenue', privateLessonRevenue); // Will use API data if provided
        updateElement('display_clinic_camp_revenue', clinicCampRevenue);
        updateElement('display_total_revenue', totalRevenue);
        updateElement('display_kids_group_coach_pay', kidsGroupCoachPay);
        updateElement('display_adult_group_coach_pay', adultGroupCoachPay);
            updateElement('display_private_lesson_coach_pay', privateLessonCoachPay); // Will use API data if provided
        updateElement('display_clinic_camp_coach_pay', clinicCampCoachPay);
        updateElement('display_total_coach_payroll', totalCoachPayroll);
        updateElement('display_gross_profit', grossProfit);
            updateElement('display_total_overhead', totalOverhead);
        updateElement('display_net_profit', netProfit);
        updateElement('display_profit_margin', profitMargin, false, true);

            // Update Dashboard Spans (private lesson ones will use the new variables)
        updateElement('dash_kids_revenue', kidsGroupRevenue);
        updateElement('dash_kids_coach_pay', kidsGroupCoachPay);
            // ... (similar updates for dash_adult, dash_camp)
        updateElement('dash_adult_revenue', adultGroupRevenue);
        updateElement('dash_adult_coach_pay', adultGroupCoachPay);
            updateElement('dash_private_revenue', privateLessonRevenue); // Will use API data if provided
            updateElement('dash_private_coach_pay', privateLessonCoachPay); // Will use API data if provided
        updateElement('dash_camp_revenue', clinicCampRevenue);
        updateElement('dash_camp_coach_pay', clinicCampCoachPay);
        updateElement('dash_total_revenue', totalRevenue);
        updateElement('dash_total_payroll', totalCoachPayroll);
        updateElement('dash_gross_profit', grossProfit);
        updateElement('dash_fixed_overhead', totalOverhead);
        updateElement('dash_net_profit', netProfit);
        updateElement('dash_profit_margin', profitMargin, false, true);
    }

    // The updateElement function that was previously nested here is now defined globally above.
    // Calls to updateElement from within updateFinancialDashboard_OLD will now use the global function.

    let currentPeriod = null; // To store YYYY-MM string

    async function loadExpensesForPeriod(period) {
        if (!period) {
            console.warn('loadExpensesForPeriod called without a period.');
            renderExpensesList([]); // Render empty list if no period
            return;
        }
        currentPeriod = period; // Store the currently loaded period
        setLoadingState(true);
        try {
            const response = await fetch(`/api/admin/expenses?period=${period}`, { credentials: 'include' });
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ message: 'Failed to load expenses.' }));
                displayError(`Error loading expenses: ${errorData.message || response.statusText}`);
                renderExpensesList([]); // Render empty on error
                return;
            }
            const exList = await response.json();
            renderExpensesList(exList);
        } catch (error) {
            console.error('Error fetching expenses:', error);
            displayError('Network error while fetching expenses.');
            renderExpensesList([]);
        } finally {
            setLoadingState(false);
        }
    }

    async function fetchFinancialData(selectedPeriod = null) {
        setLoadingState(true);
        if (errorBanner) errorBanner.style.display = 'none';

        let periodToLoad = selectedPeriod;
        if (!periodToLoad) {
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = String(now.getMonth() + 1).padStart(2, '0');
            periodToLoad = `${currentYear}-${currentMonth}`;
        }
        currentPeriod = periodToLoad; // Update currentPeriod global

        try {
            // Step 1: Update enrollments summary for the target period
            const summaryUpdateResponse = await fetch('/api/admin/update-enrollments-summary', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    credentials: 'include' 
                },
                body: JSON.stringify({ period: periodToLoad })
            });

            if (!summaryUpdateResponse.ok) {
                const errorData = await summaryUpdateResponse.json().catch(() => ({ message: 'Summary update failed, and error response was not valid JSON.' }));
                let errorMessage = `Failed to update financial summaries for period ${periodToLoad}.`;
                if (errorData && errorData.message) {
                    errorMessage += ` Details: ${errorData.message}`;
                } else {
                    const textError = await summaryUpdateResponse.text().catch(() => '');
                    if (textError) errorMessage += ` Raw error: ${textError}`;
                }
                displayError(errorMessage);
                setLoadingState(false);
                return; 
            }
            
            // Step 2: Fetch financial data for the target period
            let apiUrl = '/api/financials';
            if (periodToLoad) {
                apiUrl += '?period=' + periodToLoad;
            }
            
            const financialsResponse = await fetch(apiUrl, { credentials: 'include' });

            if (financialsResponse.status === 401) {
                window.location.href = 'login.html';
                return;
            }

            if (!financialsResponse.ok) {
                const errorData = await financialsResponse.json().catch(() => null);
                displayError(errorData?.message || `Error ${financialsResponse.status}: Failed to load financial data for period ${periodToLoad}.`);
                setLoadingState(false);
                return;
            }

            const data = await financialsResponse.json();

            // Populate the read-only input fields from the API response.
            // The inputFieldIds array now primarily lists these.
            inputFieldIds.forEach(id => {
                const element = document.getElementById(id);
                if (element && data[id] !== undefined) {
                    element.value = data[id];
                } else if (element) {
                    // If data for a read-only field is not in API, clear it or set to default.
                    // element.value = ''; // Or 0, or some placeholder
                }
            });
            
            // The main function to update all display spans using API data.
            renderFinancialDashboard(data); 
            
            // After financial data is fetched and dashboard rendered, load expenses for the same period
            await loadExpensesForPeriod(periodToLoad);

        } catch (error) {
            console.error('Error during financial data processing:', error);
            displayError(`A network or processing error occurred: ${error.message}. Please try again.`);
        } finally {
            setLoadingState(false);
        }
    }

    if (financialsForm) {
        const now = new Date();
        const currentYear = now.getFullYear();
        const currentMonth = now.getMonth() + 1;
        if (selectYear) selectYear.value = currentYear;
        if (selectMonth) selectMonth.value = currentMonth;
        
        const defaultPeriod = `${currentYear}-${String(currentMonth).padStart(2, '0')}`;
        fetchFinancialData(defaultPeriod);

        // Remove event listeners from input fields that were for live recalculation,
        // as calculations are now primarily from the API.
        // The remaining input fields ('director_salary', 'admin_expenses') are read-only.
        // If there was any specific live update tied to them (e.g. display_total_overhead),
        // it's now handled by renderFinancialDashboard using data.totalOverhead from API.
        /*
        inputFieldIds.forEach(id => {
            const inputElement = document.getElementById(id);
            if (inputElement) {
                inputElement.removeEventListener('input', relevantHandlerFunction); // Need to ensure handler is referenceable
            }
        });
        */
        // For simplicity, the old 'input' event listeners on the few remaining (now readonly)
        // inputFieldIds will not fire user-driven 'input' events. If they were for other event types,
        // they might need explicit removal if they cause issues.
        // The display_total_overhead span is updated by renderFinancialDashboard.

        // Event listener for the "Load Data" button
        if (loadPeriodDataButton) {
            loadPeriodDataButton.addEventListener('click', () => {
                const year = parseInt(selectYear.value);
                const month = parseInt(selectMonth.value);

                if (isNaN(year) || year < 2000 || year > 2100) {
                    displayError('Please enter a valid year (2000-2100).');
                    return;
                }
                if (isNaN(month) || month < 1 || month > 12) {
                    displayError('Please enter a valid month (1-12).');
                    return;
                }

                const monthStr = String(month).padStart(2, '0');
                const period = year + '-' + monthStr;
                fetchFinancialData(period);
            });
        }

        // Find the ‚ÄúAdd Expense‚Äù button directly, without checking for #save_expense_button
        const addExpenseButton = document.getElementById('add_expense_button');
        if (addExpenseButton) {
          addExpenseButton.addEventListener('click', async () => {
            const description = document.getElementById('new_expense_description').value;
            const amount = document.getElementById('new_expense_amount').value;
            const expenseDate = document.getElementById('new_expense_date').value;

            if (!description.trim() || !amount.trim() || !expenseDate.trim()) {
              alert('Expense Date, Description, and Amount are required.');
              return;
            }
            if (isNaN(parseFloat(amount))) {
              alert('Invalid amount format.');
              return;
            }

            // Console logs for debugging
            console.log("Expense Date:", expenseDate);
            console.log("Description:", description);
            console.log("Amount:", amount);
            console.log("Current Period:", currentPeriod);

            // New check for currentPeriod, placed after console.logs
            if (!currentPeriod) {
              alert('Please select or load a financial period before adding an expense.');
              return; // Prevent further execution
            }

            setLoadingState(true);
            try {
              const response = await fetch('/api/admin/expenses', {
                method: 'POST',
                headers: { 
                  'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify({
                  description: description,
                  amount: parseFloat(amount),
                  period: currentPeriod,
                  expense_date: expenseDate
                })
              });
              if (!response.ok) {
                const errData = await response.json().catch(() => ({ message: 'Failed to add expense.' }));
                alert(`Error: ${errData.message || response.statusText}`);
              } else {
                alert('Expense added successfully.');
                document.getElementById('new_expense_description').value = '';
                document.getElementById('new_expense_amount').value = '';
                loadExpensesForPeriod(currentPeriod); // Refresh the table
              }
            } catch (networkError) {
              console.error('Network error adding expense:', networkError);
              alert('Network error: ' + networkError.message);
            } finally {
              setLoadingState(false);
            }
          });
        }
        // Remove old save_expense_button listener if it was different
        // const oldSaveExpenseButton = document.getElementById('save_expense_button'); // This line is commented out as save_expense_button is no longer used here.
        // if (oldSaveExpenseButton) { // This block is also commented out.
            // To fully remove, you'd need to replace its clone or use AbortController if added with one.
            // For simplicity, if its functionality is replaced by add_expense_button, ensure it's not active
            // or remove the old button HTML element itself. The HTML replacement already handled this.
        // }
  }
});
</script>
</body>
</html>